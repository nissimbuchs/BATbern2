# SonarCloud Multi-Module Setup Guide

This document explains how to configure SonarCloud for the BATbern platform's multi-module architecture.

## Architecture Overview

The BATbern platform uses a **multi-module SonarCloud configuration** that analyzes each service independently:

### Java/Gradle Modules
- **shared-kernel** - Foundation library
- **api-gateway** - API routing layer
- **event-management-service** - Domain service
- **attendee-experience-service** - Domain service
- **company-management-service** - Domain service
- **partner-coordination-service** - Domain service
- **speaker-coordination-service** - Domain service

### Frontend Module
- **web-frontend** - React/TypeScript application

Each module appears **separately in SonarCloud** with its own:
- ✅ Code coverage metrics
- ✅ Quality gate status
- ✅ Code smells and bug reports
- ✅ Security vulnerability analysis

---

## Setup Instructions

### 1. SonarCloud Organization Setup

1. **Go to [SonarCloud](https://sonarcloud.io/)**
2. **Sign in** with your GitHub account
3. **Import your organization** (if not already done):
   - Click **"+"** → **"Analyze new project"**
   - Select your GitHub organization
   - Authorize SonarCloud to access your repositories

### 2. Project Configuration

1. **Import the BATbern repository**:
   - Go to **"My Projects"** → **"+"** → **"Analyze new project"**
   - Select `nissimbuchs/BATbern2` (or your repository name)
   - Click **"Set Up"**

2. **Choose Analysis Method**:
   - Select **"With GitHub Actions"**
   - SonarCloud will show you the token and configuration

3. **Copy your SONAR_TOKEN**:
   - SonarCloud will display a token like: `sqp_1234567890abcdef...`
   - **Keep this window open** - you'll need this token in the next step

### 3. GitHub Secrets Configuration

1. **Navigate to your GitHub repository settings**:
   ```
   GitHub → Settings → Secrets and variables → Actions
   ```

2. **Add the SONAR_TOKEN secret**:
   - Click **"New repository secret"**
   - Name: `SONAR_TOKEN`
   - Value: `<paste the token from SonarCloud>`
   - Click **"Add secret"**

**Note**: `GITHUB_TOKEN` is automatically provided by GitHub Actions - you don't need to configure it.

### 4. Verify Configuration

After pushing to `develop` or `main` branch, or creating a pull request:

1. **Check GitHub Actions**:
   - Go to **Actions** tab in your repository
   - Look for the **"Build Pipeline"** workflow
   - Verify the **"SonarCloud Analysis"** job runs successfully

2. **Check SonarCloud Dashboard**:
   - Go to [SonarCloud](https://sonarcloud.io/)
   - Navigate to your project
   - You should see **8 modules** listed:
     - Shared Kernel
     - API Gateway
     - Event Management Service
     - Attendee Experience Service
     - Company Management Service
     - Partner Coordination Service
     - Speaker Coordination Service
     - Web Frontend

3. **Verify Coverage Reports**:
   - Click on each module
   - Go to **"Coverage"** tab
   - You should see coverage percentages for each service

---

## Configuration Files

### `sonar-project.properties`
Located at the repository root, this file defines:
- Root project configuration
- Module list
- Per-module source paths
- Per-module coverage report paths
- Java version (21)
- TypeScript/JavaScript configuration

### `.github/workflows/build.yml`
The build pipeline includes:
- **Build jobs** - Generate JaCoCo coverage reports for Java modules
- **Frontend build** - Generate LCOV coverage for TypeScript
- **SonarCloud job** - Runs after all builds, analyzes all modules together

---

## Coverage Reports

### Java Services (JaCoCo)
- **Generated by**: Gradle task `jacocoTestReport`
- **Location**: `{module}/build/reports/jacoco/test/jacocoTestReport.xml`
- **Configured in**: Each service's `build.gradle`
- **Threshold**: 60% (CI), 80-90% (local) - see individual `build.gradle` files

### Frontend (LCOV)
- **Generated by**: Vitest with coverage
- **Location**: `web-frontend/coverage/lcov.info`
- **Configured in**: `web-frontend/vitest.config.ts`
- **Threshold**: Configured in Vitest config

---

## Troubleshooting

### "No coverage report found"

**Problem**: SonarCloud shows 0% coverage for a module

**Solution**:
1. Check that tests ran successfully in the build job
2. Verify coverage report exists at the expected path:
   ```bash
   # For Java modules
   ls -la {module}/build/reports/jacoco/test/jacocoTestReport.xml

   # For frontend
   ls -la web-frontend/coverage/lcov.info
   ```
3. Check the SonarCloud job logs for warnings about missing reports

### "Module not found"

**Problem**: A service doesn't appear in SonarCloud

**Solution**:
1. Verify the module is listed in `sonar-project.properties`:
   ```properties
   sonar.modules=shared-kernel,api-gateway,...
   ```
2. Check the module has a configuration section in `sonar-project.properties`
3. Ensure the service directory exists and has source code

### "Quality Gate Failed"

**Problem**: SonarCloud quality gate fails

**Solution**:
1. Review the specific issues in SonarCloud dashboard
2. Common issues:
   - Coverage below threshold
   - Code smells (design issues)
   - Security vulnerabilities
   - Duplicated code
3. Fix the issues and push a new commit

### "SONAR_TOKEN authentication failed"

**Problem**: GitHub Actions fails with authentication error

**Solution**:
1. Verify `SONAR_TOKEN` secret is set in GitHub repository settings
2. Regenerate token in SonarCloud:
   - Go to **Account → Security → Generate Token**
3. Update the secret in GitHub

---

## Maintenance

### Adding a New Service

When adding a new microservice:

1. **Add to `sonar-project.properties`**:
   ```properties
   # Update module list
   sonar.modules=...,new-service-name

   # Add module configuration
   new-service-name.sonar.projectName=New Service Name
   new-service-name.sonar.projectBaseDir=services/new-service-name
   new-service-name.sonar.sources=src/main
   new-service-name.sonar.tests=src/test
   new-service-name.sonar.java.source=21
   new-service-name.sonar.java.binaries=build/classes/java/main
   new-service-name.sonar.coverage.jacoco.xmlReportPaths=build/reports/jacoco/test/jacocoTestReport.xml
   ```

2. **Ensure service has JaCoCo configured** in `build.gradle`:
   ```gradle
   apply plugin: 'jacoco'

   jacoco {
       toolVersion = "0.8.10"
   }

   jacocoTestReport {
       dependsOn test
       reports {
           xml.required = true
       }
   }
   ```

3. **Add to build workflow** if not already covered by the loop in `.github/workflows/build.yml`

### Updating Coverage Thresholds

To change coverage requirements:

1. **SonarCloud Quality Gate**:
   - Go to SonarCloud → Project Settings → Quality Gate
   - Adjust coverage thresholds

2. **Gradle JaCoCo Thresholds**:
   - Edit `{service}/build.gradle`
   - Update `jacocoTestCoverageVerification` minimum values

---

## Best Practices

1. **Keep coverage high**: Aim for 80%+ coverage on all new code
2. **Review quality gate failures**: Don't ignore SonarCloud warnings
3. **Fix security vulnerabilities**: Address high-priority issues immediately
4. **Reduce code duplication**: Refactor duplicated code into shared utilities
5. **Monitor trends**: Use SonarCloud's activity timeline to track improvements

---

## Additional Resources

- [SonarCloud Documentation](https://docs.sonarcloud.io/)
- [JaCoCo Documentation](https://www.jacoco.org/jacoco/trunk/doc/)
- [Vitest Coverage](https://vitest.dev/guide/coverage.html)
- [Multi-Module Projects](https://docs.sonarcloud.io/advanced-setup/monorepo/)

---

## Support

For issues or questions:
1. Check this documentation first
2. Review SonarCloud job logs in GitHub Actions
3. Consult the [BATbern development team](https://batbern.ch)
