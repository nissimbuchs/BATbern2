# Story 1.15a.10: Notifications API Consolidation

## Status
Draft

## Story

**As a** user,
**I want** consolidated Notification APIs with preferences and delivery tracking,
**so that** I can manage how and when I receive notifications.

## Domain Context

### Primary Domain
Cross-Cutting Concern - Notification management (not a separate microservice)

### Implementation Pattern
**Notifications are a cross-cutting concern implemented via:**
- **Shared Notification Module/Library**: Used by all domain services
- **Infrastructure Services**: AWS SES (email), AWS SNS (push), EventBridge (events)
- **Storage**: Each service stores its own notification records in its database
- **API Gateway**: Provides unified notification endpoints aggregating across services

### Involved Services
- **All Domain Services** (Event, Speaker, Partner, Attendee, Company) - Trigger and store notifications
- **API Gateway** (routing, aggregation)
- **Shared Kernel** (notification utilities, query utilities from Story 1.15a)
- **AWS SES** (email delivery)
- **AWS SNS** (push notifications)
- **EventBridge** (domain events)

### Cross-Domain Dependencies
- **Depends on**: Story 1.15a (API Consolidation Foundation)
- **Used by**: All domain services for notification triggering
- **Pattern**: Each service manages its own notifications but exposes through common API pattern

## Requirements Context

### Related Functional Requirements
- **FR13**: Notification system with templates
- **FR22**: Email notification preferences
- **NFR-Reliability**: Notification delivery tracking

### Acceptance Criteria Source
API Consolidation Analysis (docs/api-consolidation-analysis.md), Phase 3 - Notifications Domain

## Architecture Context

### Architecture Patterns
[Source: docs/api-consolidation-analysis.md]
- **Before**: 11 endpoints
- **After**: 6 endpoints
- **Reduction**: 45%
- **Implementation**: Cross-cutting concern, NOT a separate microservice
- **Pattern**: Shared notification module used by all services
- **Storage**: Each service stores its own notifications
- **API Aggregation**: API Gateway aggregates notifications from all services
- **Preference Management**: Centralized user preferences
- **Delivery Tracking**: Per-service status and history

### Why Not a Separate Microservice?
Notifications are tightly coupled to domain events and don't have independent business logic. Making them a separate service would:
- Add unnecessary network hops and latency
- Create distributed transaction complexity
- Duplicate domain context across services
- Increase deployment and operational overhead

Instead, each service:
1. Uses shared notification module from Shared Kernel
2. Stores notification records in its own database
3. Triggers email/push via AWS SES/SNS
4. Exposes standard notification endpoints
5. API Gateway aggregates for unified user experience

## Wireframe Context

### Wireframe References
- User notification preferences screens
- In-app notification center

## Acceptance Criteria

1. **List Notifications**: `GET /api/v1/notifications?filter={}&status=unread|read|all&page={}`
2. **Mark as Read**: PUT `/api/v1/notifications/read` (bulk or single)
3. **Notification Preferences**: GET/PUT `/api/v1/notifications/preferences`
4. **Delivery History**: `GET /api/v1/notifications/history?timeframe={}&channel=email|sms|push`
5. **Delete Notifications**: DELETE `/api/v1/notifications/{id}` or batch delete
6. **Notification Count**: `GET /api/v1/notifications/count?status=unread`

## Consolidated Endpoints (6 Total)

```
# Notification Management
GET    /api/v1/notifications?filter={}&status={}&page={}
GET    /api/v1/notifications/count?status={}
PUT    /api/v1/notifications/read
DELETE /api/v1/notifications/{id}
DELETE /api/v1/notifications

# Preferences & History
GET    /api/v1/notifications/preferences
PUT    /api/v1/notifications/preferences

GET    /api/v1/notifications/history?timeframe={}&channel={}
```

## Performance Requirements

- Notification list: <200ms (P95)
- Mark as read: <100ms (P95)
- Preferences update: <150ms (P95)

## Definition of Done

- [ ] All 6 ACs implemented
- [ ] 11 â†’ 6 endpoints consolidation verified
- [ ] Shared notification module created in Shared Kernel
- [ ] All 5 domain services integrate notification module
- [ ] API Gateway aggregates notifications across services
- [ ] Granular preference management implemented
- [ ] Bulk operations for read/delete working
- [ ] AWS SES integration for email delivery
- [ ] AWS SNS integration for push notifications
- [ ] Delivery tracking across all channels
- [ ] Tests >90% coverage per service
- [ ] Integration tests for cross-service aggregation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 2.0 | Clarified as cross-cutting concern, not separate microservice; documented shared module pattern | Winston (Architect) |
| 2024-10-04 | 1.0 | Initial draft for notifications API consolidation (Phase 3) | Winston (Architect) |
