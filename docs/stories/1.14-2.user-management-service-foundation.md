# Story 1.14-2: User Management Service Foundation

## Status

Draft

## Story

**As a** user of any role,
**I want** my user profile, preferences, and settings managed through consolidated RESTful APIs,
**so that** I can efficiently manage my account and domain services can integrate with user data.

## Domain Context

### Primary Domain

Shared Infrastructure & Core Services - User Management (Master Data)

### Involved Services

- User Management Service (new service to be created)
- API Gateway (routing, authentication middleware)
- AWS Cognito (authentication sync, custom attributes)
- S3 (profile picture storage)
- ElastiCache Redis (user search caching, session data)
- Company Management Service (user-company relationships)
- **API Consolidation Foundation**: Story 1.15a (FilterParser, SortParser, PaginationUtils, FieldSelector, IncludeParser)
- **API Specifications**: Story 1.15a.7 (Users API Consolidation), Story 1.15a.8 (Organizers API Consolidation)

### Cross-Domain Dependencies

- **Depends on**: Story 1.2 (API Gateway), Story 1.14 (Company Management Service)
- **Integrates with**: AWS Cognito for authentication, Company Management for user-company associations
- **Used by**: Speaker, Partner, Attendee services via get-or-create endpoint
- **Publishes Events**: UserCreatedEvent, UserRoleChangedEvent, UserDeletedEvent to EventBridge

## Requirements Context

### Related Functional Requirements

- **FR1**: Role-based authentication with user profiles (Organizer, Speaker, Partner, Attendee)
- **FR27**: User profile management with preferences and settings
- **NFR-Security**: User data protection and GDPR compliance (from Story 1.11)
- **NFR-Data Quality**: User data validation and integrity
- **CR1**: Support for migrating existing user data

### Workflow Steps (if applicable)

N/A - Foundation service supporting all workflows across all domains

### Acceptance Criteria Source

- Epic 1 reorganization: User Management extracted from Story 1.14
- Story 1.15a.6 (Company & User Management API Consolidation, User Management section, ACs 11-22)
- Story 1.15a.7 (Users API Consolidation, Lines 1-288)
- Story 1.15a.8 (Organizers API Consolidation)

## Architecture Context

### Architecture Patterns

[Source: architecture/06-backend-architecture.md#service-architecture-pattern]
- **Domain-Driven Design**: User as aggregate root with proper bounded context
- **Repository Pattern**: JPA repositories with custom query methods for user search
- **Service Layer**: Business logic separation from controllers (UserService, PreferencesService, RoleService)
- **DTO Pattern**: Clear separation between domain models and API contracts

[Source: architecture/04-api-design.md#rest-api-specification]
- **RESTful API Design**: Standard CRUD operations with OpenAPI 3.1 documentation
- **Advanced Query Patterns**: FilterParser, SortParser, PaginationUtils, FieldSelector, IncludeParser from Story 1.15a
- **Resource Expansion**: `?include=company,roles,preferences` to reduce API calls
- **Search Functionality**: User autocomplete with Redis caching for performance

[Source: architecture/03-data-architecture.md#user-data-model]
- **User Entity**: UUID identifier, email, name, roles, company affiliation
- **User Preferences**: Theme, language, notification settings
- **User Settings**: Account settings, privacy controls
- **Role Management**: User roles with business rules enforcement

### Infrastructure Components

[Source: architecture/02-infrastructure-deployment.md]

**Application Infrastructure:**
- **ECS Fargate Service**: Containerized User Management Service deployment
- **Application Load Balancer**: Health checks and traffic distribution
- **Auto-scaling**: Environment-specific scaling policies (min 2, max 10 instances)

**Database:**
- **RDS PostgreSQL**: User management database with proper indexes
- **Flyway Migrations**: Schema versioning for user_profiles, user_preferences, user_settings, role_assignments tables
- **Connection Pooling**: PgBouncer or RDS Proxy for connection management

**Caching:**
- **ElastiCache Redis**: User search results caching with 10-minute TTL
- **Session Data**: User session caching for fast authentication lookups
- **Cache Invalidation**: Event-driven cache clearing on user updates

**Storage:**
- **S3 Bucket**: `batbern-{environment}-profile-pictures` with CloudFront integration
- **Presigned URLs**: Secure 15-minute upload URLs generated by backend

**Authentication:**
- **AWS Cognito**: User authentication and custom attributes sync
- **Custom Attributes**: role, companyId, preferences synced on authentication

**Event Bus:**
- **EventBridge**: Domain events for user lifecycle (UserCreatedEvent, UserRoleChangedEvent, UserDeletedEvent)
- **Event Schema Registry**: Versioned event schemas in shared-kernel

## Wireframe Context

### Wireframe References

N/A - Backend service with no direct UI components in this story. User profile, settings, and preferences UI will be implemented in frontend stories.

### UI Components

User interface components will be implemented in future stories:
- User profile display (all roles)
- User settings panel (account, privacy, notifications)
- User preferences editor (theme, language)
- Role management interface (organizer only)
- Activity history timeline (all roles)

## Acceptance Criteria

### User Profile Management (ACs 1-5)

1. **Current User**: `GET /api/v1/users/me?include=company,preferences,settings` returns authenticated user with expanded resources (<100ms P95)
2. **Update Current User**: `PUT/PATCH /api/v1/users/me` with validation (email, name, bio) and Cognito sync
3. **List Users**: `GET /api/v1/users?filter={}&role={}&company={}&page={}` (admin/organizer only) with advanced filtering
4. **Search Users**: `GET /api/v1/users/search?query={}&role={}` with autocomplete and Redis caching (<100ms P95)
5. **Get User**: `GET /api/v1/users/{id}?include=company,roles` with resource expansion (<150ms P95)

### Preferences and Settings (ACs 6-8)

6. **User Preferences**: `GET/PUT /api/v1/users/me/preferences` for theme, language, notification settings
7. **User Settings**: `GET/PUT /api/v1/users/me/settings` for account settings and privacy controls
8. **Role Management**: `GET/PUT /api/v1/users/{id}/roles` (admin/organizer only) with business rules (minimum 2 organizers)

### Advanced Features (ACs 9-12)

9. **Activity History**: `GET /api/v1/users/{id}/activity?timeframe={}` with pagination
10. **Profile Picture Upload**: `POST /api/v1/users/me/picture` with presigned S3 URLs and CloudFront serving
11. **GDPR Delete User**: `DELETE /api/v1/users/{id}` with cascade deletion across all domain services and compliance logging
12. **Get-or-Create User**: `POST /api/v1/users/get-or-create` for domain service integration with idempotency (Speaker, Partner, Attendee services)

### Advanced Query Patterns (ACs 13-14) - From Story 1.15a

13. **Advanced Query Patterns**: Support `?filter={}`, `?sort={}`, `?page={}`, `?limit={}`, `?fields={}` using Story 1.15a utilities
14. **Resource Expansion**: Support `?include=company,roles,preferences,settings,activity` to reduce API calls from 5+ to 1 (<150ms P95 with all includes)

## Test Specifications (TDD)

### Test Scenarios by Acceptance Criteria

**AC1-5 Tests: User Profile Management**
- Test 1.1: should_returnCurrentUser_when_authenticated
- Test 1.2: should_expandCompany_when_includeCompanyProvided
- Test 1.3: should_expandPreferences_when_includePreferencesProvided
- Test 1.4: should_meetPerformanceTarget_when_currentUserRequested
- Test 2.1: should_updateUserProfile_when_validDataProvided
- Test 2.2: should_validateEmail_when_emailUpdated
- Test 2.3: should_syncCognito_when_userUpdated
- Test 2.4: should_throwValidationException_when_invalidDataProvided
- Test 3.1: should_listUsers_when_adminRequests
- Test 3.2: should_filterByRole_when_roleFilterProvided
- Test 3.3: should_filterByCompany_when_companyFilterProvided
- Test 3.4: should_restrictAccess_when_nonAdminRequests
- Test 4.1: should_searchUsers_when_queryProvided
- Test 4.2: should_cacheResults_when_searchExecuted
- Test 4.3: should_returnCachedResults_when_availableInRedis
- Test 4.4: should_autocomplete_when_partialQueryProvided
- Test 5.1: should_getUserById_when_userExists
- Test 5.2: should_expandCompanyAndRoles_when_includeProvided
- Test 5.3: should_return404_when_userNotFound

**AC6-8 Tests: Preferences, Settings, and Role Management**
- Test 6.1: should_getPreferences_when_authenticated
- Test 6.2: should_updatePreferences_when_validDataProvided
- Test 6.3: should_validatePreferenceValues_when_updating
- Test 7.1: should_getSettings_when_authenticated
- Test 7.2: should_updateSettings_when_validDataProvided
- Test 7.3: should_enforcePrivacyControls_when_settingsUpdated
- Test 8.1: should_getRoles_when_adminRequests
- Test 8.2: should_updateRoles_when_validRoleProvided
- Test 8.3: should_enforceMinimumOrganizers_when_roleRemoved
- Test 8.4: should_restrictRoleManagement_when_nonAdminRequests

**AC9-10 Tests: Activity History and Profile Picture**
- Test 9.1: should_getActivityHistory_when_userExists
- Test 9.2: should_paginateActivity_when_manyEntriesExist
- Test 9.3: should_filterByTimeframe_when_timeframeProvided
- Test 10.1: should_generatePresignedURL_when_pictureUploadRequested
- Test 10.2: should_validateFileType_when_imageUploaded
- Test 10.3: should_storeS3Key_when_uploadCompleted
- Test 10.4: should_serveThroughCloudFront_when_pictureRequested

**AC11-12 Tests: GDPR and Get-or-Create**
- Test 11.1: should_deleteUser_when_gdprRequestReceived
- Test 11.2: should_cascadeDelete_when_userHasDomainData
- Test 11.3: should_logDeletion_when_userDeleted
- Test 11.4: should_preventDeletion_when_lastOrganizer
- Test 12.1: should_createUser_when_userNotExists
- Test 12.2: should_returnExistingUser_when_userExists
- Test 12.3: should_beIdempotent_when_calledMultipleTimes
- Test 12.4: should_syncCognito_when_createIfMissingTrue

**AC13-14 Tests: Advanced Query Patterns**
- Test 13.1: should_filterUsers_when_filterParameterProvided
- Test 13.2: should_sortUsers_when_sortParameterProvided
- Test 13.3: should_paginateUsers_when_pageParameterProvided
- Test 13.4: should_selectFields_when_fieldsParameterProvided
- Test 14.1: should_expandMultipleResources_when_includeProvided
- Test 14.2: should_meetPerformanceTarget_when_allResourcesExpanded

### Test File Locations

**User Management Service Tests:**
- `services/user-management/src/test/java/ch/batbern/user/domain/UserTest.java`
- `services/user-management/src/test/java/ch/batbern/user/domain/UserPreferencesTest.java`
- `services/user-management/src/test/java/ch/batbern/user/domain/UserSettingsTest.java`
- `services/user-management/src/test/java/ch/batbern/user/service/UserServiceTest.java`
- `services/user-management/src/test/java/ch/batbern/user/service/UserPreferencesServiceTest.java`
- `services/user-management/src/test/java/ch/batbern/user/service/RoleServiceTest.java`
- `services/user-management/src/test/java/ch/batbern/user/service/UserSearchServiceTest.java`
- `services/user-management/src/test/java/ch/batbern/user/service/CognitoIntegrationServiceTest.java`
- `services/user-management/src/test/integration/UserControllerIntegrationTest.java`
- `services/user-management/src/test/integration/UserSearchIntegrationTest.java`
- `services/user-management/src/test/integration/GdprComplianceIntegrationTest.java`
- `services/user-management/src/test/integration/AdvancedQueryIntegrationTest.java`
- `services/user-management/src/test/integration/repository/UserRepositoryTest.java`

**Infrastructure Tests:**
- `infrastructure/test/user-management-stack.test.ts`

**E2E Tests:**
- `e2e/workflows/user-management/user-profile-management.spec.ts`
- `e2e/workflows/user-management/role-management.spec.ts`
- `e2e/workflows/user-management/gdpr-compliance.spec.ts`

### Test Data & Mocks

**Test Data Builders:**
- UserTestDataBuilder for creating test users with different roles
- UserPreferencesTestDataBuilder for preference variations
- UserSettingsTestDataBuilder for settings variations

**Mock Services:**
- Mock AWS Cognito responses for authentication and sync
- Mock AWS S3 client for presigned URL generation
- Mock Redis client for cache operations
- Mock EventBridge client for domain event publishing
- Mock Company Management Service for user-company associations

**Test Containers:**
- PostgreSQL 15 container for integration tests
- Redis 7.2 container for cache integration tests
- LocalStack for S3, Cognito, and EventBridge mocking

## Tasks / Subtasks (TDD Workflow)

- [ ] Task 1: Write E2E Tests for User Management (RED Phase)
  - [ ] Write failing E2E test for user profile management workflow
  - [ ] Write failing E2E test for role management workflow
  - [ ] Write failing E2E test for GDPR compliance workflow
  - [ ] Verify tests fail with meaningful error messages

- [ ] Task 2: Domain Model TDD Implementation (AC: 1, 2, 3, 6, 7)
  - [ ] Write failing tests for User aggregate
  - [ ] Write failing tests for UserPreferences value object
  - [ ] Write failing tests for UserSettings value object
  - [ ] Write failing tests for Role management business rules
  - [ ] Implement User aggregate with validation (GREEN)
  - [ ] Implement UserPreferences and UserSettings (GREEN)
  - [ ] Implement role management logic (GREEN)
  - [ ] Refactor domain model for maintainability (REFACTOR)

- [ ] Task 3: Repository Layer TDD Implementation (AC: 1, 3, 4, 5)
  - [ ] Write failing tests for UserRepository
  - [ ] Write failing tests for custom query methods (findByRole, findByCompany, search)
  - [ ] Implement JPA repositories with Spring Data (GREEN)
  - [ ] Add custom query methods for search and filtering (GREEN)
  - [ ] Create database indexes for performance (GREEN)
  - [ ] Refactor repository implementations (REFACTOR)

- [ ] Task 4: Service Layer TDD Implementation (AC: 2, 6, 7, 8)
  - [ ] Write failing tests for UserService CRUD operations
  - [ ] Write failing tests for UserPreferencesService
  - [ ] Write failing tests for RoleService with business rules
  - [ ] Write failing tests for Cognito sync logic
  - [ ] Implement UserService with business logic (GREEN)
  - [ ] Implement PreferencesService and SettingsService (GREEN)
  - [ ] Implement RoleService with minimum organizer enforcement (GREEN)
  - [ ] Implement CognitoIntegrationService (GREEN)
  - [ ] Refactor service layer (REFACTOR)

- [ ] Task 5: REST API TDD Implementation (AC: 1, 2, 3, 5)
  - [ ] Write failing tests for UserController endpoints
  - [ ] Write failing tests for request/response validation
  - [ ] Write failing tests for authorization (admin/organizer only)
  - [ ] Write failing tests for error scenarios
  - [ ] Implement REST controllers with Spring Web (GREEN)
  - [ ] Add OpenAPI annotations for documentation (GREEN)
  - [ ] Implement request validation with @Valid (GREEN)
  - [ ] Refactor controllers (REFACTOR)

- [ ] Task 6: Search & Caching TDD Implementation (AC: 4, 13, 14)
  - [ ] Write failing tests for search functionality
  - [ ] Write failing tests for Redis caching
  - [ ] Write failing tests for cache invalidation
  - [ ] Write failing tests for autocomplete
  - [ ] Implement UserSearchService with autocomplete (GREEN)
  - [ ] Integrate Redis for search result caching (GREEN)
  - [ ] Implement cache invalidation on updates (GREEN)
  - [ ] Refactor search and caching logic (REFACTOR)

- [ ] Task 7: File Storage TDD Implementation (AC: 10)
  - [ ] Write failing tests for presigned URL generation
  - [ ] Write failing tests for S3 integration
  - [ ] Write failing tests for file validation
  - [ ] Implement ProfilePictureService with S3 integration (GREEN)
  - [ ] Generate presigned URLs for secure uploads (GREEN)
  - [ ] Validate file types and sizes (GREEN)
  - [ ] Refactor file storage logic (REFACTOR)

- [ ] Task 8: Domain Events TDD Implementation (AC: 2, 8, 11)
  - [ ] Write failing tests for event publishing
  - [ ] Write failing tests for EventBridge integration
  - [ ] Implement UserEventPublisher (GREEN)
  - [ ] Integrate with EventBridge (GREEN)
  - [ ] Refactor event publishing (REFACTOR)

- [ ] Task 9: GDPR Compliance TDD Implementation (AC: 11)
  - [ ] Write failing tests for data export
  - [ ] Write failing tests for cascade deletion
  - [ ] Write failing tests for audit logging
  - [ ] Implement GdprService for data export (GREEN)
  - [ ] Implement cascade deletion logic (GREEN)
  - [ ] Implement compliance audit logging (GREEN)
  - [ ] Refactor GDPR compliance logic (REFACTOR)

- [ ] Task 10: Get-or-Create Pattern TDD Implementation (AC: 12)
  - [ ] Write failing tests for get-or-create endpoint
  - [ ] Write failing tests for idempotency
  - [ ] Write failing tests for Cognito sync
  - [ ] Implement get-or-create service method (GREEN)
  - [ ] Implement idempotency checks (GREEN)
  - [ ] Integrate Cognito user creation (GREEN)
  - [ ] Refactor get-or-create logic (REFACTOR)

- [ ] Task 11: Advanced Query Patterns TDD Implementation (AC: 13, 14)
  - [ ] Write failing tests for FilterParser integration
  - [ ] Write failing tests for SortParser integration
  - [ ] Write failing tests for PaginationUtils integration
  - [ ] Write failing tests for FieldSelector integration
  - [ ] Write failing tests for IncludeParser (resource expansion)
  - [ ] Implement query parameter middleware in UserController (GREEN)
  - [ ] Implement resource expansion in UserService (GREEN)
  - [ ] Optimize performance for expanded queries with caching (GREEN)
  - [ ] Refactor query handling code (REFACTOR)

- [ ] Task 12: Activity History TDD Implementation (AC: 9)
  - [ ] Write failing tests for activity tracking
  - [ ] Write failing tests for pagination
  - [ ] Write failing tests for timeframe filtering
  - [ ] Implement ActivityHistoryService (GREEN)
  - [ ] Implement activity logging (GREEN)
  - [ ] Refactor activity history logic (REFACTOR)

- [ ] Task 13: Infrastructure Setup (All ACs)
  - [ ] Create CDK stack for User Management Service
  - [ ] Configure ECS Fargate service with auto-scaling
  - [ ] Set up RDS PostgreSQL database with Flyway
  - [ ] Configure ElastiCache Redis cluster
  - [ ] Create S3 bucket for profile pictures with CloudFront
  - [ ] Configure AWS Cognito integration
  - [ ] Configure EventBridge rules and targets
  - [ ] Set up API Gateway routes for user endpoints
  - [ ] Configure CloudWatch alarms and dashboards

- [ ] Task 14: Database Migrations (AC: 1, 2, 6, 7, 8, 9)
  - [ ] Create Flyway migration for user_profiles table
  - [ ] Create Flyway migration for user_preferences table
  - [ ] Create Flyway migration for user_settings table
  - [ ] Create Flyway migration for role_assignments table
  - [ ] Create Flyway migration for activity_history table
  - [ ] Create database indexes for performance
  - [ ] Test migrations in all environments

- [ ] Task 15: Docker Compose Integration
  - [ ] Create Dockerfile.dev for hot reload development
  - [ ] Add user-management service to docker-compose.yml
  - [ ] Configure environment variables in .env.example
  - [ ] Test local development environment

- [ ] Task 16: Documentation and Integration Testing
  - [ ] Generate OpenAPI specification
  - [ ] Write comprehensive integration tests
  - [ ] Create developer onboarding documentation
  - [ ] Test service in all environments
  - [ ] Document get-or-create pattern for domain services

## Dev Notes - Implementation Guide

### Service Setup

**User Management Service Structure:**
```
services/user-management/
├── src/main/java/ch/batbern/user/
│   ├── controller/
│   │   ├── UserController.java                   # REST API endpoints
│   │   ├── UserPreferencesController.java       # Preferences endpoints
│   │   ├── UserSettingsController.java          # Settings endpoints
│   │   ├── RoleController.java                  # Role management endpoints
│   │   └── ProfilePictureController.java        # Picture upload endpoints
│   ├── service/
│   │   ├── UserService.java                      # Core business logic
│   │   ├── UserSearchService.java               # Search and autocomplete
│   │   ├── UserPreferencesService.java          # Preferences management
│   │   ├── UserSettingsService.java             # Settings management
│   │   ├── RoleService.java                     # Role management with business rules
│   │   ├── ActivityHistoryService.java          # Activity tracking
│   │   ├── ProfilePictureService.java           # S3 picture management
│   │   ├── CognitoIntegrationService.java       # Cognito sync
│   │   ├── GdprService.java                     # GDPR compliance
│   │   └── UserEventPublisher.java              # Domain event publishing
│   ├── repository/
│   │   ├── UserRepository.java                   # JPA repository
│   │   ├── UserPreferencesRepository.java       # Preferences repository
│   │   ├── UserSettingsRepository.java          # Settings repository
│   │   └── ActivityHistoryRepository.java       # Activity repository
│   ├── domain/
│   │   ├── User.java                             # User aggregate root
│   │   ├── UserPreferences.java                 # Preferences value object
│   │   ├── UserSettings.java                    # Settings value object
│   │   ├── Role.java                            # Role enum
│   │   └── ActivityHistory.java                 # Activity entity
│   ├── dto/
│   │   ├── CreateUserRequest.java               # Creation DTO
│   │   ├── UpdateUserRequest.java               # Update DTO
│   │   ├── UserResponse.java                    # Response DTO
│   │   ├── GetOrCreateUserRequest.java          # Get-or-create DTO
│   │   └── UserSearchResponse.java              # Search result DTO
│   ├── exception/
│   │   ├── UserNotFoundException.java            # Not found exception
│   │   ├── MinimumOrganizersException.java      # Business rule exception
│   │   └── UserValidationException.java         # Validation exception
│   └── config/
│       ├── RedisConfig.java                      # Redis configuration
│       ├── S3Config.java                        # S3 configuration
│       ├── CognitoConfig.java                   # Cognito configuration
│       └── EventBridgeConfig.java               # EventBridge configuration
├── src/main/resources/
│   ├── application.yml                          # Service configuration
│   └── db/migration/
│       ├── V1__create_user_profiles_table.sql   # Users table
│       ├── V2__create_user_preferences_table.sql # Preferences table
│       ├── V3__create_user_settings_table.sql   # Settings table
│       ├── V4__create_role_assignments_table.sql # Roles table
│       └── V5__create_activity_history_table.sql # Activity table
└── src/test/java/ch/batbern/user/
    ├── unit/                                    # Unit tests
    ├── integration/                             # Integration tests
    └── TestcontainersConfiguration.java         # Testcontainers setup
```

### Technical Design Notes

**1. User Aggregate (domain/User.java)**

```java
package ch.batbern.user.domain;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.GenericGenerator;

import java.time.Instant;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

@Entity
@Table(name = "user_profiles", indexes = {
    @Index(name = "idx_user_email", columnList = "email", unique = true),
    @Index(name = "idx_user_company", columnList = "company_id")
})
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class User {

    @Id
    @GeneratedValue(generator = "UUID")
    @GenericGenerator(name = "UUID", strategy = "org.hibernate.id.UUIDGenerator")
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;

    @Column(name = "cognito_user_id", nullable = false, unique = true, length = 255)
    private String cognitoUserId;

    @Column(name = "email", nullable = false, unique = true, length = 255)
    private String email;

    @Column(name = "first_name", nullable = false, length = 100)
    private String firstName;

    @Column(name = "last_name", nullable = false, length = 100)
    private String lastName;

    @Column(name = "bio", columnDefinition = "TEXT")
    private String bio;

    @Column(name = "company_id", length = 36)
    private String companyId;

    @Column(name = "profile_picture_url", length = 2048)
    private String profilePictureUrl;

    @Column(name = "profile_picture_s3_key", length = 500)
    private String profilePictureS3Key;

    @ElementCollection(fetch = FetchType.EAGER)
    @CollectionTable(name = "role_assignments", joinColumns = @JoinColumn(name = "user_id"))
    @Column(name = "role")
    @Enumerated(EnumType.STRING)
    @Builder.Default
    private Set<Role> roles = new HashSet<>();

    @Embedded
    private UserPreferences preferences;

    @Embedded
    private UserSettings settings;

    @Column(name = "is_active", nullable = false)
    @Builder.Default
    private boolean isActive = true;

    @Column(name = "created_at", nullable = false, updatable = false)
    private Instant createdAt;

    @Column(name = "updated_at", nullable = false)
    private Instant updatedAt;

    @Column(name = "last_login_at")
    private Instant lastLoginAt;

    @PrePersist
    protected void onCreate() {
        createdAt = Instant.now();
        updatedAt = Instant.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = Instant.now();
    }

    // Business methods
    public void addRole(Role role) {
        this.roles.add(role);
        this.updatedAt = Instant.now();
    }

    public void removeRole(Role role) {
        this.roles.remove(role);
        this.updatedAt = Instant.now();
    }

    public boolean hasRole(Role role) {
        return this.roles.contains(role);
    }

    public void recordLogin() {
        this.lastLoginAt = Instant.now();
        this.updatedAt = Instant.now();
    }
}
```

**2. Role Enum (domain/Role.java)**

```java
package ch.batbern.user.domain;

public enum Role {
    ORGANIZER,
    SPEAKER,
    PARTNER,
    ATTENDEE
}
```

**3. User Service (service/UserService.java)**

```java
package ch.batbern.user.service;

import ch.batbern.user.domain.User;
import ch.batbern.user.dto.*;
import ch.batbern.user.exception.*;
import ch.batbern.user.repository.UserRepository;
import ch.batbern.shared.util.SecurityContextHelper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
@Transactional
@RequiredArgsConstructor
@Slf4j
public class UserService {

    private final UserRepository userRepository;
    private final CognitoIntegrationService cognitoService;
    private final UserEventPublisher eventPublisher;
    private final UserSearchService searchService;
    private final SecurityContextHelper securityContext;

    public UserResponse getCurrentUser() {
        log.debug("Fetching current authenticated user");
        String userId = securityContext.getCurrentUser().getUserId();
        User user = userRepository.findById(UUID.fromString(userId))
                .orElseThrow(() -> new UserNotFoundException(userId));
        return mapToResponse(user);
    }

    public UserResponse updateCurrentUser(UpdateUserRequest request) {
        log.info("Updating current user profile");
        String userId = securityContext.getCurrentUser().getUserId();
        User user = userRepository.findById(UUID.fromString(userId))
                .orElseThrow(() -> new UserNotFoundException(userId));

        // Update fields
        if (request.getFirstName() != null) {
            user.setFirstName(request.getFirstName());
        }
        if (request.getLastName() != null) {
            user.setLastName(request.getLastName());
        }
        if (request.getEmail() != null) {
            user.setEmail(request.getEmail());
        }
        if (request.getBio() != null) {
            user.setBio(request.getBio());
        }

        User updatedUser = userRepository.save(user);

        // Sync with Cognito
        cognitoService.syncUserAttributes(updatedUser);

        // Invalidate search cache
        searchService.invalidateCache();

        log.info("User updated successfully: {}", userId);
        return mapToResponse(updatedUser);
    }

    @Transactional(readOnly = true)
    public List<UserResponse> listUsers(String roleFilter, String companyFilter) {
        log.debug("Listing users with filters: role={}, company={}", roleFilter, companyFilter);
        // Implementation with filtering
        return userRepository.findAll().stream()
                .map(this::mapToResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public UserResponse getUserById(UUID id) {
        User user = userRepository.findById(id)
                .orElseThrow(() -> new UserNotFoundException(id.toString()));
        return mapToResponse(user);
    }

    public void deleteUser(UUID id) {
        log.info("Deleting user (GDPR): {}", id);
        User user = userRepository.findById(id)
                .orElseThrow(() -> new UserNotFoundException(id.toString()));

        // Check business rules (e.g., last organizer)
        // Cascade delete across domain services
        // Audit logging

        userRepository.delete(user);
        eventPublisher.publishUserDeletedEvent(user);

        log.info("User deleted successfully: {}", id);
    }

    /**
     * Get-or-create pattern for domain services
     */
    public GetOrCreateUserResponse getOrCreateUser(GetOrCreateUserRequest request) {
        log.info("Get-or-create user for email: {}", request.getEmail());

        return userRepository.findByEmail(request.getEmail())
                .map(existingUser -> {
                    log.debug("User already exists: {}", existingUser.getId());
                    return GetOrCreateUserResponse.builder()
                            .userId(existingUser.getId().toString())
                            .created(false)
                            .user(mapToResponse(existingUser))
                            .build();
                })
                .orElseGet(() -> {
                    if (request.isCreateIfMissing()) {
                        log.info("Creating new user: {}", request.getEmail());
                        User newUser = createNewUser(request);
                        UserResponse response = mapToResponse(newUser);
                        return GetOrCreateUserResponse.builder()
                                .userId(newUser.getId().toString())
                                .created(true)
                                .cognitoUserId(newUser.getCognitoUserId())
                                .user(response)
                                .build();
                    } else {
                        throw new UserNotFoundException("User not found: " + request.getEmail());
                    }
                });
    }

    private User createNewUser(GetOrCreateUserRequest request) {
        // Create user in Cognito if needed
        String cognitoUserId = cognitoService.createCognitoUser(request);

        User user = User.builder()
                .cognitoUserId(cognitoUserId)
                .email(request.getEmail())
                .firstName(request.getFirstName())
                .lastName(request.getLastName())
                .companyId(request.getCompanyId())
                .roles(Set.of(Role.ATTENDEE))
                .build();

        User savedUser = userRepository.save(user);
        eventPublisher.publishUserCreatedEvent(savedUser);

        return savedUser;
    }

    private UserResponse mapToResponse(User user) {
        return UserResponse.builder()
                .id(user.getId())
                .email(user.getEmail())
                .firstName(user.getFirstName())
                .lastName(user.getLastName())
                .bio(user.getBio())
                .companyId(user.getCompanyId())
                .roles(user.getRoles())
                .profilePictureUrl(user.getProfilePictureUrl())
                .isActive(user.isActive())
                .createdAt(user.getCreatedAt())
                .updatedAt(user.getUpdatedAt())
                .lastLoginAt(user.getLastLoginAt())
                .build();
    }
}
```

**4. Database Migrations**

`V1__create_user_profiles_table.sql`:
```sql
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY,
    cognito_user_id VARCHAR(255) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    bio TEXT,
    company_id VARCHAR(36),
    profile_picture_url VARCHAR(2048),
    profile_picture_s3_key VARCHAR(500),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    last_login_at TIMESTAMP
);

CREATE INDEX idx_user_email ON user_profiles(email);
CREATE INDEX idx_user_company ON user_profiles(company_id);
CREATE INDEX idx_cognito_user_id ON user_profiles(cognito_user_id);
```

`V4__create_role_assignments_table.sql`:
```sql
CREATE TABLE role_assignments (
    user_id UUID NOT NULL,
    role VARCHAR(50) NOT NULL,
    PRIMARY KEY (user_id, role),
    FOREIGN KEY (user_id) REFERENCES user_profiles(id) ON DELETE CASCADE
);

CREATE INDEX idx_role_assignments_role ON role_assignments(role);
```

### API Contracts

**OpenAPI Specification Excerpt:**

```yaml
paths:
  /api/v1/users/me:
    get:
      tags: [User Management]
      summary: Get current authenticated user
      security:
        - bearerAuth: []
      parameters:
        - name: include
          in: query
          schema:
            type: string
          description: Resources to include (company,roles,preferences,settings)
      responses:
        '200':
          description: User profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Unauthorized

    put:
      tags: [User Management]
      summary: Update current user profile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'

  /api/v1/users:
    get:
      tags: [User Management]
      summary: List users (admin/organizer only)
      security:
        - bearerAuth: []
      parameters:
        - name: filter
          in: query
          schema:
            type: string
          description: JSON filter syntax
        - name: role
          in: query
          schema:
            type: string
          description: Filter by role
        - name: company
          in: query
          schema:
            type: string
          description: Filter by company ID
        - name: page
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: User list retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/UserResponse'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /api/v1/users/get-or-create:
    post:
      tags: [User Management]
      summary: Get or create user (for domain services)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GetOrCreateUserRequest'
      responses:
        '200':
          description: User retrieved or created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetOrCreateUserResponse'

components:
  schemas:
    UpdateUserRequest:
      type: object
      properties:
        firstName:
          type: string
          minLength: 2
          maxLength: 100
        lastName:
          type: string
          minLength: 2
          maxLength: 100
        email:
          type: string
          format: email
        bio:
          type: string
          maxLength: 2000

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        firstName:
          type: string
        lastName:
          type: string
        bio:
          type: string
        companyId:
          type: string
        roles:
          type: array
          items:
            type: string
        profilePictureUrl:
          type: string
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        lastLoginAt:
          type: string
          format: date-time

    GetOrCreateUserRequest:
      type: object
      required:
        - email
        - firstName
        - lastName
      properties:
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        companyId:
          type: string
        createIfMissing:
          type: boolean
          default: true
        cognitoSync:
          type: boolean
          default: true

    GetOrCreateUserResponse:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        created:
          type: boolean
        cognitoUserId:
          type: string
        user:
          $ref: '#/components/schemas/UserResponse'
```

### Testing Requirements

**Unit Test Coverage: >90%**
- Domain model validation logic
- Service layer business rules (minimum organizers, role management)
- Exception handling scenarios
- Get-or-create idempotency

**Integration Test Coverage: >85%**
- REST API endpoints with authorization
- Database operations
- Redis caching behavior
- Cognito integration
- EventBridge event publishing
- GDPR compliance (cascade deletion)

**E2E Test Coverage:**
- Complete user profile management workflow
- Role management workflow with business rules
- GDPR compliance workflow (data export, deletion)

**Performance Requirements:**
- Current user (GET /users/me): <100ms (P95)
- User list with filters: <100ms (P95)
- User search: <100ms with cache (P95)
- User detail with includes: <150ms (P95)
- Get-or-create user: <200ms (P95)

## Definition of Done Checklist

### Development Complete
- [ ] All tests written BEFORE implementation (TDD followed)
- [ ] All acceptance criteria have corresponding tests
- [ ] All 14 acceptance criteria implemented
- [ ] Unit tests written and passing (>90% coverage)
- [ ] Integration tests cover new functionality (>85% coverage)
- [ ] E2E tests pass for user management workflows
- [ ] Code follows project conventions
- [ ] Domain model properly implemented with DDD patterns
- [ ] API documentation generated with OpenAPI
- [ ] Database migrations created and tested

### Infrastructure Complete ⚠️ CRITICAL
- [ ] CDK stack for User Management Service deployed
- [ ] ECS Fargate service configured with auto-scaling
- [ ] RDS PostgreSQL database provisioned
- [ ] ElastiCache Redis cluster operational
- [ ] S3 bucket created for profile pictures with CloudFront
- [ ] AWS Cognito integration configured and tested
- [ ] EventBridge rules configured for domain events
- [ ] API Gateway routes deployed and tested
- [ ] CloudWatch alarms and dashboards configured
- [ ] IAM permissions validated (principle of least privilege)

### Operational Complete
- [ ] User CRUD operations working end-to-end
- [ ] User search with autocomplete functional
- [ ] Redis caching improves search performance by >50%
- [ ] Role management with business rules enforced
- [ ] Cognito sync working for all user operations
- [ ] Domain events published to EventBridge
- [ ] S3 profile picture upload with presigned URLs working
- [ ] GDPR compliance (data export, cascade deletion) functional
- [ ] Get-or-create pattern working for domain services
- [ ] Advanced query patterns operational (filter, sort, include)
- [ ] Integration tests verify all workflows

### Review Ready
- [ ] PR created with detailed description
- [ ] Code review completed by team
- [ ] Infrastructure review completed
- [ ] Security review passed
- [ ] Documentation updated (README, API docs)
- [ ] CLAUDE.md updated if needed
- [ ] Deployment instructions documented
- [ ] Get-or-create pattern documented for domain teams

### Docker Compose Integration
- [ ] Dockerfile.dev created for hot reload
- [ ] Service added to docker-compose.yml
- [ ] Environment variables documented in .env.example
- [ ] Local development environment tested

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 1.0 | Initial story creation for User Management Service Foundation with 14 acceptance criteria, get-or-create pattern, GDPR compliance, and advanced query patterns | Claude (Dev Agent) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent during implementation_

### Implementation Approach
_To be documented by dev agent with actual approach taken_

### Debug Log References
_To be populated with debug log references during development_

### Completion Notes
_To be filled with issues encountered and resolutions_

### Files Changed
_To be populated with list of created, modified, and deleted files_

### Deployment Notes
_Special deployment considerations for User Management Service setup_

## QA Results
_To be populated by QA Agent after implementation review_
