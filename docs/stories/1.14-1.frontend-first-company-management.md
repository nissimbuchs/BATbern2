# Story 1.14-1: Frontend-First - Company Management

## Status

**Draft**

## Story

**As a** Partner or Attendee,
**I want** to browse and manage companies through an intuitive React interface with search and company profile views,
**so that** I can discover organizations, view their information, and associate my profile with the correct company.

**Frontend-First Focus:** This story defines the API contract inline and implements the complete UI/UX for company management with MSW mocks. Backend implementation follows in Stories 1.14 and 1.14-2.

**Backend Implementation Note:**
Backend implementation is split across:
- **Story 1.14**: Company Management Service with consolidated company APIs (Story 1.15a.6 company endpoints)
- **Story 1.14-2**: User Management Service with consolidated user APIs (Story 1.15a.7 + 1.15a.8 user endpoints)

This frontend story uses a simplified API contract with MSW mocks. Backend stories implement full consolidated APIs from API Consolidation stories (1.15a.6, 1.15a.7, 1.15a.8) with advanced query patterns (`?filter=`, `?include=`, `?fields=`).

## Two-Story Approach Context

This story is Part 1 of a 2-story approach:
- **This story (1.14-1):** API contract + Frontend with mocks
- **Next story (1.14-2):** Backend implementation + Integration

**When to use this approach:**
- Simple CRUD features (3-6 days total)
- Small team (1-2 developers)
- Low complexity
- Tight timeline

**Benefits:**
- Simpler than 4-story split
- Still enables some parallelization
- Frontend-first approach
- Faster than monolithic story

## Domain Context

### Primary Domain

**Company Management Domain**

The Company Management Service is a dedicated bounded context responsible for centralized company entity management across all domains (Event Management, Speaker Coordination, Partner Analytics, Attendee Experience).

### User Role Context

**Primary User Roles:**
- **Partner** (primary): View/manage company profile, logo, partnership status
- **Organizer** (secondary): Create companies, manage partner companies, verify UIDs
- **Speaker** (tertiary): Associate with company during profile creation
- **Attendee** (tertiary): View company information when browsing events

## API Contract Definition (Inline)

### API Endpoints

```
GET /api/v1/companies
  - Query params:
    - search: string (company name search)
    - limit: number (default: 25, max: 100)
    - offset: number (default: 0)
    - partnerOnly: boolean (filter partner companies)
  - Response: { companies: Company[], pagination: Pagination }
  - Auth: Required (all roles)
  - Description: List and search companies with pagination

POST /api/v1/companies
  - Request: { name, address, contactEmail, logo?, uid? }
  - Response: Company
  - Auth: Required (organizer, speaker, partner)
  - Description: Create new company

GET /api/v1/companies/{id}
  - Path params: id (company UUID)
  - Response: Company with full details
  - Auth: Required (all roles)
  - Description: Get single company by ID

PUT /api/v1/companies/{id}
  - Path params: id (company UUID)
  - Request: { name?, address?, contactEmail?, logo?, uid?, partnerStatus? }
  - Response: Company
  - Auth: Required (organizer or company admin)
  - Description: Update company information

DELETE /api/v1/companies/{id}
  - Path params: id (company UUID)
  - Response: 204 No Content
  - Auth: Required (organizer only)
  - Description: Delete company (soft delete with validation)

GET /api/v1/companies/suggest
  - Query params: query (partial company name)
  - Response: { suggestions: CompanySuggestion[] }
  - Auth: Required (all roles)
  - Description: Autocomplete suggestions for company name input

POST /api/v1/companies/{id}/logo
  - Path params: id (company UUID)
  - Request: multipart/form-data with file
  - Response: { logoUrl: string }
  - Auth: Required (organizer or company admin)
  - Description: Upload company logo to S3
```

### Request/Response Schemas

```typescript
// Request DTOs
interface CreateCompanyRequest {
  name: string;              // min: 2, max: 255
  address: string;           // min: 5, max: 500
  contactEmail: string;      // email format
  uid?: string;              // Swiss UID (CHE-123.456.789)
  partnerStatus?: boolean;   // only organizers can set
}

interface UpdateCompanyRequest {
  name?: string;             // min: 2, max: 255
  address?: string;          // min: 5, max: 500
  contactEmail?: string;     // email format
  uid?: string;              // Swiss UID
  partnerStatus?: boolean;   // only organizers can set
}

// Response DTOs
interface Company {
  id: string;                // UUID
  name: string;
  address: string;
  contactEmail: string;
  uid?: string;              // Swiss UID (optional)
  partnerStatus: boolean;
  logoUrl?: string;          // S3 CDN URL
  createdAt: string;         // ISO 8601
  updatedAt: string;         // ISO 8601
  createdBy?: string;        // User ID
}

interface CompanyList {
  companies: Company[];
  pagination: {
    total: number;           // Total companies matching query
    limit: number;           // Items per page
    offset: number;          // Current offset
    hasMore: boolean;        // True if more pages available
  };
}

interface CompanySuggestion {
  id: string;
  name: string;
  partnerStatus: boolean;
  matchScore: number;        // 0-100 relevance score
}

interface CompanySuggestionList {
  suggestions: CompanySuggestion[];
}

// Error Response
interface ErrorResponse {
  error: {
    code: string;            // Error code (e.g., "COMPANY_EXISTS")
    message: string;         // User-friendly message
    details?: Array<{
      field: string;         // Field name
      issue: string;         // Validation issue
    }>;
    timestamp: string;       // ISO 8601
    requestId: string;       // Correlation ID
  };
}
```

### Validation Rules

**Field Validations:**
- `name`: required, min 2 chars, max 255 chars, trimmed
- `address`: required, min 5 chars, max 500 chars
- `contactEmail`: required, valid email format (RFC 5322)
- `uid`: optional, Swiss UID format `CHE-XXX.XXX.XXX` (regex validation)
- `logoUrl`: optional, valid HTTPS URL, max 2048 chars

**Business Rules:**
- Company name must be unique (case-insensitive)
- Cannot delete company with active event associations
- Cannot delete company with active employee relationships
- Only organizers can set/modify `partnerStatus`
- Only organizers can delete companies
- Company admins can update their own company (not delete)
- Swiss UID must be unique if provided

**Error Codes:**
- `VALIDATION_ERROR`: 400 - Invalid input (field validation failed)
- `COMPANY_EXISTS`: 409 - Company name already exists
- `COMPANY_HAS_EVENTS`: 409 - Cannot delete company with active events
- `COMPANY_HAS_EMPLOYEES`: 409 - Cannot delete company with employees
- `INVALID_UID_FORMAT`: 400 - Swiss UID format invalid
- `UID_ALREADY_EXISTS`: 409 - Swiss UID already registered
- `UNAUTHORIZED`: 401 - Not authenticated
- `FORBIDDEN`: 403 - Insufficient permissions
- `NOT_FOUND`: 404 - Company not found
- `RATE_LIMIT_EXCEEDED`: 429 - Too many requests

## Wireframe Context

### Wireframe References

**UI Components:**
- **Company List View**: Material-UI DataGrid with search bar, pagination
- **Company Detail/Profile View**: Card-based layout with logo, info sections
- **Company Create/Edit Form**: Modal dialog with form fields
- **Company Search/Autocomplete**: Autocomplete dropdown

**Design System:**
- **Material-UI (MUI) 5.14+**: Primary component library
- **Swiss Design Standards**: Clean, minimal, functional aesthetic
- **Responsive Breakpoints**: Mobile (0-600px), Tablet (600-960px), Desktop (960px+)

### UI Behavior Specifications

**Form Validation Feedback:**
- Inline validation on blur (not on every keystroke)
- Red text below field with specific error message
- Green checkmark icon for valid fields
- Submit button disabled until all required fields valid

**Loading States:**
- List loading: Skeleton rows (5 rows)
- Detail loading: Skeleton card
- Form submission: Button spinner, form fields disabled
- Logo upload: Progress indicator (0-100%)

**Error Handling Display:**
- API errors: Snackbar notification (top-right, 3s auto-hide)
- Network errors: Persistent alert banner until retry
- Validation errors: Inline field errors + summary at form top
- 404 Not Found: Empty state with "Company not found"

**Empty States:**
- No companies: Illustration + "No companies found" + "Create Company" button
- No search results: "No results for '{query}'" + "Clear search" link
- No logo: Placeholder icon (building icon)

**Success Confirmations:**
- Create/Update/Delete: Green snackbar with success message (3s auto-hide)

**Delete Confirmations:**
- Delete dialog: "Are you sure you want to delete {company name}?"
- Delete button is red, requires explicit confirmation

## Component Specifications

### Component List

**New Components:**

1. **CompanyList** - Display paginated company list with search
2. **CompanyCard** - Individual company display card
3. **CompanyForm** - Create/edit company form
4. **CompanyDeleteDialog** - Delete confirmation modal
5. **CompanySearch** - Search and filter interface
6. **CompanyAutocomplete** - Autocomplete dropdown (reusable)
7. **CompanyLogoUpload** - Logo upload component
8. **CompanyDetailView** - Full company detail page

### State Management

**React Query Hooks:**

```typescript
// useCompanies.ts - List companies
export const useCompanies = (filters: CompanyFilters) => {
  return useQuery<CompanyList>({
    queryKey: ['companies', filters],
    queryFn: () => companyApi.getCompanies(filters),
    staleTime: 5 * 60 * 1000  // 5 minutes
  });
};

// useCompany.ts - Single company
export const useCompany = (companyId: string) => {
  return useQuery<Company>({
    queryKey: ['companies', companyId],
    queryFn: () => companyApi.getCompany(companyId),
    staleTime: 10 * 60 * 1000  // 10 minutes
  });
};

// useCreateCompany.ts
export const useCreateCompany = () => {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (data: CreateCompanyRequest) =>
      companyApi.createCompany(data),
    onSuccess: (newCompany) => {
      queryClient.invalidateQueries({ queryKey: ['companies'] });
      queryClient.setQueryData(['companies', newCompany.id], newCompany);
    }
  });
};

// useUpdateCompany.ts, useDeleteCompany.ts, useCompanySuggestions.ts follow similar patterns
```

**Zustand Store (Client State):**

```typescript
interface CompanyStore {
  selectedCompany: Company | null;
  setSelectedCompany: (company: Company | null) => void;
  searchQuery: string;
  setSearchQuery: (query: string) => void;
  filters: CompanyFilters;
  setFilters: (filters: CompanyFilters) => void;
}
```

## MSW Mock Configuration

### Mock Handlers

See `src/mocks/handlers/companyHandlers.ts` for complete implementation including:
- List companies with search/pagination
- Create company with duplicate name validation
- Update company with conflict detection
- Delete company with association validation
- Autocomplete suggestions with match scoring
- Logo upload simulation

### Mock Data

```typescript
// src/mocks/data/companies.ts
export const mockCompanies: Company[] = [
  {
    id: '550e8400-e29b-41d4-a716-446655440001',
    name: 'Acme Corporation AG',
    address: 'Bahnhofstrasse 123, 3011 Bern, Switzerland',
    contactEmail: 'contact@acme.ch',
    uid: 'CHE-123.456.789',
    partnerStatus: true,
    logoUrl: 'https://via.placeholder.com/200x200?text=Acme',
    createdAt: '2024-01-15T10:00:00Z',
    updatedAt: '2024-01-15T10:00:00Z'
  },
  // ... 4 more mock companies
];
```

## Acceptance Criteria

1. Company List View renders successfully with pagination
2. Search and filter functions correctly (min 2 chars, <500ms response)
3. Company creation works with validation and duplicate detection
4. Company detail view displays complete information
5. Company update functions correctly with validation
6. Company deletion works with confirmation dialog
7. Company autocomplete works in forms (min 2 chars, <300ms)
8. Logo upload functions correctly (PNG/JPG, max 2MB, progress indicator)
9. Loading states display correctly (skeletons, spinners)
10. Error states handle gracefully (snackbars, inline errors, retry options)
11. Empty states guide user actions
12. Mobile responsive design works (≤600px breakpoint)
13. Accessibility requirements met (WCAG 2.1 AA, keyboard nav, ARIA labels)
14. Role-based permissions enforced in UI
15. MSW mocks work correctly in development

## Test Specifications (TDD)

### Component Test Scenarios

**CompanyList Component (5 tests):**
- Test 1.1: should_renderCompanyList_when_dataProvided
- Test 1.2: should_displayLoading_when_fetching
- Test 1.3: should_displayError_when_fetchFails
- Test 1.4: should_filterCompanies_when_searchEntered
- Test 1.5: should_paginateResults_when_manyCompanies

**CompanyForm Component (5 tests):**
- Test 2.1: should_validateName_when_submitted
- Test 2.2: should_validateEmail_when_submitted
- Test 2.3: should_showError_when_duplicateName
- Test 2.4: should_callOnSubmit_when_validDataEntered
- Test 2.5: should_validateUidFormat_when_uidProvided

**CompanyCard, CompanyDeleteDialog, CompanyAutocomplete (11 more tests)**

### Integration Test Scenarios (with MSW)

- Test 6.1: should_createCompany_when_formSubmitted
- Test 6.2: should_updateCompany_when_editSaved
- Test 6.3: should_deleteCompany_when_confirmed
- Test 6.4: should_searchCompanies_when_queryEntered
- Test 6.5: should_uploadLogo_when_fileSelected
- Test 6.6: should_handleDuplicateName_when_creating
- Test 6.7: should_handleNetworkError_when_apiDown

## Tasks / Subtasks (TDD Workflow)

- [ ] **Task 1: API Contract Definition (Inline)** - ✅ Completed in this document
- [ ] **Task 2: MSW Mock Setup (RED Phase)** - Create handlers and mock data
- [ ] **Task 3: API Client Service Layer** - Implement companyApi.ts
- [ ] **Task 4: React Query Hooks** - Create 6 hooks for queries/mutations
- [ ] **Task 5: Write Component Tests (RED Phase)** - 21 failing tests
- [ ] **Task 6: Implement Components (GREEN Phase)** - 8 components
- [ ] **Task 7: Write Integration Tests (RED Phase)** - 7 failing tests
- [ ] **Task 8: Implement Integration Features (GREEN Phase)** - Wire components
- [ ] **Task 9: Refactor (REFACTOR Phase)** - Extract utils, optimize
- [ ] **Task 10: Accessibility & Responsive Design** - A11y audit, mobile testing
- [ ] **Task 11: Documentation & Handoff** - Storybook, backend handoff notes

## Dev Notes - Implementation Guide

### API Contract for Backend Team

**Deliverables to Backend (Story 1.14-2):**
- TypeScript interfaces (convert to Java DTOs)
- Endpoint specifications (7 endpoints)
- Validation rules (field + business rules)
- Error codes with HTTP status mappings
- Example requests/responses

**Backend Tasks:**
1. Implement CompanyManagementService (Java 21 + Spring Boot 3.2)
2. Create PostgreSQL schema with indexes/constraints
3. Implement 7 REST endpoints per contract
4. Add Swiss UID validation
5. Implement S3 logo upload
6. Add role-based authorization
7. Publish domain events
8. Replace MSW mocks (`REACT_APP_USE_MOCKS=false`)
9. Run integration tests against real backend
10. Deploy to dev environment

### MSW Setup Guide

```typescript
// src/mocks/browser.ts
import { setupWorker } from 'msw/browser';
import { companyHandlers } from './handlers/companyHandlers';

export const worker = setupWorker(...companyHandlers);

if (process.env.NODE_ENV === 'development' &&
    process.env.REACT_APP_USE_MOCKS === 'true') {
  worker.start({ onUnhandledRequest: 'warn' });
}
```

**Environment Variables:**
```bash
# .env.development (with mocks)
REACT_APP_USE_MOCKS=true

# .env.production (no mocks)
REACT_APP_USE_MOCKS=false
```

### Testing Patterns

Use `server.use()` to override MSW handlers for specific test scenarios. Test with `@testing-library/react`, `@testing-library/user-event`, and React Query test utilities.

## Definition of Done Checklist

### API Contract Complete
- [ ] All 7 endpoints defined with signatures
- [ ] Request/response schemas documented
- [ ] Validation rules documented
- [ ] Error codes defined
- [ ] API contract ready for backend team (Story 1.14-2)

### Frontend Complete
- [ ] All 8 components implemented
- [ ] All 26 component tests passing (>90% coverage)
- [ ] All 7 integration tests passing
- [ ] MSW mocks working correctly
- [ ] Form validation working
- [ ] Loading states implemented
- [ ] Error states implemented
- [ ] Empty states implemented
- [ ] Mobile responsive design working
- [ ] Accessibility score >90
- [ ] Works completely in isolation with mocks

### Documentation Complete
- [ ] Storybook stories created
- [ ] Component usage documented
- [ ] API contract documented for backend
- [ ] Handoff notes written for Story 1.14-2

## Notes for Story 1.14-2 (Backend)

**API Contract Location:**
- This story document (Section: API Contract Definition)
- TypeScript interfaces to convert to Java DTOs
- MSW handlers show expected behavior

**Integration Points:**
- MSW handlers: `src/mocks/handlers/companyHandlers.ts`
- API client: `src/services/companyApi.ts`
- React Query hooks: `src/hooks/useCompanies.ts`, etc.

**Testing Strategy:**
- Frontend integration tests (Tests 6.1-6.7) become E2E tests against real backend
- Backend implements contract tests to verify API matches frontend expectations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-03 | 1.0 | Initial story draft - Frontend-First approach | Bob (Scrum Master) |

## Dev Agent Record

_(This section will be populated during frontend development by the dev agent)_

### Agent Model Used

_(To be filled during implementation)_

### Implementation Approach

_(To be filled during implementation)_

### Files Created/Modified

_(To be filled during implementation)_

### API Contract Export

**Location of exported API contract for backend:**
- TypeScript interfaces: `src/types/company.types.ts`
- Endpoint documentation: This story file
- MSW handlers: `src/mocks/handlers/companyHandlers.ts`
