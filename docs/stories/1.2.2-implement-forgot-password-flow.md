# Story 1.2.2: Implement Forgot Password Flow

## Status
Accepted

## Story

**As a** user who has forgotten their password,
**I want** to request a password reset link via email in my preferred language,
**so that** I can securely regain access to my account without administrator intervention.

**Context:** This story implements the Forgot Password flow specified in wireframe story-1.2-forgot-password.md. This functionality was completely missing from the original Story 1.2 implementation.

**Dependencies:**
- **BLOCKS: Story 1.2.1 (i18n Foundation)** - Requires react-i18next configuration and translation files

## Domain Context

### Primary Domain
- **Shared/Infrastructure** (Authentication & Password Recovery)

### Involved Services
- **web-frontend** (React Forgot Password components)
- **API Gateway** (password reset request routing)
- **AWS Cognito** (password reset token generation)
- **AWS SES** (bilingual email delivery)

### Cross-Domain Dependencies
- AWS Cognito User Pools (password reset API)
- AWS SES email templates (German/English)

## Requirements Context

### Related Functional Requirements
- **FR1**: Role-based authentication (password recovery for all roles)
- **NFR3**: Integration with AWS SES for email delivery
- **NFR4**: Multi-language support (German/English emails and UI from day 1)

### Related Wireframes
- **Primary**: `docs/wireframes/story-1.2-forgot-password.md`
  - Email input screen (request view)
  - Confirmation screen (success view)
  - Bilingual AWS SES email templates
  - Resend functionality with cooldown
  - Security: Email enumeration prevention

## Architecture Context

### Architecture Patterns
- **Frontend Architecture** (`docs/architecture/05-frontend-architecture.md`):
  - React 18.2+ with TypeScript
  - Material-UI components
  - React Hook Form for form state
  - React Query for API mutations
  - i18next for internationalization (from Story 1.2.1)

### Infrastructure Components
- **AWS Cognito**: `forgotPassword` and `confirmForgotPassword` APIs
- **AWS SES**: Bilingual email templates for password reset
- **Email Templates**: Separate templates for de-CH and en-US
- **Reset Link Format**: `https://app.batbern.ch/auth/reset-password?code={code}&email={email}&lang={lang}`
- **Token Expiration**: 1 hour (Cognito default)

## Acceptance Criteria

### Forgot Password Request Screen
1. **Email Input Field**: Email field with validation (required, valid format, max 255 chars)
2. **Send Reset Link Button**: Primary action that triggers password reset flow
3. **Form Validation**: Client-side validation for email format before submission
4. **Loading State**: Button shows spinner and "Sending..." text during API request
5. **Back to Login Navigation**: Link to return to login screen

### Confirmation Screen (After Successful Request)
6. **Success Message**: Display confirmation with masked email address (u***@example.com)
7. **Resend Functionality**: Allow user to resend reset link if email not received
8. **Resend Cooldown**: 60-second cooldown between resend attempts
9. **Back to Login Link**: Navigation to return to login screen
10. **Help Text**: Instructions to check spam folder

### AWS Cognito Integration
11. **Forgot Password API**: Call Cognito `forgotPassword` method with email
12. **Email Enumeration Prevention**: Always show success message, never reveal if email exists in system
13. **Rate Limiting**: Maximum 3 reset requests per email per hour (enforced by Cognito)
14. **Security Logging**: Log all password reset attempts with IP address

### Bilingual Email Templates (AWS SES)
15. **German Email Template**: Password reset email in German (de-CH) with reset link
16. **English Email Template**: Password reset email in English (en-US) with reset link
17. **Language Detection**: Send email in user's preferred language (from Cognito `custom:language` or browser locale)
18. **Email Content**: Subject, body, reset link with 1-hour expiration notice

### Error Handling
19. **Invalid Email Error**: Display localized error for invalid email format
20. **Rate Limit Error**: Display error message and countdown timer when rate limit exceeded
21. **Network Error**: Display error with retry option for connection failures
22. **Generic Error**: Fallback error message for unexpected failures

## Test Specifications (TDD)

### Forgot Password Form Tests
**Test Group 1: Form Rendering & Validation**
- Test 1.1: should_renderForgotPasswordForm_when_pageLoads
- Test 1.2: should_displayGermanText_when_languageIsGerman
- Test 1.3: should_displayEnglishText_when_languageIsEnglish
- Test 1.4: should_validateEmail_when_invalidFormat
- Test 1.5: should_enableSubmitButton_when_emailValid
- Test 1.6: should_disableSubmitButton_when_emailEmpty

### Password Reset Flow Tests
**Test Group 2: Password Reset Request**
- Test 2.1: should_callCognitoAPI_when_submitClicked
- Test 2.2: should_showLoadingState_when_requestInProgress
- Test 2.3: should_transitionToConfirmation_when_requestSuccessful
- Test 2.4: should_displayEmailAddress_when_confirmationShown
- Test 2.5: should_preventEnumeration_when_emailNotFound (same success message)

### Resend Functionality Tests
**Test Group 3: Resend Reset Link**
- Test 3.1: should_enableResendButton_when_confirmationDisplayed
- Test 3.2: should_disableResendButton_when_cooldownActive
- Test 3.3: should_showCountdown_when_resendCooldownActive
- Test 3.4: should_callForgotPassword_when_resendClicked
- Test 3.5: should_showToastNotification_when_resendSuccessful

### Error Handling Tests
**Test Group 4: Error Scenarios**
- Test 4.1: should_displayError_when_emailInvalid
- Test 4.2: should_displayRateLimitError_when_429Response
- Test 4.3: should_displayNetworkError_when_requestFails
- Test 4.4: should_allowRetry_when_errorOccurs
- Test 4.5: should_logAttempt_when_resetRequested

### AWS SES Email Tests (Backend)
**Test Group 5: Email Template Integration**
- Test 5.1: should_sendGermanEmail_when_userLanguageIsGerman
- Test 5.2: should_sendEnglishEmail_when_userLanguageIsEnglish
- Test 5.3: should_includeResetLink_when_emailSent
- Test 5.4: should_includeExpirationNotice_when_emailSent (1 hour)
- Test 5.5: should_maskEmailAddress_when_confirmationDisplayed

### Test File Locations
**Frontend Tests:**
- `web-frontend/src/components/auth/ForgotPasswordForm/ForgotPasswordForm.test.tsx`
- `web-frontend/src/components/auth/ForgotPasswordConfirmation/ForgotPasswordConfirmation.test.tsx`
- `web-frontend/src/hooks/useForgotPassword/useForgotPassword.test.ts`

**Backend Tests:**
- `api-gateway/src/test/integration/auth/ForgotPasswordTest.java`
- `api-gateway/src/test/unit/email/PasswordResetEmailServiceTest.java`

**E2E Tests:**
- `e2e/auth/forgot-password.spec.ts`

## Tasks / Subtasks (TDD Workflow)

### Task 1: AWS SES Email Template Setup (Infrastructure)
- [ ] Create German password reset email template in AWS SES
- [ ] Create English password reset email template in AWS SES
- [ ] Configure reset link format with code, email, and language parameters
- [ ] Test email templates in AWS SES console
- [ ] Document template IDs and configuration

### Task 2: Backend API Endpoint (RED Phase)
- [ ] Write failing integration test for `/api/v1/auth/forgot-password` endpoint
- [ ] Write failing test for Cognito `forgotPassword` integration
- [ ] Write failing test for bilingual email template selection
- [ ] Write failing test for email enumeration prevention (same response for all emails)
- [ ] Write failing test for rate limiting (3 requests per hour)

### Task 3: Backend Implementation (GREEN Phase)
- [ ] Create ForgotPasswordRequest DTO with email validation
- [ ] Implement POST /api/v1/auth/forgot-password endpoint
- [ ] Integrate with AWS Cognito SDK `forgotPassword` method
- [ ] Implement language detection logic (Cognito attribute or header)
- [ ] Implement bilingual email template selection
- [ ] Add rate limiting with Redis cache
- [ ] Verify all backend tests pass

### Task 4: Frontend Form Component (RED Phase)
- [ ] Write failing tests for ForgotPasswordForm component rendering
- [ ] Write failing tests for email validation (required, format, max length)
- [ ] Write failing tests for form submission with API call
- [ ] Write failing tests for loading state during request
- [ ] Write failing tests for view transition to confirmation

### Task 5: Frontend Confirmation Component (RED Phase)
- [ ] Write failing tests for ForgotPasswordConfirmation component
- [ ] Write failing tests for email address display (masked)
- [ ] Write failing tests for resend functionality with cooldown
- [ ] Write failing tests for navigation back to login
- [ ] Write failing tests for localized messaging

### Task 6: Implement Frontend Components (GREEN Phase)
- [ ] Create ForgotPasswordForm component with Material-UI
- [ ] Implement email validation with React Hook Form
- [ ] Add useForgotPassword hook with React Query mutation
- [ ] Create ForgotPasswordConfirmation component
- [ ] Implement resend functionality with 60-second cooldown
- [ ] Add all i18n translation keys to auth.json (forgot namespace)
- [ ] Verify all frontend tests pass

### Task 7: Error Handling & Edge Cases (GREEN Phase)
- [ ] Implement invalid email error display
- [ ] Implement rate limit error with countdown timer
- [ ] Implement network error with retry option
- [ ] Add security logging for all reset attempts
- [ ] Handle Cognito-specific errors

### Task 8: E2E Testing & Integration (REFACTOR Phase)
- [ ] Create E2E test for complete forgot password flow
- [ ] Test email delivery in development environment (with MailHog or similar)
- [ ] Verify bilingual email templates render correctly
- [ ] Test resend functionality and cooldown
- [ ] Verify email enumeration prevention
- [ ] Run accessibility audit

### Task 9: Documentation
- [ ] Document forgot password API endpoint in OpenAPI spec
- [ ] Update README with forgot password flow instructions
- [ ] Document AWS SES template configuration
- [ ] Add troubleshooting guide for email delivery issues
- [ ] Document rate limiting rules

## Dev Notes - Implementation Guide

### AWS SES Email Template Configuration

**German Template (PasswordResetDE):**
```json
{
  "TemplateName": "PasswordResetDE",
  "SubjectPart": "BATbern Passwort zurücksetzen",
  "HtmlPart": "
    <h2>Passwort zurücksetzen</h2>
    <p>Hallo,</p>
    <p>Sie haben eine Zurücksetzung Ihres Passworts für Ihr BATbern-Konto angefordert.</p>
    <p>Klicken Sie auf den untenstehenden Link, um Ihr Passwort zurückzusetzen:</p>
    <p><a href='{{resetLink}}' style='background-color: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;'>Passwort zurücksetzen</a></p>
    <p><strong>Dieser Link läuft in 1 Stunde ab.</strong></p>
    <p>Falls Sie diese Anfrage nicht gestellt haben, ignorieren Sie diese E-Mail bitte.</p>
    <p>Mit freundlichen Grüßen,<br>BATbern Team</p>
  ",
  "TextPart": "
    Passwort zurücksetzen\n\n
    Hallo,\n\n
    Sie haben eine Zurücksetzung Ihres Passworts für Ihr BATbern-Konto angefordert.\n\n
    Klicken Sie auf den untenstehenden Link, um Ihr Passwort zurückzusetzen:\n
    {{resetLink}}\n\n
    Dieser Link läuft in 1 Stunde ab.\n\n
    Falls Sie diese Anfrage nicht gestellt haben, ignorieren Sie diese E-Mail bitte.\n\n
    Mit freundlichen Grüßen,\n
    BATbern Team
  "
}
```

**English Template (PasswordResetEN):**
```json
{
  "TemplateName": "PasswordResetEN",
  "SubjectPart": "Reset Your BATbern Password",
  "HtmlPart": "
    <h2>Reset Your Password</h2>
    <p>Hello,</p>
    <p>You requested to reset your password for your BATbern account.</p>
    <p>Click the link below to reset your password:</p>
    <p><a href='{{resetLink}}' style='background-color: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;'>Reset Password</a></p>
    <p><strong>This link will expire in 1 hour.</strong></p>
    <p>If you didn't request this, please ignore this email.</p>
    <p>Best regards,<br>BATbern Team</p>
  ",
  "TextPart": "
    Reset Your Password\n\n
    Hello,\n\n
    You requested to reset your password for your BATbern account.\n\n
    Click the link below to reset your password:\n
    {{resetLink}}\n\n
    This link will expire in 1 hour.\n\n
    If you didn't request this, please ignore this email.\n\n
    Best regards,\n
    BATbern Team
  "
}
```

### Backend API Implementation

**`api-gateway/src/main/java/ch/batbern/api/auth/dto/ForgotPasswordRequest.java`:**
```java
public class ForgotPasswordRequest {
    @NotBlank(message = "Email is required")
    @Email(message = "Invalid email format")
    @Size(max = 255, message = "Email too long")
    private String email;

    // Getters/setters
}
```

**`api-gateway/src/main/java/ch/batbern/api/auth/controller/AuthController.java`:**
```java
@RestController
@RequestMapping("/api/v1/auth")
public class AuthController {

    @Autowired
    private PasswordResetService passwordResetService;

    @PostMapping("/forgot-password")
    public ResponseEntity<ForgotPasswordResponse> forgotPassword(
            @Valid @RequestBody ForgotPasswordRequest request,
            @RequestHeader(value = "Accept-Language", defaultValue = "de") String language) {

        // Extract language (de or en)
        String lang = language.startsWith("de") ? "de" : "en";

        // Call service (always returns success to prevent enumeration)
        passwordResetService.initiatePasswordReset(request.getEmail(), lang);

        return ResponseEntity.ok(new ForgotPasswordResponse(
            true,
            "If an account exists with this email, you will receive a password reset link."
        ));
    }

    @PostMapping("/resend-reset-link")
    public ResponseEntity<ResendResetLinkResponse> resendResetLink(
            @Valid @RequestBody ResendResetLinkRequest request,
            @RequestHeader(value = "Accept-Language", defaultValue = "de") String language) {

        String lang = language.startsWith("de") ? "de" : "en";
        passwordResetService.initiatePasswordReset(request.getEmail(), lang);

        return ResponseEntity.ok(new ResendResetLinkResponse(
            true,
            "Reset link sent again to your email."
        ));
    }
}
```

**`api-gateway/src/main/java/ch/batbern/api/auth/service/PasswordResetService.java`:**
```java
@Service
public class PasswordResetService {

    @Autowired
    private AWSCognitoIdentityProvider cognitoClient;

    @Autowired
    private EmailService emailService;

    @Autowired
    private RateLimitService rateLimitService;

    public void initiatePasswordReset(String email, String language) {
        // Check rate limit (3 per hour per email)
        if (!rateLimitService.allowPasswordReset(email)) {
            throw new RateLimitExceededException("Too many reset requests. Try again later.");
        }

        try {
            // Call Cognito forgotPassword
            ForgotPasswordRequest cognitoRequest = new ForgotPasswordRequest()
                .withClientId(cognitoClientId)
                .withUsername(email);

            ForgotPasswordResult result = cognitoClient.forgotPassword(cognitoRequest);

            // Get reset code from result
            String resetCode = result.getCodeDeliveryDetails().getDestination();

            // Build reset link
            String resetLink = String.format(
                "https://app.batbern.ch/auth/reset-password?code=%s&email=%s&lang=%s",
                resetCode, URLEncoder.encode(email, "UTF-8"), language
            );

            // Send email with appropriate template
            String templateName = language.equals("de") ? "PasswordResetDE" : "PasswordResetEN";
            emailService.sendTemplatedEmail(
                email,
                templateName,
                Map.of("resetLink", resetLink)
            );

            // Log attempt (for security auditing)
            securityLogger.logPasswordResetAttempt(email, "SUCCESS");

        } catch (UserNotFoundException e) {
            // Don't reveal that user doesn't exist - just log and return success
            securityLogger.logPasswordResetAttempt(email, "USER_NOT_FOUND");
        } catch (Exception e) {
            securityLogger.logPasswordResetAttempt(email, "FAILURE");
            throw new PasswordResetException("Failed to initiate password reset", e);
        }
    }
}
```

### Frontend Components

**Translation Keys (`public/locales/de/auth.json` - add to existing):**
```json
{
  "forgot": {
    "title": "Passwort zurücksetzen",
    "subtitle": "Geben Sie Ihre E-Mail ein und wir senden Ihnen einen Link zum Zurücksetzen",
    "emailLabel": "E-Mail-Adresse",
    "emailPlaceholder": "ihre.email@beispiel.ch",
    "submitButton": "Link senden",
    "backToLogin": "Zurück zur Anmeldung",
    "confirmTitle": "E-Mail überprüfen",
    "confirmMessage": "Wir haben einen Link zum Zurücksetzen an folgende Adresse gesendet:",
    "confirmInstructions": "Klicken Sie auf den Link in der E-Mail, um Ihr Passwort zurückzusetzen.",
    "resendButton": "Link erneut senden",
    "resendSuccess": "Link wurde erneut gesendet",
    "checkSpam": "Wenn Sie die E-Mail nicht sehen, überprüfen Sie Ihren Spam-Ordner.",
    "linkExpires": "Der Link läuft in 1 Stunde ab.",
    "errors": {
      "emailRequired": "E-Mail ist erforderlich",
      "emailInvalid": "Bitte geben Sie eine gültige E-Mail ein",
      "rateLimitExceeded": "Zu viele Anfragen. Bitte warten Sie {{seconds}} Sekunden.",
      "networkError": "Verbindungsfehler. Bitte versuchen Sie es erneut."
    }
  }
}
```

**`src/components/auth/ForgotPasswordForm/ForgotPasswordForm.tsx`:**
```typescript
import React, { useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useForm } from 'react-hook-form';
import {
  Box,
  TextField,
  Button,
  Typography,
  Link,
  Alert,
  CircularProgress
} from '@mui/material';
import { ArrowBack } from '@mui/icons-material';
import { useForgotPassword } from '@/hooks/useForgotPassword';
import ForgotPasswordConfirmation from '../ForgotPasswordConfirmation/ForgotPasswordConfirmation';

interface ForgotPasswordFormData {
  email: string;
}

const ForgotPasswordForm: React.FC = () => {
  const { t } = useTranslation(['auth', 'validation']);
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [submittedEmail, setSubmittedEmail] = useState('');

  const { mutate: forgotPassword, isLoading, error } = useForgotPassword();

  const {
    register,
    handleSubmit,
    formState: { errors }
  } = useForm<ForgotPasswordFormData>();

  const onSubmit = async (data: ForgotPasswordFormData) => {
    forgotPassword(data.email, {
      onSuccess: () => {
        setSubmittedEmail(data.email);
        setShowConfirmation(true);
      }
    });
  };

  if (showConfirmation) {
    return <ForgotPasswordConfirmation email={submittedEmail} />;
  }

  return (
    <Box sx={{ maxWidth: 400, mx: 'auto', mt: 8 }}>
      <Link
        href="/auth/login"
        sx={{ display: 'flex', alignItems: 'center', mb: 2, textDecoration: 'none' }}
      >
        <ArrowBack sx={{ mr: 1 }} />
        {t('auth:forgot.backToLogin')}
      </Link>

      <Typography variant="h4" align="center" gutterBottom>
        {t('auth:forgot.title')}
      </Typography>
      <Typography variant="body2" align="center" color="text.secondary" sx={{ mb: 3 }}>
        {t('auth:forgot.subtitle')}
      </Typography>

      {error && (
        <Alert severity="error" sx={{ mb: 2 }}>
          {t(`auth:forgot.errors.${error}`)}
        </Alert>
      )}

      <Box component="form" onSubmit={handleSubmit(onSubmit)}>
        <TextField
          {...register('email', {
            required: t('auth:forgot.errors.emailRequired'),
            pattern: {
              value: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
              message: t('auth:forgot.errors.emailInvalid')
            },
            maxLength: {
              value: 255,
              message: t('validation:email.tooLong')
            }
          })}
          label={t('auth:forgot.emailLabel')}
          placeholder={t('auth:forgot.emailPlaceholder')}
          type="email"
          fullWidth
          margin="normal"
          error={!!errors.email}
          helperText={errors.email?.message}
          disabled={isLoading}
        />

        <Button
          type="submit"
          fullWidth
          variant="contained"
          size="large"
          disabled={isLoading}
          sx={{ mt: 2, mb: 2 }}
          startIcon={isLoading ? <CircularProgress size={20} /> : null}
        >
          {isLoading ? t('common:sending') : t('auth:forgot.submitButton')}
        </Button>

        <Alert severity="info" icon="ℹ️">
          <Typography variant="body2">
            {t('auth:forgot.linkExpires')}
          </Typography>
        </Alert>
      </Box>
    </Box>
  );
};

export default ForgotPasswordForm;
```

**`src/components/auth/ForgotPasswordConfirmation/ForgotPasswordConfirmation.tsx`:**
```typescript
import React, { useState, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import {
  Box,
  Typography,
  Button,
  Alert,
  Link
} from '@mui/material';
import { CheckCircle } from '@mui/icons-material';
import { useResendResetLink } from '@/hooks/useResendResetLink';

interface ForgotPasswordConfirmationProps {
  email: string;
}

const ForgotPasswordConfirmation: React.FC<ForgotPasswordConfirmationProps> = ({ email }) => {
  const { t } = useTranslation('auth');
  const [cooldown, setCooldown] = useState(0);
  const { mutate: resendLink, isLoading } = useResendResetLink();

  useEffect(() => {
    if (cooldown > 0) {
      const timer = setTimeout(() => setCooldown(cooldown - 1), 1000);
      return () => clearTimeout(timer);
    }
  }, [cooldown]);

  const handleResend = () => {
    resendLink(email, {
      onSuccess: () => {
        setCooldown(60); // 60-second cooldown
      }
    });
  };

  // Mask email for display (u***@example.com)
  const maskEmail = (email: string) => {
    const [local, domain] = email.split('@');
    return `${local[0]}${'*'.repeat(local.length - 1)}@${domain}`;
  };

  return (
    <Box sx={{ maxWidth: 400, mx: 'auto', mt: 8, textAlign: 'center' }}>
      <CheckCircle sx={{ fontSize: 64, color: 'success.main', mb: 2 }} />

      <Typography variant="h4" gutterBottom>
        {t('forgot.confirmTitle')}
      </Typography>

      <Typography variant="body1" sx={{ mb: 2 }}>
        {t('forgot.confirmMessage')}
      </Typography>

      <Typography variant="h6" sx={{ mb: 3, fontWeight: 'bold' }}>
        {maskEmail(email)}
      </Typography>

      <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>
        {t('forgot.confirmInstructions')}
      </Typography>

      <Button
        variant="contained"
        fullWidth
        href="/auth/login"
        sx={{ mb: 2 }}
      >
        {t('forgot.backToLogin')}
      </Button>

      <Box sx={{ mt: 3 }}>
        <Typography variant="body2" color="text.secondary">
          {t('common:didntReceive')}
        </Typography>
        <Button
          onClick={handleResend}
          disabled={cooldown > 0 || isLoading}
          sx={{ mt: 1 }}
        >
          {cooldown > 0
            ? t('common:wait', { seconds: cooldown })
            : t('forgot.resendButton')}
        </Button>
      </Box>

      <Alert severity="info" sx={{ mt: 3 }}>
        {t('forgot.checkSpam')}
      </Alert>
    </Box>
  );
};

export default ForgotPasswordConfirmation;
```

**`src/hooks/useForgotPassword.ts`:**
```typescript
import { useMutation } from '@tanstack/react-query';
import apiClient from '@/services/apiClient';

interface ForgotPasswordRequest {
  email: string;
}

interface ForgotPasswordResponse {
  success: boolean;
  message: string;
}

export const useForgotPassword = () => {
  return useMutation<ForgotPasswordResponse, Error, string>({
    mutationFn: async (email: string) => {
      const response = await apiClient.post<ForgotPasswordResponse>(
        '/api/v1/auth/forgot-password',
        { email }
      );
      return response.data;
    },
    onError: (error: any) => {
      // Handle specific error types
      if (error.response?.status === 429) {
        throw new Error('rateLimitExceeded');
      }
      throw new Error('networkError');
    }
  });
};
```

## Definition of Done Checklist

### Backend Complete
- [ ] AWS SES German email template created and tested
- [ ] AWS SES English email template created and tested
- [ ] POST /api/v1/auth/forgot-password endpoint implemented
- [ ] AWS Cognito forgotPassword integration working
- [ ] Bilingual email template selection based on language preference
- [ ] Email enumeration prevention implemented (same response always)
- [ ] Rate limiting enforced (3 requests per hour per email)
- [ ] Security logging for all reset attempts

### Frontend Complete
- [ ] ForgotPasswordForm component with email validation
- [ ] ForgotPasswordConfirmation component with masked email display
- [ ] Resend functionality with 60-second cooldown
- [ ] All UI text using i18n translation keys (zero hard-coded text)
- [ ] Loading states during API requests
- [ ] Error handling for all scenarios (invalid email, rate limit, network)
- [ ] Navigation back to login screen

### Integration Complete
- [ ] Forgot password flow works end-to-end
- [ ] Bilingual emails delivered successfully (test with MailHog in dev)
- [ ] Reset link format correct with code, email, and language parameters
- [ ] Email enumeration prevention verified (same response for non-existent emails)
- [ ] Rate limiting tested and working

### Testing Complete
- [ ] All unit tests passing (>90% coverage)
- [ ] Integration tests verify API and Cognito integration
- [ ] E2E test covers complete forgot password flow
- [ ] Email template rendering verified in both languages
- [ ] Accessibility audit score >90 (WCAG 2.1 AA)

### Documentation Complete
- [ ] API endpoint documented in OpenAPI spec
- [ ] AWS SES template configuration documented
- [ ] Forgot password flow documented in README
- [ ] Troubleshooting guide for email delivery
- [ ] Rate limiting rules documented

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation for Story 1.2 corrective work | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated during implementation*

### Implementation Approach
*To be populated during implementation*

### Files Changed
*To be populated during implementation*

**Created:**
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/dto/ForgotPasswordRequest.java`
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/dto/ForgotPasswordResponse.java`
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/service/PasswordResetService.java`
- [ ] Frontend: `src/components/auth/ForgotPasswordForm/ForgotPasswordForm.tsx`
- [ ] Frontend: `src/components/auth/ForgotPasswordConfirmation/ForgotPasswordConfirmation.tsx`
- [ ] Frontend: `src/hooks/useForgotPassword.ts`
- [ ] Frontend: `src/hooks/useResendResetLink.ts`
- [ ] AWS: SES template `PasswordResetDE` (German)
- [ ] AWS: SES template `PasswordResetEN` (English)

**Modified:**
- [ ] `api-gateway/src/main/java/ch/batbern/api/auth/controller/AuthController.java` - Add forgot password endpoints
- [ ] `public/locales/de/auth.json` - Add forgot password translations
- [ ] `public/locales/en/auth.json` - Add forgot password translations
- [ ] `web-frontend/src/App.tsx` - Add forgot password route
