# Story 1.2.4: Implement Email Verification Flow

## Status
Accepted

## Story

**As a** newly registered user,
**I want** to verify my email address using a 6-digit code or email link in my preferred language,
**so that** I can activate my account and access the BATbern platform.

**Context:** This story implements the Email Verification flow specified in wireframe story-1.2-email-verification.md. This functionality was completely missing from the original Story 1.2 implementation. Users arrive at this screen after successful registration (Story 1.2.3).

**Dependencies:**
- **BLOCKS: Story 1.2.1 (i18n Foundation)** - Requires react-i18next configuration
- **BLOCKS: Story 1.2.3 (Account Creation)** - Users navigate here after registration

## Domain Context

### Primary Domain
- **Shared/Infrastructure** (Authentication & Email Verification)

### Involved Services
- **web-frontend** (React verification component)
- **API Gateway** (verification request routing)
- **AWS Cognito** (email verification and user confirmation)
- **AWS SES** (bilingual verification email delivery)

### Cross-Domain Dependencies
- AWS Cognito User Pools (confirmSignUp API)
- AWS SES email templates (bilingual verification emails)

## Requirements Context

### Related Functional Requirements
- **FR1**: Role-based authentication (email verification required before access)
- **NFR3**: Integration with AWS Cognito and AWS SES
- **NFR4**: Multi-language support (German/English verification emails and UI)

### Related Wireframes
- **Primary**: `docs/wireframes/story-1.2-email-verification.md`
  - 6-digit code input with auto-advance
  - Auto-submit when all digits entered
  - Alternative: Email link auto-verification
  - Resend functionality with cooldown
  - Success screen with auto-redirect to dashboard

## Architecture Context

### Architecture Patterns
- **Frontend Architecture** (`docs/architecture/05-frontend-architecture.md`):
  - React 18.2+ with TypeScript
  - Material-UI for code input components
  - Custom code input with auto-advance logic
  - React Query for verification mutation
  - i18next for internationalization (from Story 1.2.1)

### Infrastructure Components
- **AWS Cognito**: `confirmSignUp` and `resendConfirmationCode` APIs
- **AWS SES**: Bilingual email templates for verification
- **Verification Code**: 6-digit numeric, 24-hour expiration
- **Email Link Format**: `/auth/verify-email?code={code}&email={email}`
- **Auto-Verification**: Extract code from URL and auto-submit

## Acceptance Criteria

### Code Input Interface
1. **6-Digit Input Boxes**: Six individual input fields for verification code
2. **Auto-Advance**: Automatically move focus to next box when digit entered
3. **Paste Support**: Allow pasting full 6-digit code that auto-distributes across boxes
4. **Numeric Keyboard**: Trigger numeric keyboard on mobile with `inputmode="numeric"`
5. **Backspace Handling**: Move to previous box and clear digit when backspace pressed
6. **Auto-Submit**: Automatically submit verification when all 6 digits entered
7. **Verify Button**: Manual submit option with disabled state until code complete

### Email Link Auto-Verification
8. **URL Parameter Detection**: Extract code and email from URL parameters
9. **Auto-Verification Flow**: Show loading screen, auto-verify with extracted code
10. **Success Display**: Show success message after auto-verification
11. **Error Handling**: Handle invalid/expired codes from URL parameters

### Resend Functionality
12. **Resend Link**: Allow user to request new verification code
13. **Resend Cooldown**: 60-second cooldown between resend attempts
14. **Countdown Timer**: Display remaining cooldown time
15. **Toast Notification**: Show "Verification email sent again" message

### Success & Redirect
16. **Success Screen**: Display "Email Verified!" confirmation
17. **Auto-Redirect**: Redirect to role-based dashboard after 3-second countdown
18. **Go to Dashboard Button**: Manual redirect option without waiting
19. **Role-Based Routing**: Navigate to correct dashboard based on user role (ATTENDEE by default)

### Bilingual Email Templates (AWS SES)
20. **German Email Template**: Verification email in German with 6-digit code and link
21. **English Email Template**: Verification email in English with 6-digit code and link
22. **Language Detection**: Send email in user's language from registration (`custom:language`)
23. **24-Hour Expiration**: Include expiration notice in email

### Error Handling
24. **Invalid Code Error**: Display error when code doesn't match
25. **Expired Code Error**: Display error and suggest resend for expired codes
26. **Too Many Attempts Error**: Display error and enforce cooldown after 5 failed attempts
27. **Network Error**: Display error with retry option
28. **Already Verified**: Redirect to login if email already verified

## Test Specifications (TDD)

### Code Input Component Tests
**Test Group 1: Code Input Functionality**
- Test 1.1: should_render6InputBoxes_when_componentMounted
- Test 1.2: should_autoAdvanceFocus_when_digitEntered
- Test 1.3: should_distributePastedCode_when_6DigitsPasted
- Test 1.4: should_moveToPreviousBox_when_backspacePressed
- Test 1.5: should_autoSubmit_when_allDigitsEntered
- Test 1.6: should_disableSubmitButton_when_codeIncomplete
- Test 1.7: should_clearAllInputs_when_errorOccurs

### Email Verification Flow Tests
**Test Group 2: Verification Process**
- Test 2.1: should_callCognitoAPI_when_verifyClicked
- Test 2.2: should_displaySuccessScreen_when_verificationSuccessful
- Test 2.3: should_startRedirectCountdown_when_verified
- Test 2.4: should_redirectToDashboard_when_countdownEnds
- Test 2.5: should_immediatelyRedirect_when_goToDashboardClicked

### Auto-Verification Tests
**Test Group 3: Email Link Auto-Verification**
- Test 3.1: should_extractCodeFromURL_when_pageLoadedWithParams
- Test 3.2: should_autoVerify_when_codeInURL
- Test 3.3: should_showLoadingScreen_when_autoVerifying
- Test 3.4: should_displaySuccess_when_autoVerificationSuccessful
- Test 3.5: should_handleError_when_autoVerificationFails

### Resend Functionality Tests
**Test Group 4: Resend Verification**
- Test 4.1: should_callResendAPI_when_resendLinkClicked
- Test 4.2: should_showToastNotification_when_resendSuccessful
- Test 4.3: should_startCooldown_when_resendSuccessful
- Test 4.4: should_disableResendLink_when_cooldownActive
- Test 4.5: should_displayCountdown_when_cooldownActive

### Error Handling Tests
**Test Group 5: Error Scenarios**
- Test 5.1: should_displayError_when_codeInvalid
- Test 5.2: should_displayError_when_codeExpired
- Test 5.3: should_displayError_when_tooManyAttempts
- Test 5.4: should_displayError_when_networkFails
- Test 5.5: should_redirectToLogin_when_alreadyVerified

### Internationalization Tests
**Test Group 6: i18n**
- Test 6.1: should_displayGermanText_when_languageIsGerman
- Test 6.2: should_displayEnglishText_when_languageIsEnglish
- Test 6.3: should_localizeErrors_when_verificationFails
- Test 6.4: should_sendGermanEmail_when_userLanguageIsGerman
- Test 6.5: should_sendEnglishEmail_when_userLanguageIsEnglish

### Test File Locations
**Frontend Tests:**
- `web-frontend/src/components/auth/EmailVerification/EmailVerification.test.tsx`
- `web-frontend/src/components/auth/CodeInput/CodeInput.test.tsx`
- `web-frontend/src/hooks/useEmailVerification/useEmailVerification.test.ts`

**Backend Tests:**
- `api-gateway/src/test/integration/auth/EmailVerificationTest.java`
- `api-gateway/src/test/unit/email/VerificationEmailServiceTest.java`

**E2E Tests:**
- `e2e/auth/email-verification.spec.ts`
- `e2e/auth/email-link-verification.spec.ts`

## Tasks / Subtasks (TDD Workflow)

### Task 1: AWS SES Email Template Setup (Infrastructure)
- [ ] Create German verification email template in AWS SES
- [ ] Create English verification email template in AWS SES
- [ ] Include 6-digit code and verification link in templates
- [ ] Test templates in AWS SES console
- [ ] Document template IDs and configuration

### Task 2: Backend API Endpoints (RED Phase)
- [ ] Write failing integration test for `/api/v1/auth/verify-email` endpoint
- [ ] Write failing test for Cognito `confirmSignUp` integration
- [ ] Write failing test for bilingual email template selection
- [ ] Write failing test for resend functionality
- [ ] Write failing test for already-verified user handling

### Task 3: Backend Implementation (GREEN Phase)
- [ ] Create EmailVerificationRequest DTO
- [ ] Implement POST /api/v1/auth/verify-email endpoint
- [ ] Integrate with AWS Cognito SDK `confirmSignUp`
- [ ] Implement POST /api/v1/auth/resend-verification endpoint
- [ ] Integrate with Cognito `resendConfirmationCode`
- [ ] Add rate limiting for verification attempts
- [ ] Verify all backend tests pass

### Task 4: Code Input Component (RED Phase)
- [ ] Write failing tests for CodeInput component rendering
- [ ] Write failing tests for auto-advance functionality
- [ ] Write failing tests for paste handling
- [ ] Write failing tests for backspace navigation
- [ ] Write failing tests for auto-submit

### Task 5: Implement Code Input Component (GREEN Phase)
- [ ] Create CodeInput component with 6 input boxes
- [ ] Implement auto-advance on digit entry
- [ ] Add paste detection and distribution logic
- [ ] Implement backspace navigation
- [ ] Add auto-submit when complete
- [ ] Verify CodeInput tests pass

### Task 6: Email Verification Component (RED Phase)
- [ ] Write failing tests for EmailVerification component
- [ ] Write failing tests for manual verification flow
- [ ] Write failing tests for success screen
- [ ] Write failing tests for auto-redirect countdown
- [ ] Write failing tests for resend functionality

### Task 7: Implement Email Verification Component (GREEN Phase)
- [ ] Create EmailVerification component
- [ ] Integrate CodeInput component
- [ ] Implement useEmailVerification hook with React Query
- [ ] Add success screen with countdown timer
- [ ] Implement resend functionality with cooldown
- [ ] Add all i18n translation keys to auth.json (verify namespace)
- [ ] Verify EmailVerification tests pass

### Task 8: Auto-Verification from URL (RED Phase)
- [ ] Write failing tests for URL parameter extraction
- [ ] Write failing tests for auto-verification flow
- [ ] Write failing tests for loading screen
- [ ] Write failing tests for error handling

### Task 9: Implement Auto-Verification (GREEN Phase)
- [ ] Extract code and email from URL parameters
- [ ] Show loading screen during auto-verification
- [ ] Auto-submit verification with extracted code
- [ ] Handle success and error states
- [ ] Verify auto-verification tests pass

### Task 10: Error Handling (GREEN Phase)
- [ ] Implement invalid code error display
- [ ] Implement expired code error with resend suggestion
- [ ] Implement too many attempts error with cooldown
- [ ] Implement network error with retry
- [ ] Handle already-verified user redirect

### Task 11: Role-Based Redirect (GREEN Phase)
- [ ] Fetch user role from Cognito after verification
- [ ] Implement role-based dashboard routing logic
- [ ] Add 3-second countdown timer
- [ ] Implement immediate redirect on button click
- [ ] Verify redirect to correct dashboard (ATTENDEE by default)

### Task 12: E2E Testing (REFACTOR Phase)
- [ ] Create E2E test for manual code entry flow
- [ ] Create E2E test for email link auto-verification
- [ ] Test resend functionality with cooldown
- [ ] Verify bilingual email delivery (in dev with MailHog)
- [ ] Test all error scenarios
- [ ] Run accessibility audit

### Task 13: Documentation
- [ ] Document verification API endpoints in OpenAPI spec
- [ ] Update README with email verification flow
- [ ] Document AWS SES template configuration
- [ ] Add troubleshooting guide for verification issues
- [ ] Document 24-hour code expiration

## Dev Notes - Implementation Guide

### AWS SES Email Template Configuration

**German Template (EmailVerificationDE):**
```json
{
  "TemplateName": "EmailVerificationDE",
  "SubjectPart": "Verifizieren Sie Ihr BATbern-Konto",
  "HtmlPart": "
    <h2>E-Mail-Adresse verifizieren</h2>
    <p>Hallo {{name}},</p>
    <p>Willkommen bei BATbern! Bitte verifizieren Sie Ihre E-Mail-Adresse, um Ihr Konto zu aktivieren.</p>
    <h3>Ihr Verifizierungscode: <strong>{{verificationCode}}</strong></h3>
    <p>Alternativ können Sie auf den untenstehenden Link klicken, um sofort zu verifizieren:</p>
    <p><a href='{{verificationLink}}' style='background-color: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;'>E-Mail verifizieren</a></p>
    <p><strong>Dieser Code läuft in 24 Stunden ab.</strong></p>
    <p>Falls Sie kein BATbern-Konto erstellt haben, ignorieren Sie diese E-Mail bitte.</p>
    <p>Mit freundlichen Grüßen,<br>BATbern Team</p>
  ",
  "TextPart": "
    E-Mail-Adresse verifizieren\n\n
    Hallo {{name}},\n\n
    Willkommen bei BATbern! Bitte verifizieren Sie Ihre E-Mail-Adresse, um Ihr Konto zu aktivieren.\n\n
    Ihr Verifizierungscode: {{verificationCode}}\n\n
    Alternativ können Sie auf den Link klicken:\n
    {{verificationLink}}\n\n
    Dieser Code läuft in 24 Stunden ab.\n\n
    Falls Sie kein BATbern-Konto erstellt haben, ignorieren Sie diese E-Mail bitte.\n\n
    Mit freundlichen Grüßen,\n
    BATbern Team
  "
}
```

**English Template (EmailVerificationEN):**
```json
{
  "TemplateName": "EmailVerificationEN",
  "SubjectPart": "Verify Your BATbern Account",
  "HtmlPart": "
    <h2>Verify Your Email</h2>
    <p>Hello {{name}},</p>
    <p>Welcome to BATbern! Please verify your email address to activate your account.</p>
    <h3>Your verification code: <strong>{{verificationCode}}</strong></h3>
    <p>Alternatively, click the link below to verify instantly:</p>
    <p><a href='{{verificationLink}}' style='background-color: #1976d2; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;'>Verify Email</a></p>
    <p><strong>This code will expire in 24 hours.</strong></p>
    <p>If you didn't create a BATbern account, please ignore this email.</p>
    <p>Best regards,<br>BATbern Team</p>
  ",
  "TextPart": "
    Verify Your Email\n\n
    Hello {{name}},\n\n
    Welcome to BATbern! Please verify your email address to activate your account.\n\n
    Your verification code: {{verificationCode}}\n\n
    Alternatively, click the link:\n
    {{verificationLink}}\n\n
    This code will expire in 24 hours.\n\n
    If you didn't create a BATbern account, please ignore this email.\n\n
    Best regards,\n
    BATbern Team
  "
}
```

### Backend API Implementation

**`api-gateway/src/main/java/ch/batbern/api/auth/controller/AuthController.java`:**
```java
@RestController
@RequestMapping("/api/v1/auth")
public class AuthController {

    @Autowired
    private EmailVerificationService verificationService;

    @PostMapping("/verify-email")
    public ResponseEntity<EmailVerificationResponse> verifyEmail(
            @Valid @RequestBody EmailVerificationRequest request) {

        verificationService.verifyEmail(request.getEmail(), request.getCode());

        return ResponseEntity.ok(new EmailVerificationResponse(
            true,
            "Email verified successfully"
        ));
    }

    @PostMapping("/resend-verification")
    public ResponseEntity<ResendVerificationResponse> resendVerification(
            @Valid @RequestBody ResendVerificationRequest request) {

        verificationService.resendVerificationCode(request.getEmail());

        return ResponseEntity.ok(new ResendVerificationResponse(
            true,
            "Verification email sent again"
        ));
    }
}
```

**`api-gateway/src/main/java/ch/batbern/api/auth/service/EmailVerificationService.java`:**
```java
@Service
public class EmailVerificationService {

    @Autowired
    private AWSCognitoIdentityProvider cognitoClient;

    public void verifyEmail(String email, String code) {
        ConfirmSignUpRequest request = new ConfirmSignUpRequest()
            .withClientId(cognitoClientId)
            .withUsername(email)
            .withConfirmationCode(code);

        try {
            cognitoClient.confirmSignUp(request);
            securityLogger.logEmailVerification(email, "SUCCESS");

        } catch (CodeMismatchException e) {
            securityLogger.logEmailVerification(email, "INVALID_CODE");
            throw new InvalidVerificationCodeException("Invalid verification code");
        } catch (ExpiredCodeException e) {
            securityLogger.logEmailVerification(email, "EXPIRED_CODE");
            throw new ExpiredVerificationCodeException("Verification code has expired");
        } catch (TooManyFailedAttemptsException e) {
            securityLogger.logEmailVerification(email, "TOO_MANY_ATTEMPTS");
            throw new RateLimitExceededException("Too many failed attempts");
        }
    }

    public void resendVerificationCode(String email) {
        ResendConfirmationCodeRequest request = new ResendConfirmationCodeRequest()
            .withClientId(cognitoClientId)
            .withUsername(email);

        cognitoClient.resendConfirmationCode(request);
        securityLogger.logVerificationResend(email, "SUCCESS");
    }
}
```

### Frontend Code Input Component

**`src/components/auth/CodeInput/CodeInput.tsx`:**
```typescript
import React, { useRef, useState, KeyboardEvent, ClipboardEvent } from 'react';
import { Box, TextField } from '@mui/material';

interface CodeInputProps {
  length: number;
  onComplete: (code: string) => void;
  onCodeChange?: (code: string) => void;
  error?: boolean;
}

const CodeInput: React.FC<CodeInputProps> = ({
  length,
  onComplete,
  onCodeChange,
  error = false
}) => {
  const [code, setCode] = useState<string[]>(Array(length).fill(''));
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  const handleChange = (index: number, value: string) => {
    if (!/^\d*$/.test(value)) return; // Only digits

    const newCode = [...code];
    newCode[index] = value.slice(-1); // Only last digit
    setCode(newCode);

    const codeString = newCode.join('');
    onCodeChange?.(codeString);

    // Auto-advance to next box
    if (value && index < length - 1) {
      inputRefs.current[index + 1]?.focus();
    }

    // Auto-submit when complete
    if (codeString.length === length) {
      onComplete(codeString);
    }
  };

  const handleKeyDown = (index: number, e: KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Backspace' && !code[index] && index > 0) {
      // Move to previous box on backspace
      inputRefs.current[index - 1]?.focus();
      const newCode = [...code];
      newCode[index - 1] = '';
      setCode(newCode);
    }
  };

  const handlePaste = (e: ClipboardEvent<HTMLInputElement>) => {
    e.preventDefault();
    const pastedData = e.clipboardData.getData('text').slice(0, length);

    if (!/^\d+$/.test(pastedData)) return; // Only digits

    const newCode = pastedData.split('').concat(Array(length).fill('')).slice(0, length);
    setCode(newCode);

    const codeString = newCode.join('');
    onCodeChange?.(codeString);

    // Focus last filled box or last box
    const lastFilledIndex = Math.min(pastedData.length - 1, length - 1);
    inputRefs.current[lastFilledIndex]?.focus();

    // Auto-submit if complete
    if (pastedData.length === length) {
      onComplete(codeString);
    }
  };

  return (
    <Box sx={{ display: 'flex', gap: 1, justifyContent: 'center' }}>
      {code.map((digit, index) => (
        <TextField
          key={index}
          inputRef={(el) => (inputRefs.current[index] = el)}
          value={digit}
          onChange={(e) => handleChange(index, e.target.value)}
          onKeyDown={(e) => handleKeyDown(index, e as any)}
          onPaste={handlePaste}
          inputProps={{
            maxLength: 1,
            style: { textAlign: 'center', fontSize: '24px' },
            inputMode: 'numeric',
            'aria-label': `Digit ${index + 1}`
          }}
          sx={{
            width: 56,
            '& input': {
              padding: '16px 0'
            }
          }}
          error={error}
          autoFocus={index === 0}
        />
      ))}
    </Box>
  );
};

export default CodeInput;
```

### Email Verification Component

**Translation Keys (`public/locales/de/auth.json` - add to existing):**
```json
{
  "verify": {
    "title": "E-Mail verifizieren",
    "subtitle": "Wir haben einen Verifizierungscode gesendet an:",
    "codeLabel": "Geben Sie den 6-stelligen Code aus Ihrer E-Mail ein:",
    "submitButton": "E-Mail verifizieren",
    "resendLink": "Verifizierungs-E-Mail erneut senden",
    "resendSuccess": "E-Mail wurde erneut gesendet",
    "resendCooldown": "Erneut senden verfügbar in {{seconds}} Sekunden",
    "expirationNotice": "Der Verifizierungscode läuft in 24 Stunden ab.",
    "checkSpam": "Wenn Sie die E-Mail nicht sehen, überprüfen Sie Ihren Spam-Ordner.",
    "contactSupport": "Brauchen Sie Hilfe? Support kontaktieren",
    "successTitle": "E-Mail verifiziert!",
    "successMessage": "Ihr Konto ist jetzt aktiv. Willkommen bei BATbern!",
    "goToDashboard": "Zum Dashboard",
    "redirecting": "Sie werden automatisch weitergeleitet in {{seconds}} Sekunden...",
    "verifying": "Verifizierung läuft...",
    "errors": {
      "invalidCode": "Ungültiger Code. Bitte überprüfen und erneut versuchen.",
      "expiredCode": "Dieser Code ist abgelaufen. Klicken Sie auf 'Erneut senden' für einen neuen.",
      "tooManyAttempts": "Zu viele fehlgeschlagene Versuche. Bitte warten Sie 15 Minuten oder fordern Sie einen neuen Code an.",
      "networkError": "Verbindungsfehler. Bitte überprüfen Sie Ihre Internetverbindung.",
      "alreadyVerified": "Ihre E-Mail ist bereits verifiziert. Weiterleitung zur Anmeldung..."
    }
  }
}
```

**`src/components/auth/EmailVerification/EmailVerification.tsx`:**
```typescript
import React, { useState, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { useNavigate, useSearchParams } from 'react-router-dom';
import {
  Box,
  Typography,
  Button,
  Alert,
  CircularProgress
} from '@mui/material';
import { CheckCircle } from '@mui/icons-material';
import CodeInput from '../CodeInput/CodeInput';
import { useEmailVerification, useResendVerification } from '@/hooks/useEmailVerification';

const EmailVerification: React.FC = () => {
  const { t } = useTranslation('auth');
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  const [code, setCode] = useState('');
  const [isVerified, setIsVerified] = useState(false);
  const [redirectCountdown, setRedirectCountdown] = useState(3);
  const [resendCooldown, setResendCooldown] = useState(0);

  const email = searchParams.get('email') || '';
  const autoCode = searchParams.get('code');

  const { mutate: verify, isLoading, error } = useEmailVerification();
  const { mutate: resend } = useResendVerification();

  // Auto-verification from email link
  useEffect(() => {
    if (autoCode && email) {
      handleVerification(autoCode);
    }
  }, [autoCode, email]);

  // Redirect countdown
  useEffect(() => {
    if (isVerified && redirectCountdown > 0) {
      const timer = setTimeout(() => setRedirectCountdown(redirectCountdown - 1), 1000);
      return () => clearTimeout(timer);
    } else if (isVerified && redirectCountdown === 0) {
      navigate('/attendee/dashboard'); // Default to ATTENDEE dashboard
    }
  }, [isVerified, redirectCountdown, navigate]);

  // Resend cooldown
  useEffect(() => {
    if (resendCooldown > 0) {
      const timer = setTimeout(() => setResendCooldown(resendCooldown - 1), 1000);
      return () => clearTimeout(timer);
    }
  }, [resendCooldown]);

  const handleVerification = (verificationCode: string) => {
    verify({ email, code: verificationCode }, {
      onSuccess: () => {
        setIsVerified(true);
      }
    });
  };

  const handleResend = () => {
    resend(email, {
      onSuccess: () => {
        setResendCooldown(60); // 60-second cooldown
      }
    });
  };

  if (autoCode && isLoading) {
    return (
      <Box sx={{ maxWidth: 400, mx: 'auto', mt: 8, textAlign: 'center' }}>
        <CircularProgress size={64} />
        <Typography variant="h5" sx={{ mt: 2 }}>
          {t('verify.verifying')}
        </Typography>
      </Box>
    );
  }

  if (isVerified) {
    return (
      <Box sx={{ maxWidth: 400, mx: 'auto', mt: 8, textAlign: 'center' }}>
        <CheckCircle sx={{ fontSize: 64, color: 'success.main', mb: 2 }} />
        <Typography variant="h4" gutterBottom>
          {t('verify.successTitle')}
        </Typography>
        <Typography variant="body1" sx={{ mb: 3 }}>
          {t('verify.successMessage')}
        </Typography>
        <Button
          variant="contained"
          fullWidth
          onClick={() => navigate('/attendee/dashboard')}
          sx={{ mb: 2 }}
        >
          {t('verify.goToDashboard')}
        </Button>
        <Typography variant="body2" color="text.secondary">
          {t('verify.redirecting', { seconds: redirectCountdown })}
        </Typography>
      </Box>
    );
  }

  return (
    <Box sx={{ maxWidth: 500, mx: 'auto', mt: 8 }}>
      <Typography variant="h4" align="center" gutterBottom>
        {t('verify.title')}
      </Typography>
      <Typography variant="body2" align="center" color="text.secondary" sx={{ mb: 1 }}>
        {t('verify.subtitle')}
      </Typography>
      <Typography variant="h6" align="center" sx={{ mb: 3 }}>
        {email}
      </Typography>

      {error && (
        <Alert severity="error" sx={{ mb: 2 }}>
          {t(`verify.errors.${error}`)}
        </Alert>
      )}

      <Typography variant="body2" align="center" sx={{ mb: 2 }}>
        {t('verify.codeLabel')}
      </Typography>

      <CodeInput
        length={6}
        onComplete={handleVerification}
        onCodeChange={setCode}
        error={!!error}
      />

      <Button
        variant="contained"
        fullWidth
        size="large"
        onClick={() => handleVerification(code)}
        disabled={code.length !== 6 || isLoading}
        sx={{ mt: 3, mb: 2 }}
      >
        {isLoading ? <CircularProgress size={24} /> : t('verify.submitButton')}
      </Button>

      <Box sx={{ textAlign: 'center', mt: 3 }}>
        <Typography variant="body2" color="text.secondary">
          {t('common:didntReceive')}
        </Typography>
        <Button
          onClick={handleResend}
          disabled={resendCooldown > 0}
          sx={{ mt: 1 }}
        >
          {resendCooldown > 0
            ? t('verify.resendCooldown', { seconds: resendCooldown })
            : t('verify.resendLink')}
        </Button>
      </Box>

      <Alert severity="info" sx={{ mt: 3 }}>
        <Typography variant="body2">
          {t('verify.expirationNotice')}
        </Typography>
        <Typography variant="body2" sx={{ mt: 1 }}>
          {t('verify.checkSpam')}
        </Typography>
      </Alert>
    </Box>
  );
};

export default EmailVerification;
```

## Definition of Done Checklist

### Backend Complete
- [ ] AWS SES German email template created and tested
- [ ] AWS SES English email template created and tested
- [ ] POST /api/v1/auth/verify-email endpoint implemented
- [ ] POST /api/v1/auth/resend-verification endpoint implemented
- [ ] AWS Cognito confirmSignUp integration working
- [ ] AWS Cognito resendConfirmationCode integration working
- [ ] Rate limiting enforced (5 verification attempts before lockout)
- [ ] Security logging for all verification attempts

### Frontend Complete
- [ ] CodeInput component with 6 input boxes and auto-advance
- [ ] Paste support for full 6-digit code
- [ ] Backspace navigation working correctly
- [ ] Auto-submit when all digits entered
- [ ] Email link auto-verification from URL parameters
- [ ] Success screen with auto-redirect countdown
- [ ] Resend functionality with 60-second cooldown
- [ ] All UI text using i18n translation keys

### Integration Complete
- [ ] Email verification flow works end-to-end
- [ ] Auto-verification from email link works
- [ ] Bilingual verification emails delivered (test in dev)
- [ ] Role-based redirect to correct dashboard
- [ ] All error scenarios handled correctly

### Testing Complete
- [ ] All unit tests passing (>90% coverage)
- [ ] Integration tests verify Cognito integration
- [ ] E2E test covers complete verification flow
- [ ] E2E test for email link auto-verification
- [ ] Email template rendering verified in both languages
- [ ] Accessibility audit score >90 (WCAG 2.1 AA)

### Documentation Complete
- [ ] API endpoints documented in OpenAPI spec
- [ ] Email verification flow documented in README
- [ ] AWS SES template configuration documented
- [ ] 24-hour code expiration documented
- [ ] Troubleshooting guide for verification issues

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation for Story 1.2 corrective work | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated during implementation*

### Implementation Approach
*To be populated during implementation*

### Files Changed
*To be populated during implementation*

**Created:**
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/dto/EmailVerificationRequest.java`
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/dto/EmailVerificationResponse.java`
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/service/EmailVerificationService.java`
- [ ] Frontend: `src/components/auth/EmailVerification/EmailVerification.tsx`
- [ ] Frontend: `src/components/auth/CodeInput/CodeInput.tsx`
- [ ] Frontend: `src/hooks/useEmailVerification.ts`
- [ ] AWS: SES template `EmailVerificationDE` (German)
- [ ] AWS: SES template `EmailVerificationEN` (English)

**Modified:**
- [ ] `api-gateway/src/main/java/ch/batbern/api/auth/controller/AuthController.java`
- [ ] `public/locales/de/auth.json`
- [ ] `public/locales/en/auth.json`
- [ ] `web-frontend/src/App.tsx` - Add email verification route
