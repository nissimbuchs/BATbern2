# Story 1.1: Shared Kernel Infrastructure Setup

## Status
Draft

## Story
**As a** platform architect,
**I want** to establish the shared kernel foundation with common types and domain events,
**so that** all microservices can communicate consistently through domain-driven design patterns.

## Domain Context

### Primary Domain
Shared Infrastructure & Core Services - Foundation for all bounded contexts

### Involved Services
- Shared Kernel (new repository)
- API Gateway (future integration)
- All Domain Services (as consumers of shared types)
- EventBridge (for domain event publishing)

### Cross-Domain Dependencies
- This story enables all other domain services
- Required by Event Management, Speaker Coordination, Partner Analytics, and Attendee Experience services
- Provides foundation for cross-domain integration via EventBridge

## Requirements Context

### Related Functional Requirements
- FR1: Role-based authentication (shared user types)
- Support for all workflow automation requiring cross-service communication
- Foundation for all domain event publishing and consumption

### Workflow Steps (if applicable)
N/A - This is infrastructure foundation

### Acceptance Criteria Source
Epic 1, Story 1.1 - Complete acceptance criteria as defined in epic

## Architecture Context

### Architecture Patterns
**Referenced from architecture documentation:**
- **DDD Shared Kernel Pattern** [Source: architecture/01-system-overview.md#shared-kernel]: Common types and events shared across bounded contexts
- **Domain Event Publishing** [Source: architecture/06-backend-architecture.md#event-sourcing]: EventBridge integration for cross-service communication
- **Repository Structure** [Source: architecture/source-tree.md#shared-kernel]: Maven-based shared library with semantic versioning
- **Spring Boot Integration** [Source: architecture/tech-stack.md#backend]: Java 21 + Spring Boot 3.2 for enterprise patterns

### Infrastructure Components
**From 02-infrastructure-deployment.md:**
- **Maven Repository**: Internal artifact repository for shared kernel distribution
- **EventBridge**: AWS EventBridge for domain event routing between services
- **GitHub Actions**: CI/CD pipeline for automated building and publishing
- **S3**: Artifact storage and distribution
- **IAM Roles**: Cross-service permissions for EventBridge publishing

## Wireframe Context

### Wireframe References
N/A - Infrastructure component with no direct UI

### UI Components
N/A - Backend infrastructure only

## Acceptance Criteria

1. **Shared Domain Types**: Create common value objects (`EventId`, `SpeakerId`, `CompanyId`, `UserId`) with validation
2. **Domain Events**: Implement event base classes (`DomainEvent`, `EventCreatedEvent`, `SpeakerInvitedEvent`)
3. **Common Utilities**: Establish shared validation, error handling, and logging patterns
4. **Event Publishing**: Configure AWS EventBridge integration for cross-service communication
5. **Shared Kernel Repository**: Initialize Git repository with proper Java project structure
6. **Maven Dependencies**: Configure shared dependencies (Spring Boot, validation, EventBridge)
7. **Package Structure**: Organize by domain concepts (`events`, `types`, `exceptions`, `utils`)
8. **CI/CD Pipeline**: GitHub Actions workflow for artifact publishing to internal repository
9. **Test Coverage**: 90%+ unit test coverage for all shared components
10. **Documentation**: JavaDoc for all public APIs and architecture decision records
11. **Versioning Strategy**: Semantic versioning with backward compatibility guarantees

## Test Specifications (TDD)

### Test Scenarios by Acceptance Criteria

**AC1 Tests (Shared Domain Types):**
- Test 1.1: should_createValidEventId_when_validUUIDProvided
- Test 1.2: should_throwValidationException_when_invalidUUIDProvided
- Test 1.3: should_createValidSpeakerId_when_validDataProvided
- Test 1.4: should_validateCompanyId_when_instantiated
- Test 1.5: should_enforceUserIdValidation_when_created

**AC2 Tests (Domain Events):**
- Test 2.1: should_createDomainEvent_when_validDataProvided
- Test 2.2: should_includeTimestamp_when_eventCreated
- Test 2.3: should_publishEventCreatedEvent_when_eventEstablished
- Test 2.4: should_serializeEventToJSON_when_publishingToEventBridge

**AC3 Tests (Common Utilities):**
- Test 3.1: should_validateSwissUID_when_companyValidationCalled
- Test 3.2: should_formatErrorMessages_when_validationFails
- Test 3.3: should_logStructuredData_when_loggingUtilCalled

**AC4 Tests (Event Publishing):**
- Test 4.1: should_publishToEventBridge_when_domainEventTriggered
- Test 4.2: should_retryFailedPublishes_when_eventBridgeUnavailable
- Test 4.3: should_handlePublishingErrors_when_malformedEvent

### Test File Locations

**Backend Tests:**
- Unit: `shared-kernel/src/test/unit/types/EventIdTest.java`
- Unit: `shared-kernel/src/test/unit/types/SpeakerIdTest.java`
- Unit: `shared-kernel/src/test/unit/types/CompanyIdTest.java`
- Unit: `shared-kernel/src/test/unit/events/DomainEventTest.java`
- Unit: `shared-kernel/src/test/unit/events/EventCreatedEventTest.java`
- Unit: `shared-kernel/src/test/unit/utils/ValidationUtilsTest.java`
- Integration: `shared-kernel/src/test/integration/events/EventBridgePublisherTest.java`

### Test Data & Mocks

**Test Data Builders:**
- EventIdTestDataBuilder for creating test event identifiers
- DomainEventTestDataBuilder for creating test domain events
- CompanyTestDataBuilder for testing company-related value objects

**Mock Services:**
- Mock EventBridge client for event publishing tests
- Mock validation responses for external service integration

**Test Containers:**
- LocalStack container for AWS EventBridge simulation during integration tests

## Tasks / Subtasks (TDD Workflow)

- [ ] Task 1: Setup Repository Structure (AC: 5,6,7)
  - [ ] Create shared-kernel repository with Maven structure
  - [ ] Configure build.gradle with Java 21 and Spring Boot 3.2
  - [ ] Setup package structure (types, events, exceptions, utils)
  - [ ] Configure Maven publishing to internal repository

- [ ] Task 2: Write Domain Value Object Tests (RED Phase) (AC: 1)
  - [ ] Write failing tests for EventId value object creation and validation
  - [ ] Write failing tests for SpeakerId, CompanyId, UserId validation
  - [ ] Write failing tests for value object equality and hashcode
  - [ ] Verify all tests fail with meaningful error messages

- [ ] Task 3: Implement Domain Value Objects (GREEN Phase) (AC: 1)
  - [ ] Implement EventId with UUID validation and immutability
  - [ ] Implement SpeakerId with proper validation rules
  - [ ] Implement CompanyId with Swiss UID validation patterns
  - [ ] Implement UserId with Cognito integration patterns
  - [ ] Ensure all tests pass

- [ ] Task 4: Write Domain Event Tests (RED Phase) (AC: 2)
  - [ ] Write failing tests for DomainEvent base class
  - [ ] Write failing tests for EventCreatedEvent serialization
  - [ ] Write failing tests for SpeakerInvitedEvent structure
  - [ ] Write failing tests for event timestamp and metadata

- [ ] Task 5: Implement Domain Events (GREEN Phase) (AC: 2)
  - [ ] Implement DomainEvent abstract base class with metadata
  - [ ] Implement EventCreatedEvent with proper event schema
  - [ ] Implement SpeakerInvitedEvent for speaker workflow integration
  - [ ] Add JSON serialization support for EventBridge publishing

- [ ] Task 6: Write Utility Tests (RED Phase) (AC: 3)
  - [ ] Write failing tests for validation utility methods
  - [ ] Write failing tests for error handling patterns
  - [ ] Write failing tests for logging utility functions
  - [ ] Write failing tests for date/time utility methods

- [ ] Task 7: Implement Common Utilities (GREEN Phase) (AC: 3)
  - [ ] Implement ValidationUtils with Swiss UID validation
  - [ ] Implement ErrorHandlingUtils with consistent error formatting
  - [ ] Implement LoggingUtils with structured logging patterns
  - [ ] Implement DateTimeUtils for consistent timestamp handling

- [ ] Task 8: Write EventBridge Integration Tests (RED Phase) (AC: 4)
  - [ ] Write failing tests for EventBridge publisher configuration
  - [ ] Write failing tests for event publishing and retry logic
  - [ ] Write failing tests for event serialization to EventBridge format
  - [ ] Setup LocalStack test container for AWS integration testing

- [ ] Task 9: Implement EventBridge Integration (GREEN Phase) (AC: 4)
  - [ ] Configure Spring Boot EventBridge auto-configuration
  - [ ] Implement DomainEventPublisher with retry and error handling
  - [ ] Add event schema validation before publishing
  - [ ] Configure EventBridge event routing rules

- [ ] Task 10: Setup CI/CD Pipeline (AC: 8)
  - [ ] Configure GitHub Actions workflow for automated testing
  - [ ] Setup Maven artifact publishing to internal repository
  - [ ] Configure semantic versioning automation
  - [ ] Add build status badges and quality gates

- [ ] Task 11: Documentation and Final Polish (AC: 10,11)
  - [ ] Write comprehensive JavaDoc for all public APIs
  - [ ] Create README with usage examples and integration guide
  - [ ] Document versioning strategy and backward compatibility policies
  - [ ] Create architecture decision records for design choices

- [ ] Task 12: Refactor and Optimize (REFACTOR Phase)
  - [ ] Optimize validation performance for high-volume operations
  - [ ] Extract common patterns into reusable utilities
  - [ ] Improve error messages and exception handling
  - [ ] Verify 90%+ test coverage requirement is met

## Dev Notes - Implementation Guide

### Technical Design Notes

**Core Design Patterns:**
- **Value Object Pattern**: Immutable value objects for domain identifiers with built-in validation
- **Domain Event Pattern**: Events that represent something that happened in the domain
- **Publisher-Subscriber**: EventBridge integration for decoupled cross-service communication
- **Shared Kernel DDD**: Common language and concepts shared across all bounded contexts

**Package Structure (following source-tree.md):**
```
shared-kernel/
├── src/main/java/ch/batbern/shared/
│   ├── types/           # Domain value objects (EventId, SpeakerId, etc.)
│   ├── events/          # Domain events (DomainEvent, EventCreatedEvent, etc.)
│   ├── exceptions/      # Common exceptions (DomainException, ValidationException)
│   ├── utils/           # Utility classes (ValidationUtils, DateTimeUtils)
│   └── config/          # Spring configuration for EventBridge
├── src/test/java/       # Comprehensive test suite
└── build.gradle         # Dependencies and publishing configuration
```

**Service Method Signatures:**
```java
// EventBridge Publisher
public interface DomainEventPublisher {
    void publish(DomainEvent event);
    CompletableFuture<Void> publishAsync(DomainEvent event);
    void publishBatch(List<DomainEvent> events);
}

// Validation Utilities
public class ValidationUtils {
    public static void validateSwissUID(String uid) throws ValidationException;
    public static void validateEmail(String email) throws ValidationException;
    public static void validateRequired(Object value, String fieldName);
}
```

### API Contracts

**Domain Event Schema (EventBridge Format):**
```json
{
  "version": "0",
  "id": "uuid",
  "detail-type": "EventCreatedEvent",
  "source": "batbern.event-management",
  "account": "aws-account-id",
  "time": "2024-12-20T10:00:00Z",
  "region": "eu-central-1",
  "detail": {
    "eventId": "uuid",
    "eventType": "CONFERENCE",
    "title": "BATbern 2024",
    "organizerId": "uuid",
    "createdAt": "2024-12-20T10:00:00Z",
    "metadata": {
      "version": "1.0",
      "source": "event-management-service"
    }
  }
}
```

**Value Object Examples:**
```java
@Value
@Builder
public class EventId {
    @NonNull
    private final UUID id;

    public static EventId generate() {
        return new EventId(UUID.randomUUID());
    }

    public static EventId from(String idString) {
        try {
            return new EventId(UUID.fromString(idString));
        } catch (IllegalArgumentException e) {
            throw new ValidationException("Invalid EventId format: " + idString);
        }
    }
}
```

### Testing Requirements

**Coverage Targets:**
- Unit Tests: 90% for all value objects and utilities
- Integration Tests: 100% for EventBridge publishing
- Overall: 90% line coverage minimum

**Testing Approach:**
- **TDD Mandatory**: Write tests first for all functionality
- **Test Data Builders**: Create builders for complex test objects
- **Contract Testing**: Verify EventBridge event schemas
- **Performance Testing**: Validate event publishing performance under load

**Critical Test Scenarios:**
- Value object validation with valid and invalid inputs
- Domain event serialization/deserialization roundtrip
- EventBridge publishing success and failure scenarios
- Concurrent event publishing performance
- Backward compatibility of serialized events

**Mock Configurations:**
```java
@TestConfiguration
public class SharedKernelTestConfig {
    @Bean
    @Primary
    public EventBridgeAsyncClient mockEventBridgeClient() {
        return Mockito.mock(EventBridgeAsyncClient.class);
    }
}
```

## Definition of Done Checklist

### Development Complete
- [ ] All tests written BEFORE implementation (TDD followed)
- [ ] All acceptance criteria have corresponding tests
- [ ] All acceptance criteria implemented
- [ ] Unit tests written and passing (>90% coverage)
- [ ] Integration tests cover EventBridge functionality (>80% coverage)
- [ ] Performance tests validate event publishing throughput
- [ ] Code follows project conventions (coding-standards.md)
- [ ] TypeScript types properly defined for frontend integration
- [ ] API documentation updated (JavaDoc complete)
- [ ] Semantic versioning strategy implemented

### Infrastructure Complete ⚠️ CRITICAL
- [ ] Maven repository configured for artifact publishing
- [ ] GitHub Actions CI/CD pipeline deployed and tested
- [ ] EventBridge integration configured and tested
- [ ] IAM permissions validated for cross-service access
- [ ] Artifact versioning and distribution working
- [ ] Performance benchmarks meet <10ms event publishing requirement
- [ ] Monitoring and alerting configured for event publishing failures

### Review Ready
- [ ] PR created with detailed description and usage examples
- [ ] Code review completed by architecture team
- [ ] Security review passed for cross-service communication
- [ ] Documentation updated (README, JavaDoc, ADRs)
- [ ] Integration guide created for consuming services
- [ ] Backward compatibility verified with migration strategy

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-20 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Implementation Approach
_To be documented during implementation_

### Debug Log References
_Debug log references to be added during development_

### Completion Notes
_Implementation notes and any deviations from plan_

### Files Changed
_List of all files created, modified, or deleted during implementation_

### Deployment Notes
_Special deployment considerations and rollback procedures_

## QA Results
_QA results to be filled after implementation review_