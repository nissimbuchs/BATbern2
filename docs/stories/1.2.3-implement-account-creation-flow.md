# Story 1.2.3: Implement Account Creation Flow

## Status
Accepted

## Story

**As a** new user,
**I want** to create an account using a simple two-step wizard with multi-language support,
**so that** I can register as an ATTENDEE and access the BATbern platform after email verification.

**Context:** This story implements the Account Creation (User Registration) flow specified in wireframe story-1.2-account-creation.md. This functionality was completely missing from the original Story 1.2 implementation. Per FR22, all self-registered users are created as ATTENDEE; role promotion is handled separately via Story 1.20.

**Dependencies:**
- **BLOCKS: Story 1.2.1 (i18n Foundation)** - Requires react-i18next configuration and translation files
- **BLOCKS: Story 1.2.4 (Email Verification)** - Navigates to email verification after successful registration

## Domain Context

### Primary Domain
- **Shared/Infrastructure** (Authentication & User Registration)

### Involved Services
- **web-frontend** (React registration wizard)
- **API Gateway** (registration request routing)
- **AWS Cognito** (user account creation)
- **AWS SES** (bilingual verification email delivery)

### Cross-Domain Dependencies
- AWS Cognito User Pools (user account creation, email verification)
- AWS SES email templates (bilingual verification emails)

## Requirements Context

### Related Functional Requirements
- **FR1**: Role-based authentication (all self-registered users created as ATTENDEE)
- **FR22**: Event organizers manage user roles with promotion capabilities (users cannot select roles during registration)
- **NFR3**: Integration with AWS Cognito and AWS SES
- **NFR4**: Multi-language support (German/English from MVP launch)

### Related Wireframes
- **Primary**: `docs/wireframes/story-1.2-account-creation.md`
  - 2-step wizard: Personal Information → Review & Confirm
  - Password strength indicator
  - All users created as ATTENDEE (no role selection)
  - Bilingual UI and verification emails
  - T&C checkbox required, newsletter opt-in optional

## Architecture Context

### Architecture Patterns
- **Frontend Architecture** (`docs/architecture/05-frontend-architecture.md`):
  - React 18.2+ with TypeScript
  - Material-UI for wizard stepper and form components
  - React Hook Form for multi-step form state
  - Zustand for wizard state persistence
  - React Query for registration mutation
  - i18next for internationalization (from Story 1.2.1)

### Infrastructure Components
- **AWS Cognito**: `signUp` API for user creation
- **AWS SES**: Bilingual email templates for verification
- **Password Policy**: Min 8 chars, uppercase, lowercase, number
- **Custom Attributes**: `custom:language` (de|en), `custom:role` (ATTENDEE)
- **User Status**: UNCONFIRMED until email verified

## Acceptance Criteria

### Step 1: Personal Information
1. **Full Name Field**: Text input with validation (required, 2-100 chars, letters/spaces/hyphens only)
2. **Email Field**: Email input with format validation (required, valid format, max 255 chars)
3. **Password Field**: Password input with strength indicator and show/hide toggle
4. **Confirm Password Field**: Password confirmation with match validation and show/hide toggle
5. **Password Requirements**: Real-time display of password requirements with checkmarks
6. **Password Strength Indicator**: Color-coded strength meter (weak/medium/strong)
7. **Continue Button**: Validates all fields before proceeding to Step 2
8. **Field Validation**: On blur and real-time after first interaction

### Step 2: Review & Confirmation
9. **Information Summary**: Display entered name and email with Edit link
10. **Edit Link**: Returns to Step 1 with pre-filled values
11. **Terms & Conditions Checkbox**: Required checkbox with link to T&C document
12. **Newsletter Opt-in Checkbox**: Optional checkbox for marketing emails
13. **Back Button**: Returns to Step 1 with values preserved
14. **Create Account Button**: Submits registration to Cognito
15. **Verification Notice**: Information box indicating verification email will be sent

### AWS Cognito Integration
16. **User Creation**: Call Cognito `signUp` with user attributes (name, email, language)
17. **Automatic Role Assignment**: Backend sets `custom:role` to "ATTENDEE" (not user-selectable)
18. **Language Preference**: Store user's selected language in `custom:language` attribute
19. **Email Verification**: Cognito sends verification email in user's selected language
20. **Newsletter Opt-in**: Store newsletter preference in `custom:newsletter_optin` attribute

### Navigation Flow
21. **Success Navigation**: After successful registration, navigate to Email Verification screen (Story 1.2.4)
22. **Browser History**: URL updates with step parameter (`/auth/register?step=2`)
23. **Back to Login Link**: Available on both steps to return to login screen
24. **State Persistence**: Form values preserved across step transitions

### Error Handling
25. **Email Already Exists**: Display error with link to login screen
26. **Weak Password**: Display specific password requirement failures
27. **Password Mismatch**: Display error when passwords don't match
28. **Terms Not Accepted**: Display error when T&C not checked
29. **Network Error**: Display error with retry option
30. **Rate Limiting**: Display error and cooldown for excessive attempts

## Test Specifications (TDD)

### Registration Wizard Tests
**Test Group 1: Step 1 - Personal Information**
- Test 1.1: should_renderStep1_when_pageLoads
- Test 1.2: should_validateFullName_when_invalidInput
- Test 1.3: should_validateEmail_when_invalidFormat
- Test 1.4: should_showPasswordRequirements_when_typing
- Test 1.5: should_updateStrengthIndicator_when_passwordChanges
- Test 1.6: should_validatePasswordMatch_when_confirmTyping
- Test 1.7: should_enableContinueButton_when_allFieldsValid
- Test 1.8: should_disableContinueButton_when_invalidData

### Multi-Step Form Tests
**Test Group 2: Step Transitions**
- Test 2.1: should_transitionToStep2_when_continueClicked
- Test 2.2: should_updateURL_when_stepChanges
- Test 2.3: should_preserveFormData_when_navigatingBack
- Test 2.4: should_returnToStep1_when_editClicked
- Test 2.5: should_displaySummary_when_step2Rendered

### Registration Flow Tests
**Test Group 3: Account Creation**
- Test 3.1: should_callCognitoSignUp_when_createAccountClicked
- Test 3.2: should_setRoleToAttendee_when_userRegisters (FR22)
- Test 3.3: should_storeLanguagePreference_when_registered
- Test 3.4: should_storeNewsletterOptIn_when_checkboxChecked
- Test 3.5: should_navigateToVerification_when_registrationSuccessful
- Test 3.6: should_sendVerificationEmail_when_accountCreated

### Error Handling Tests
**Test Group 4: Error Scenarios**
- Test 4.1: should_displayError_when_emailAlreadyExists
- Test 4.2: should_highlightFields_when_passwordWeak
- Test 4.3: should_showError_when_passwordMismatch
- Test 4.4: should_requireTerms_when_submittingWithoutCheckbox
- Test 4.5: should_displayNetworkError_when_requestFails

### Internationalization Tests
**Test Group 5: i18n**
- Test 5.1: should_displayGermanText_when_languageIsGerman
- Test 5.2: should_displayEnglishText_when_languageIsEnglish
- Test 5.3: should_localizeErrors_when_validationFails
- Test 5.4: should_sendGermanEmail_when_userLanguageIsGerman
- Test 5.5: should_sendEnglishEmail_when_userLanguageIsEnglish

### Test File Locations
**Frontend Tests:**
- `web-frontend/src/components/auth/RegistrationWizard/RegistrationWizard.test.tsx`
- `web-frontend/src/components/auth/RegistrationStep1/RegistrationStep1.test.tsx`
- `web-frontend/src/components/auth/RegistrationStep2/RegistrationStep2.test.tsx`
- `web-frontend/src/hooks/useRegistration/useRegistration.test.ts`
- `web-frontend/src/utils/passwordStrength/passwordStrength.test.ts`

**Backend Tests:**
- `api-gateway/src/test/integration/auth/RegistrationTest.java`
- `api-gateway/src/test/unit/auth/RegistrationServiceTest.java`

**E2E Tests:**
- `e2e/auth/registration.spec.ts`
- `e2e/auth/registration-i18n.spec.ts`

## Tasks / Subtasks (TDD Workflow)

### Task 1: Backend API Endpoint (RED Phase)
- [ ] Write failing integration test for `/api/v1/auth/register` endpoint
- [ ] Write failing test for Cognito `signUp` integration
- [ ] Write failing test for automatic ATTENDEE role assignment (FR22)
- [ ] Write failing test for language preference storage
- [ ] Write failing test for duplicate email error handling
- [ ] Write failing test for password policy enforcement

### Task 2: Backend Implementation (GREEN Phase)
- [ ] Create RegistrationRequest DTO with validation
- [ ] Implement POST /api/v1/auth/register endpoint
- [ ] Integrate with AWS Cognito SDK `signUp` method
- [ ] Force `custom:role` to "ATTENDEE" (ignore any user-provided role)
- [ ] Store `custom:language` from user selection
- [ ] Store `custom:newsletter_optin` from checkbox
- [ ] Add rate limiting (5 attempts per IP per hour)
- [ ] Verify all backend tests pass

### Task 3: Password Strength Utility (RED Phase)
- [ ] Write failing tests for password strength calculation
- [ ] Write failing tests for requirement checking (uppercase, lowercase, number)
- [ ] Write failing tests for strength indicator levels (weak/medium/strong)

### Task 4: Implement Password Strength Utility (GREEN Phase)
- [ ] Create passwordStrength.ts utility
- [ ] Implement requirement checks
- [ ] Calculate overall strength score
- [ ] Return strength level and unmet requirements
- [ ] Verify utility tests pass

### Task 5: Step 1 Component (RED Phase)
- [ ] Write failing tests for RegistrationStep1 component
- [ ] Write failing tests for field validation
- [ ] Write failing tests for password strength indicator
- [ ] Write failing tests for password match validation
- [ ] Write failing tests for Continue button state

### Task 6: Implement Step 1 Component (GREEN Phase)
- [ ] Create RegistrationStep1 component with Material-UI
- [ ] Implement all form fields with React Hook Form
- [ ] Add real-time password strength indicator
- [ ] Add password requirement checklist
- [ ] Implement password show/hide toggles
- [ ] Add field validation with localized error messages
- [ ] Verify Step 1 tests pass

### Task 7: Step 2 Component (RED Phase)
- [ ] Write failing tests for RegistrationStep2 component
- [ ] Write failing tests for information summary display
- [ ] Write failing tests for Edit link functionality
- [ ] Write failing tests for T&C checkbox requirement
- [ ] Write failing tests for Create Account button

### Task 8: Implement Step 2 Component (GREEN Phase)
- [ ] Create RegistrationStep2 component
- [ ] Display name and email summary
- [ ] Implement Edit link navigation
- [ ] Add T&C checkbox with validation
- [ ] Add newsletter opt-in checkbox
- [ ] Implement Create Account submission
- [ ] Verify Step 2 tests pass

### Task 9: Registration Wizard (RED Phase)
- [ ] Write failing tests for RegistrationWizard orchestration
- [ ] Write failing tests for step transitions
- [ ] Write failing tests for URL parameter updates
- [ ] Write failing tests for state persistence
- [ ] Write failing tests for navigation to verification screen

### Task 10: Implement Registration Wizard (GREEN Phase)
- [ ] Create RegistrationWizard parent component
- [ ] Implement wizard state management with Zustand
- [ ] Add step navigation logic
- [ ] Synchronize URL with current step
- [ ] Implement useRegistration hook with React Query
- [ ] Add success navigation to Email Verification screen
- [ ] Verify wizard tests pass

### Task 11: Error Handling (GREEN Phase)
- [ ] Implement email exists error display
- [ ] Implement password validation error display
- [ ] Implement terms not accepted error
- [ ] Implement network error with retry
- [ ] Add rate limit error with cooldown

### Task 12: Internationalization (GREEN Phase)
- [ ] Add all translation keys to auth.json (register namespace)
- [ ] Translate password requirements
- [ ] Translate validation messages
- [ ] Translate step titles and instructions
- [ ] Test language switching during registration

### Task 13: E2E Testing (REFACTOR Phase)
- [ ] Create E2E test for complete registration flow
- [ ] Test all validation scenarios
- [ ] Verify navigation to email verification
- [ ] Test bilingual flow (German and English)
- [ ] Verify AWS Cognito user creation
- [ ] Run accessibility audit

### Task 14: Documentation
- [ ] Document registration API endpoint in OpenAPI spec
- [ ] Update README with registration flow
- [ ] Document FR22 implementation (ATTENDEE-only registration)
- [ ] Document password requirements
- [ ] Add troubleshooting guide

## Dev Notes - Implementation Guide

### Backend API Implementation

**`api-gateway/src/main/java/ch/batbern/api/auth/dto/RegistrationRequest.java`:**
```java
public class RegistrationRequest {
    @NotBlank(message = "Full name is required")
    @Size(min = 2, max = 100, message = "Name must be between 2 and 100 characters")
    @Pattern(regexp = "^[a-zA-ZÄäÖöÜüß\\s-]+$", message = "Name contains invalid characters")
    private String fullName;

    @NotBlank(message = "Email is required")
    @Email(message = "Invalid email format")
    @Size(max = 255, message = "Email too long")
    private String email;

    @NotBlank(message = "Password is required")
    @Size(min = 8, max = 128, message = "Password must be between 8 and 128 characters")
    private String password;

    @NotNull(message = "Language preference is required")
    @Pattern(regexp = "^(de|en)$", message = "Language must be 'de' or 'en'")
    private String language;

    @NotNull(message = "Terms acceptance is required")
    private Boolean agreedToTerms;

    private Boolean newsletterOptIn = false;

    // Note: NO role field - always ATTENDEE per FR22
    // Getters/setters
}
```

**`api-gateway/src/main/java/ch/batbern/api/auth/service/RegistrationService.java`:**
```java
@Service
public class RegistrationService {

    @Autowired
    private AWSCognitoIdentityProvider cognitoClient;

    @Autowired
    private RateLimitService rateLimitService;

    public RegistrationResponse register(RegistrationRequest request) {
        // Check rate limit (5 per IP per hour)
        if (!rateLimitService.allowRegistration(getCurrentIP())) {
            throw new RateLimitExceededException("Too many registration attempts. Try again later.");
        }

        // Build Cognito user attributes
        List<AttributeType> attributes = Arrays.asList(
            new AttributeType().withName("email").withValue(request.getEmail()),
            new AttributeType().withName("name").withValue(request.getFullName()),
            new AttributeType().withName("custom:role").withValue("ATTENDEE"),  // FR22: Always ATTENDEE
            new AttributeType().withName("custom:language").withValue(request.getLanguage()),
            new AttributeType().withName("custom:newsletter_optin").withValue(request.getNewsletterOptIn().toString())
        );

        // Create Cognito user
        SignUpRequest signUpRequest = new SignUpRequest()
            .withClientId(cognitoClientId)
            .withUsername(request.getEmail())
            .withPassword(request.getPassword())
            .withUserAttributes(attributes);

        try {
            SignUpResult result = cognitoClient.signUp(signUpRequest);

            // Log registration
            securityLogger.logRegistration(request.getEmail(), "SUCCESS", "ATTENDEE");

            return new RegistrationResponse(
                true,
                result.getUserSub(),
                request.getEmail(),
                "ATTENDEE",
                request.getLanguage(),
                true,  // requiresVerification
                "Account created successfully. Please check your email for verification."
            );

        } catch (UsernameExistsException e) {
            securityLogger.logRegistration(request.getEmail(), "EMAIL_EXISTS", null);
            throw new EmailAlreadyExistsException("An account with this email already exists.");
        } catch (InvalidPasswordException e) {
            throw new WeakPasswordException("Password does not meet security requirements.");
        } catch (Exception e) {
            securityLogger.logRegistration(request.getEmail(), "FAILURE", null);
            throw new RegistrationException("Failed to create account", e);
        }
    }
}
```

### Frontend Password Strength Utility

**`src/utils/passwordStrength.ts`:**
```typescript
export interface PasswordRequirements {
  minLength: boolean;
  hasUppercase: boolean;
  hasLowercase: boolean;
  hasNumber: boolean;
  hasSpecialChar: boolean;
}

export type PasswordStrength = 'weak' | 'medium' | 'strong';

export const checkPasswordRequirements = (password: string): PasswordRequirements => {
  return {
    minLength: password.length >= 8,
    hasUppercase: /[A-Z]/.test(password),
    hasLowercase: /[a-z]/.test(password),
    hasNumber: /[0-9]/.test(password),
    hasSpecialChar: /[!@#$%^&*(),.?":{}|<>]/.test(password)
  };
};

export const calculatePasswordStrength = (password: string): PasswordStrength => {
  const requirements = checkPasswordRequirements(password);

  const score = [
    requirements.minLength,
    requirements.hasUppercase,
    requirements.hasLowercase,
    requirements.hasNumber,
    requirements.hasSpecialChar
  ].filter(Boolean).length;

  if (score <= 3) return 'weak';
  if (score === 4) return 'medium';
  return 'strong';
};
```

### Frontend Translation Keys

**`public/locales/de/auth.json` (add to existing):**
```json
{
  "register": {
    "title": "Konto erstellen",
    "subtitle": "Werden Sie Teil der BATbern-Community",
    "step1": {
      "title": "Schritt 1 von 2: Persönliche Informationen",
      "fullNameLabel": "Vollständiger Name",
      "fullNamePlaceholder": "Max Mustermann",
      "emailLabel": "E-Mail-Adresse",
      "emailPlaceholder": "max.mustermann@beispiel.ch",
      "passwordLabel": "Passwort",
      "passwordPlaceholder": "Sicheres Passwort eingeben",
      "confirmPasswordLabel": "Passwort bestätigen",
      "confirmPasswordPlaceholder": "Passwort erneut eingeben",
      "continueButton": "Weiter zur Bestätigung"
    },
    "passwordRequirements": {
      "title": "Passwortanforderungen:",
      "minLength": "Mindestens 8 Zeichen",
      "hasUppercase": "Groß- und Kleinbuchstaben",
      "hasNumber": "Mindestens eine Zahl"
    },
    "passwordStrength": {
      "weak": "Schwach",
      "medium": "Mittel",
      "strong": "Stark"
    },
    "step2": {
      "title": "Schritt 2 von 2: Überprüfen & Bestätigen",
      "reviewTitle": "Überprüfen Sie Ihre Angaben:",
      "nameLabel": "Name:",
      "emailLabel": "E-Mail:",
      "editButton": "Bearbeiten",
      "termsLabel": "Ich stimme den Nutzungsbedingungen und Datenschutzrichtlinien zu",
      "newsletterLabel": "Ich möchte Event-Updates und Newsletter erhalten (optional)",
      "backButton": "Zurück",
      "submitButton": "Konto erstellen",
      "verificationNotice": "Sie erhalten eine Bestätigungs-E-Mail an {{email}}"
    },
    "success": "Konto erfolgreich erstellt! Bitte überprüfen Sie Ihre E-Mail.",
    "errors": {
      "fullNameRequired": "Name ist erforderlich",
      "fullNameTooShort": "Name muss mindestens 2 Zeichen lang sein",
      "fullNameInvalid": "Name enthält ungültige Zeichen",
      "emailRequired": "E-Mail ist erforderlich",
      "emailInvalid": "Bitte geben Sie eine gültige E-Mail ein",
      "emailExists": "Ein Konto mit dieser E-Mail existiert bereits.",
      "passwordRequired": "Passwort ist erforderlich",
      "passwordTooShort": "Passwort muss mindestens 8 Zeichen lang sein",
      "passwordMismatch": "Passwörter stimmen nicht überein",
      "termsRequired": "Sie müssen den Nutzungsbedingungen zustimmen",
      "networkError": "Verbindungsfehler. Bitte versuchen Sie es erneut.",
      "rateLimitExceeded": "Zu viele Versuche. Bitte warten Sie 15 Minuten."
    }
  }
}
```

### Frontend Step 1 Component

**`src/components/auth/RegistrationStep1/RegistrationStep1.tsx`:**
```typescript
import React, { useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useFormContext } from 'react-hook-form';
import {
  Box,
  TextField,
  IconButton,
  InputAdornment,
  Typography,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  LinearProgress
} from '@mui/material';
import { Visibility, VisibilityOff, CheckCircle, RadioButtonUnchecked } from '@mui/icons-material';
import { checkPasswordRequirements, calculatePasswordStrength } from '@/utils/passwordStrength';

interface RegistrationStep1Props {
  onContinue: () => void;
}

const RegistrationStep1: React.FC<RegistrationStep1Props> = ({ onContinue }) => {
  const { t } = useTranslation('auth');
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  const {
    register,
    watch,
    formState: { errors },
    trigger
  } = useFormContext();

  const password = watch('password', '');
  const requirements = checkPasswordRequirements(password);
  const strength = calculatePasswordStrength(password);

  const handleContinue = async () => {
    const isValid = await trigger(['fullName', 'email', 'password', 'confirmPassword']);
    if (isValid) {
      onContinue();
    }
  };

  const getStrengthColor = () => {
    switch (strength) {
      case 'weak': return 'error';
      case 'medium': return 'warning';
      case 'strong': return 'success';
    }
  };

  return (
    <Box>
      <Typography variant="h5" gutterBottom>
        {t('register.step1.title')}
      </Typography>

      <TextField
        {...register('fullName', {
          required: t('register.errors.fullNameRequired'),
          minLength: {
            value: 2,
            message: t('register.errors.fullNameTooShort')
          },
          pattern: {
            value: /^[a-zA-ZÄäÖöÜüß\s-]+$/,
            message: t('register.errors.fullNameInvalid')
          }
        })}
        label={t('register.step1.fullNameLabel')}
        placeholder={t('register.step1.fullNamePlaceholder')}
        fullWidth
        margin="normal"
        error={!!errors.fullName}
        helperText={errors.fullName?.message}
      />

      <TextField
        {...register('email', {
          required: t('register.errors.emailRequired'),
          pattern: {
            value: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            message: t('register.errors.emailInvalid')
          }
        })}
        label={t('register.step1.emailLabel')}
        placeholder={t('register.step1.emailPlaceholder')}
        type="email"
        fullWidth
        margin="normal"
        error={!!errors.email}
        helperText={errors.email?.message}
      />

      <TextField
        {...register('password', {
          required: t('register.errors.passwordRequired'),
          minLength: {
            value: 8,
            message: t('register.errors.passwordTooShort')
          }
        })}
        label={t('register.step1.passwordLabel')}
        placeholder={t('register.step1.passwordPlaceholder')}
        type={showPassword ? 'text' : 'password'}
        fullWidth
        margin="normal"
        error={!!errors.password}
        helperText={errors.password?.message}
        InputProps={{
          endAdornment: (
            <InputAdornment position="end">
              <IconButton onClick={() => setShowPassword(!showPassword)} edge="end">
                {showPassword ? <VisibilityOff /> : <Visibility />}
              </IconButton>
            </InputAdornment>
          )
        }}
      />

      {password && (
        <Box sx={{ mt: 1, mb: 2 }}>
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 1 }}>
            <Typography variant="body2">
              {t(`register.passwordStrength.${strength}`)}
            </Typography>
            <LinearProgress
              variant="determinate"
              value={strength === 'weak' ? 33 : strength === 'medium' ? 66 : 100}
              color={getStrengthColor()}
              sx={{ flex: 1 }}
            />
          </Box>

          <Typography variant="caption" color="text.secondary">
            {t('register.passwordRequirements.title')}
          </Typography>
          <List dense>
            <ListItem>
              <ListItemIcon>
                {requirements.minLength ? <CheckCircle color="success" /> : <RadioButtonUnchecked />}
              </ListItemIcon>
              <ListItemText primary={t('register.passwordRequirements.minLength')} />
            </ListItem>
            <ListItem>
              <ListItemIcon>
                {requirements.hasUppercase && requirements.hasLowercase ? <CheckCircle color="success" /> : <RadioButtonUnchecked />}
              </ListItemIcon>
              <ListItemText primary={t('register.passwordRequirements.hasUppercase')} />
            </ListItem>
            <ListItem>
              <ListItemIcon>
                {requirements.hasNumber ? <CheckCircle color="success" /> : <RadioButtonUnchecked />}
              </ListItemIcon>
              <ListItemText primary={t('register.passwordRequirements.hasNumber')} />
            </ListItem>
          </List>
        </Box>
      )}

      <TextField
        {...register('confirmPassword', {
          required: t('register.errors.passwordRequired'),
          validate: (value) =>
            value === password || t('register.errors.passwordMismatch')
        })}
        label={t('register.step1.confirmPasswordLabel')}
        placeholder={t('register.step1.confirmPasswordPlaceholder')}
        type={showConfirmPassword ? 'text' : 'password'}
        fullWidth
        margin="normal"
        error={!!errors.confirmPassword}
        helperText={errors.confirmPassword?.message}
        InputProps={{
          endAdornment: (
            <InputAdornment position="end">
              <IconButton onClick={() => setShowConfirmPassword(!showConfirmPassword)} edge="end">
                {showConfirmPassword ? <VisibilityOff /> : <Visibility />}
              </IconButton>
            </InputAdornment>
          )
        }}
      />

      <Button
        variant="contained"
        fullWidth
        size="large"
        onClick={handleContinue}
        sx={{ mt: 3 }}
      >
        {t('register.step1.continueButton')}
      </Button>
    </Box>
  );
};

export default RegistrationStep1;
```

### Registration Wizard Orchestration

**`src/components/auth/RegistrationWizard/RegistrationWizard.tsx`:**
```typescript
import React, { useState } from 'react';
import { useForm, FormProvider } from 'react-hook-form';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { Box, Stepper, Step, StepLabel } from '@mui/material';
import { useTranslation } from 'react-i18next';
import RegistrationStep1 from '../RegistrationStep1/RegistrationStep1';
import RegistrationStep2 from '../RegistrationStep2/RegistrationStep2';
import { useRegistration } from '@/hooks/useRegistration';

const RegistrationWizard: React.FC = () => {
  const { t, i18n } = useTranslation('auth');
  const navigate = useNavigate();
  const [searchParams, setSearchParams] = useSearchParams();
  const currentStep = parseInt(searchParams.get('step') || '1', 10);

  const methods = useForm({
    defaultValues: {
      fullName: '',
      email: '',
      password: '',
      confirmPassword: '',
      language: i18n.language,
      agreedToTerms: false,
      newsletterOptIn: false
    }
  });

  const { mutate: register, isLoading, error } = useRegistration();

  const handleStepChange = (step: number) => {
    setSearchParams({ step: step.toString() });
  };

  const handleSubmit = (data: any) => {
    register(data, {
      onSuccess: (response) => {
        // Navigate to email verification screen
        navigate(`/auth/verify-email?email=${encodeURIComponent(response.email)}`);
      }
    });
  };

  const steps = [
    t('register.step1.title'),
    t('register.step2.title')
  ];

  return (
    <Box sx={{ maxWidth: 600, mx: 'auto', mt: 4 }}>
      <Stepper activeStep={currentStep - 1} sx={{ mb: 4 }}>
        {steps.map((label, index) => (
          <Step key={index}>
            <StepLabel>{label}</StepLabel>
          </Step>
        ))}
      </Stepper>

      <FormProvider {...methods}>
        {currentStep === 1 && (
          <RegistrationStep1 onContinue={() => handleStepChange(2)} />
        )}
        {currentStep === 2 && (
          <RegistrationStep2
            onBack={() => handleStepChange(1)}
            onSubmit={methods.handleSubmit(handleSubmit)}
            isLoading={isLoading}
            error={error}
          />
        )}
      </FormProvider>
    </Box>
  );
};

export default RegistrationWizard;
```

## Definition of Done Checklist

### Backend Complete
- [ ] POST /api/v1/auth/register endpoint implemented
- [ ] AWS Cognito signUp integration working
- [ ] FR22 enforced: All users created as ATTENDEE (role hardcoded in backend)
- [ ] Language preference stored in Cognito `custom:language` attribute
- [ ] Newsletter opt-in stored in Cognito attribute
- [ ] Duplicate email error handling implemented
- [ ] Password policy enforcement working
- [ ] Rate limiting enforced (5 attempts per IP per hour)

### Frontend Complete
- [ ] 2-step registration wizard with stepper indicator
- [ ] Step 1: All form fields with validation
- [ ] Password strength indicator with real-time feedback
- [ ] Password requirement checklist
- [ ] Step 2: Information summary with Edit link
- [ ] T&C checkbox required for submission
- [ ] Newsletter opt-in checkbox (optional)
- [ ] All UI text using i18n translation keys
- [ ] URL synchronization with step parameter

### Integration Complete
- [ ] Registration flow works end-to-end
- [ ] Navigation to Email Verification screen after success
- [ ] Bilingual verification emails sent (test in dev environment)
- [ ] All users created as ATTENDEE in Cognito
- [ ] Language preference persisted correctly
- [ ] Error handling for all scenarios

### Testing Complete
- [ ] All unit tests passing (>90% coverage)
- [ ] Integration tests verify Cognito integration
- [ ] E2E test covers complete registration flow
- [ ] FR22 verified: No user can select role during registration
- [ ] Accessibility audit score >90 (WCAG 2.1 AA)

### Documentation Complete
- [ ] API endpoint documented in OpenAPI spec
- [ ] FR22 implementation documented
- [ ] Password requirements documented
- [ ] Registration flow documented in README
- [ ] Troubleshooting guide created

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation for Story 1.2 corrective work | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated during implementation*

### Implementation Approach
*To be populated during implementation*

### Files Changed
*To be populated during implementation*

**Created:**
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/dto/RegistrationRequest.java`
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/dto/RegistrationResponse.java`
- [ ] Backend: `api-gateway/src/main/java/ch/batbern/api/auth/service/RegistrationService.java`
- [ ] Frontend: `src/components/auth/RegistrationWizard/RegistrationWizard.tsx`
- [ ] Frontend: `src/components/auth/RegistrationStep1/RegistrationStep1.tsx`
- [ ] Frontend: `src/components/auth/RegistrationStep2/RegistrationStep2.tsx`
- [ ] Frontend: `src/hooks/useRegistration.ts`
- [ ] Frontend: `src/utils/passwordStrength.ts`

**Modified:**
- [ ] `api-gateway/src/main/java/ch/batbern/api/auth/controller/AuthController.java`
- [ ] `public/locales/de/auth.json`
- [ ] `public/locales/en/auth.json`
- [ ] `web-frontend/src/App.tsx` - Add registration route
