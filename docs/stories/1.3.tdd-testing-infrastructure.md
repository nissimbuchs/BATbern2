# Story 1.3: TDD Testing Infrastructure

## Status
Draft

## Story
**As a** developer,
**I want** comprehensive testing infrastructure and utilities following TDD practices,
**so that** I can efficiently write tests before implementation and maintain high code quality.

## Domain Context

### Primary Domain
Shared Infrastructure & Core Services - Testing foundation for all development

### Involved Services
- Test Infrastructure (new repository/module)
- All Domain Services (as consumers of test utilities)
- CI/CD Pipeline (GitHub Actions integration)
- Shared Kernel (dependency for domain test builders)

### Cross-Domain Dependencies
- **Depends on**: Story 1.1 (Shared Kernel) for domain types and test builders
- **Enables**: All subsequent development stories requiring comprehensive testing
- **Integration**: Used by Event Management, Speaker Coordination, Partner Analytics, and Attendee Experience services

## Requirements Context

### Related Functional Requirements
- **Testing Foundation**: Enables TDD practices for all functional requirements (FR1-FR21)
- **Quality Assurance**: Supports 85% minimum coverage requirement across all domains
- **CI/CD Integration**: Automated testing for deployment pipeline reliability

### Workflow Steps (if applicable)
N/A - This is testing infrastructure foundation

### Acceptance Criteria Source
Epic 1, Story 1.3 - Complete acceptance criteria as defined in epic

## Architecture Context

### Architecture Patterns
**Referenced from architecture documentation:**
- **Test-Driven Development** [Source: architecture/coding-standards.md#tdd]: Red-Green-Refactor workflow with test-first practices
- **Test Data Builder Pattern** [Source: architecture/coding-standards.md#test-data]: Fluent API for creating test objects with realistic data
- **Custom Assertions** [Source: architecture/coding-standards.md#testing]: Domain-specific assertions for business logic validation
- **Testcontainers Pattern** [Source: architecture/tech-stack.md#testing]: Real database and AWS service testing with containers

### Infrastructure Components
**From 02-infrastructure-deployment.md and tech-stack.md:**
- **JUnit 5**: Modern Java testing framework with parameterized tests
- **Vitest**: Fast TypeScript testing with native ESM support
- **React Testing Library**: Component testing with user behavior focus
- **Testcontainers**: PostgreSQL, Redis, LocalStack containers for integration testing
- **JaCoCo & NYC**: Code coverage tools with unified reporting
- **GitHub Actions**: CI/CD pipeline with automated test execution and coverage gates

## Wireframe Context

### Wireframe References
N/A - Testing infrastructure component with no direct UI

### UI Components
**Testing-related components:**
- Test reporting dashboards (coverage, metrics)
- Test execution status in CI/CD pipeline
- Developer tooling integration (IDE test runners)

## Acceptance Criteria

1. **Test Data Builders**: Create builder pattern implementations for all domain entities (Event, Speaker, Company, User) with fluent APIs
2. **Test Fixtures**: Establish reusable test fixtures for common scenarios (valid/invalid data, edge cases)
3. **Database Seeders**: Implement database seeding utilities for integration tests with consistent test data
4. **Test Factories**: Create factory methods for generating test objects with realistic data
5. **Custom Assertions**: Develop domain-specific assertions for validation rules and business logic
6. **Mock Service Clients**: Create mock implementations for all external service dependencies (AWS services, microservices)
7. **Test Container Configurations**: Setup Testcontainers for PostgreSQL, Redis, LocalStack (AWS services)
8. **Test Helper Functions**: Common utilities for authentication, API calls, and data validation
9. **Coverage Tools**: Integrate JaCoCo for Java, NYC for TypeScript with unified reporting
10. **Coverage Gates**: Configure minimum coverage thresholds (85% overall, 90% for business logic)
11. **PR Integration**: Automatic coverage reports on pull requests with delta analysis
12. **Test Metrics Dashboard**: Create dashboard showing test counts, coverage trends, and failure rates

## Test Specifications (TDD)

### Test Scenarios by Acceptance Criteria

**AC1 Tests (Test Data Builders):**
- Test 1.1: should_buildValidEvent_when_eventBuilderUsed
- Test 1.2: should_buildValidSpeaker_when_speakerBuilderUsed
- Test 1.3: should_buildValidCompany_when_companyBuilderUsed
- Test 1.4: should_buildValidUser_when_userBuilderUsed
- Test 1.5: should_chainBuilderMethods_when_fluentAPIUsed

**AC2 Tests (Test Fixtures):**
- Test 2.1: should_loadValidTestFixture_when_commonScenarioRequested
- Test 2.2: should_loadInvalidTestFixture_when_errorScenarioRequested
- Test 2.3: should_loadEdgeCaseFixture_when_boundaryTestingNeeded
- Test 2.4: should_refreshFixtureData_when_testDataExpires

**AC5 Tests (Custom Assertions):**
- Test 5.1: should_assertEventValidation_when_customAssertionUsed
- Test 5.2: should_assertSpeakerStatus_when_domainAssertionCalled
- Test 5.3: should_assertCompanyUID_when_swissValidationNeeded
- Test 5.4: should_provideDetailedFailureMessage_when_assertionFails

**AC7 Tests (Test Containers):**
- Test 7.1: should_startPostgreSQLContainer_when_databaseTestsRun
- Test 7.2: should_startRedisContainer_when_cachingTestsRun
- Test 7.3: should_startLocalStackContainer_when_awsTestsRun
- Test 7.4: should_containerStartupComplete_when_withinTenSeconds

**AC9 Tests (Coverage Tools):**
- Test 9.1: should_generateJavaCodeCoverage_when_jacocoConfigured
- Test 9.2: should_generateTypeScriptCoverage_when_nycConfigured
- Test 9.3: should_unifyReports_when_bothLanguagesUsed
- Test 9.4: should_exportCoverageData_when_ciPipelineRuns

### Test File Locations

**Test Infrastructure Module:**
- `test-infrastructure/src/main/java/ch/batbern/test/builders/`
- `test-infrastructure/src/main/java/ch/batbern/test/fixtures/`
- `test-infrastructure/src/main/java/ch/batbern/test/assertions/`
- `test-infrastructure/src/main/java/ch/batbern/test/containers/`
- `test-infrastructure/src/main/java/ch/batbern/test/utils/`

**Frontend Test Utilities:**
- `test-infrastructure/frontend/builders/`
- `test-infrastructure/frontend/fixtures/`
- `test-infrastructure/frontend/assertions/`
- `test-infrastructure/frontend/mocks/`

**Configuration Tests:**
- `test-infrastructure/src/test/unit/builders/EventTestDataBuilderTest.java`
- `test-infrastructure/src/test/integration/containers/TestContainerConfigTest.java`
- `test-infrastructure/frontend/src/test/builders/userBuilder.test.ts`

### Test Data & Mocks

**Test Data Builders:**
- EventTestDataBuilder for creating realistic conference events
- SpeakerTestDataBuilder for creating speaker profiles with submissions
- CompanyTestDataBuilder for creating partner and attendee companies
- UserTestDataBuilder for creating users with different roles and permissions

**Mock Services:**
- MockCognitoClient for authentication testing
- MockEventBridgeClient for domain event testing
- MockS3Client for file storage testing
- MockEmailService for notification testing

**Test Containers:**
- PostgreSQL 15 container with optimized startup configuration
- Redis 7.2 container for caching tests
- LocalStack container for complete AWS service simulation

## Tasks / Subtasks (TDD Workflow)

- [ ] Task 1: Test Infrastructure Module Setup (AC: Infrastructure)
  - [ ] Create test-infrastructure module with Maven/Gradle configuration
  - [ ] Setup package structure for builders, fixtures, assertions, containers
  - [ ] Configure dependencies (JUnit 5, Testcontainers, Mockito)
  - [ ] Setup build configuration for artifact publishing

- [ ] Task 2: Test Data Builder Tests (RED Phase) (AC: 1)
  - [ ] Write failing tests for EventTestDataBuilder fluent API
  - [ ] Write failing tests for SpeakerTestDataBuilder with realistic data
  - [ ] Write failing tests for CompanyTestDataBuilder with Swiss UID
  - [ ] Write failing tests for UserTestDataBuilder with role assignments
  - [ ] Verify all builder tests fail with meaningful errors

- [ ] Task 3: Test Data Builder Implementation (GREEN Phase) (AC: 1)
  - [ ] Implement EventTestDataBuilder with fluent API and validation
  - [ ] Implement SpeakerTestDataBuilder with realistic speaker data
  - [ ] Implement CompanyTestDataBuilder with Swiss company validation
  - [ ] Implement UserTestDataBuilder with role-based configurations
  - [ ] Ensure all builder tests pass with full fluent API support

- [ ] Task 4: Test Fixtures Tests (RED Phase) (AC: 2,4)
  - [ ] Write failing tests for fixture loading and management
  - [ ] Write failing tests for valid/invalid data scenario fixtures
  - [ ] Write failing tests for edge case and boundary fixtures
  - [ ] Write failing tests for fixture factory methods

- [ ] Task 5: Test Fixtures Implementation (GREEN Phase) (AC: 2,4)
  - [ ] Implement FixtureLoader for JSON-based test data management
  - [ ] Create comprehensive fixtures for valid business scenarios
  - [ ] Create error scenario fixtures for exception testing
  - [ ] Implement TestDataFactory for generating realistic test objects

- [ ] Task 6: Database Seeder Tests (RED Phase) (AC: 3)
  - [ ] Write failing tests for database seeding utilities
  - [ ] Write failing tests for consistent test data generation
  - [ ] Write failing tests for database cleanup between tests
  - [ ] Write failing tests for referential integrity in test data

- [ ] Task 7: Database Seeder Implementation (GREEN Phase) (AC: 3)
  - [ ] Implement DatabaseSeeder for consistent integration test data
  - [ ] Create domain-specific seeders for events, speakers, companies
  - [ ] Implement cleanup utilities for test isolation
  - [ ] Add referential integrity validation for seeded data

- [ ] Task 8: Custom Assertions Tests (RED Phase) (AC: 5)
  - [ ] Write failing tests for domain-specific assertion methods
  - [ ] Write failing tests for business rule validation assertions
  - [ ] Write failing tests for detailed failure message generation
  - [ ] Write failing tests for fluent assertion chaining

- [ ] Task 9: Custom Assertions Implementation (GREEN Phase) (AC: 5)
  - [ ] Implement EventAssertions for event validation
  - [ ] Implement SpeakerAssertions for speaker business rules
  - [ ] Implement CompanyAssertions for Swiss UID validation
  - [ ] Implement ValidationAssertions for common validation scenarios

- [ ] Task 10: Mock Service Tests (RED Phase) (AC: 6)
  - [ ] Write failing tests for AWS service mock implementations
  - [ ] Write failing tests for microservice mock clients
  - [ ] Write failing tests for realistic response simulation
  - [ ] Write failing tests for error scenario simulation

- [ ] Task 11: Mock Service Implementation (GREEN Phase) (AC: 6)
  - [ ] Implement MockCognitoClient with realistic authentication flows
  - [ ] Implement MockEventBridgeClient for domain event testing
  - [ ] Implement MockS3Client for file upload/download testing
  - [ ] Implement MockEmailService for notification testing

- [ ] Task 12: Test Container Tests (RED Phase) (AC: 7)
  - [ ] Write failing tests for PostgreSQL container configuration
  - [ ] Write failing tests for Redis container setup
  - [ ] Write failing tests for LocalStack AWS service containers
  - [ ] Write failing tests for container startup performance (<10s)

- [ ] Task 13: Test Container Implementation (GREEN Phase) (AC: 7)
  - [ ] Configure optimized PostgreSQL Testcontainer with proper schema
  - [ ] Configure Redis Testcontainer for caching integration tests
  - [ ] Configure LocalStack container for AWS service testing
  - [ ] Optimize container startup times and resource usage

- [ ] Task 14: Test Helper Functions (AC: 8)
  - [ ] Implement AuthenticationTestHelper for role-based testing
  - [ ] Implement APITestHelper for REST endpoint testing
  - [ ] Implement DataValidationHelper for business rule testing
  - [ ] Implement PerformanceTestHelper for timing and metrics

- [ ] Task 15: Coverage Tools Integration (AC: 9,10,11)
  - [ ] Configure JaCoCo for Java code coverage with proper excludes
  - [ ] Configure NYC for TypeScript coverage with test reporting
  - [ ] Implement unified coverage reporting across languages
  - [ ] Configure coverage gates for CI/CD pipeline integration

- [ ] Task 16: Test Metrics Dashboard (AC: 12)
  - [ ] Create test execution metrics collection
  - [ ] Implement coverage trend analysis and reporting
  - [ ] Create failure rate tracking and alerting
  - [ ] Integrate metrics with monitoring dashboard

- [ ] Task 17: Frontend Test Utilities
  - [ ] Implement React component test builders
  - [ ] Create user interaction test helpers
  - [ ] Implement API mocking utilities for frontend tests
  - [ ] Configure Vitest with optimized configuration

- [ ] Task 18: Refactor and Optimize (REFACTOR Phase)
  - [ ] Optimize test execution performance across all utilities
  - [ ] Extract common patterns into reusable base classes
  - [ ] Improve test failure messages and debugging support
  - [ ] Verify coverage requirements are met consistently

## Dev Notes - Implementation Guide

### Technical Design Notes

**Core Design Patterns:**
- **Test Data Builder Pattern**: Fluent API for creating complex test objects with sensible defaults
- **Factory Pattern**: Generate realistic test data with variations for edge cases
- **Custom Assertions Pattern**: Domain-specific assertions that provide clear failure messages
- **Test Container Pattern**: Real database and service testing with isolated environments

**Test Infrastructure Architecture:**
```
test-infrastructure/
├── src/main/java/ch/batbern/test/
│   ├── builders/           # Test data builders with fluent APIs
│   │   ├── EventTestDataBuilder.java
│   │   ├── SpeakerTestDataBuilder.java
│   │   ├── CompanyTestDataBuilder.java
│   │   └── UserTestDataBuilder.java
│   ├── fixtures/           # JSON-based test fixtures
│   │   ├── FixtureLoader.java
│   │   ├── ValidEventFixtures.java
│   │   └── ErrorScenarioFixtures.java
│   ├── assertions/         # Domain-specific assertions
│   │   ├── EventAssertions.java
│   │   ├── SpeakerAssertions.java
│   │   └── ValidationAssertions.java
│   ├── containers/         # Testcontainer configurations
│   │   ├── PostgreSQLTestContainer.java
│   │   ├── RedisTestContainer.java
│   │   └── LocalStackContainer.java
│   ├── mocks/              # Mock service implementations
│   │   ├── MockCognitoClient.java
│   │   ├── MockEventBridgeClient.java
│   │   └── MockS3Client.java
│   └── utils/              # Test utility functions
│       ├── AuthTestHelper.java
│       ├── APITestHelper.java
│       └── DataSeeder.java
```

**Key Interface Patterns:**
```java
// Test Data Builder Pattern
public class EventTestDataBuilder {
    private String title = "BATbern 2024";
    private LocalDate eventDate = LocalDate.now().plusMonths(3);
    private EventStatus status = EventStatus.DRAFT;

    public EventTestDataBuilder withTitle(String title) {
        this.title = title;
        return this;
    }

    public EventTestDataBuilder withDate(LocalDate date) {
        this.eventDate = date;
        return this;
    }

    public EventTestDataBuilder asPublished() {
        this.status = EventStatus.PUBLISHED;
        return this;
    }

    public Event build() {
        return Event.builder()
            .title(title)
            .eventDate(eventDate)
            .status(status)
            .build();
    }
}

// Custom Assertions Pattern
public class EventAssertions {
    public static EventAssert assertThat(Event actual) {
        return new EventAssert(actual);
    }

    public static class EventAssert extends AbstractAssert<EventAssert, Event> {
        public EventAssert hasValidSwissQuarter() {
            // Custom validation logic with detailed failure messages
            return this;
        }

        public EventAssert isInStatus(EventStatus expectedStatus) {
            // Status validation with business context
            return this;
        }
    }
}
```

### Coverage and Testing Configuration

**JaCoCo Configuration (Java):**
```xml
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <configuration>
        <rules>
            <rule>
                <element>BUNDLE</element>
                <limits>
                    <limit>
                        <counter>LINE</counter>
                        <value>COVEREDRATIO</value>
                        <minimum>0.85</minimum>
                    </limit>
                    <limit>
                        <counter>BRANCH</counter>
                        <value>COVEREDRATIO</value>
                        <minimum>0.80</minimum>
                    </limit>
                </limits>
            </rule>
        </rules>
        <excludes>
            <exclude>**/config/**</exclude>
            <exclude>**/dto/**</exclude>
            <exclude>**/*Application.class</exclude>
        </excludes>
    </configuration>
</plugin>
```

**Vitest Configuration (TypeScript):**
```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.*',
      ],
      statements: 85,
      branches: 80,
      functions: 85,
      lines: 85,
    },
  },
});
```

**TestContainer Configuration Examples:**
```java
@TestConfiguration
public class TestContainerConfig {

    @Bean
    @Primary
    public PostgreSQLContainer<?> postgresContainer() {
        return new PostgreSQLContainer<>("postgres:15")
            .withDatabaseName("batbern_test")
            .withUsername("test")
            .withPassword("test")
            .withReuse(true);
    }

    @Bean
    @Primary
    public GenericContainer<?> redisContainer() {
        return new GenericContainer<>("redis:7.2-alpine")
            .withExposedPorts(6379)
            .withReuse(true);
    }

    @Bean
    @Primary
    public LocalStackContainer localStackContainer() {
        return new LocalStackContainer(DockerImageName.parse("localstack/localstack:3.0"))
            .withServices(S3, COGNITO_IDP, EVENTS)
            .withReuse(true);
    }
}
```

### Testing Requirements

**Performance Targets:**
- Test Data Builder object creation: <1ms per object
- Test Container startup: <10 seconds for all containers
- Test execution: Unit tests <30 seconds, Integration tests <2 minutes
- Coverage report generation: <30 seconds

**Coverage Requirements:**
- **Overall**: 85% line coverage minimum
- **Business Logic**: 90% line coverage minimum
- **Integration Tests**: 80% coverage for API endpoints
- **Branch Coverage**: 80% minimum for decision logic

**Test Execution Standards:**
```java
// Example comprehensive test using all utilities
@SpringBootTest
@Testcontainers
class EventServiceIntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = TestContainerConfig.postgresContainer();

    @Test
    void should_createEventSuccessfully_when_validDataProvided() {
        // Given - using test data builder
        Event event = EventTestDataBuilder.aValidEvent()
            .withTitle("BATbern 2024")
            .asPublished()
            .build();

        // When
        Event savedEvent = eventService.createEvent(event);

        // Then - using custom assertions
        EventAssertions.assertThat(savedEvent)
            .hasValidSwissQuarter()
            .isInStatus(EventStatus.PUBLISHED);
    }
}
```

## Definition of Done Checklist

### Development Complete
- [ ] All tests written BEFORE implementation (TDD followed)
- [ ] All acceptance criteria have corresponding tests
- [ ] All acceptance criteria implemented and verified
- [ ] Unit tests written and passing (>90% coverage for utilities)
- [ ] Integration tests cover all test container configurations
- [ ] Test data builders work for all domain entities
- [ ] Custom assertions provide clear failure messages
- [ ] Code follows project conventions (coding-standards.md)
- [ ] Test infrastructure documentation complete

### Infrastructure Complete ⚠️ CRITICAL
- [ ] Test infrastructure module published to internal repository
- [ ] JaCoCo coverage reporting integrated with CI/CD
- [ ] NYC TypeScript coverage reporting working
- [ ] GitHub Actions coverage gates configured and working
- [ ] Test containers start reliably in <10 seconds
- [ ] Coverage reports generated on all pull requests
- [ ] Test metrics dashboard deployed and functional
- [ ] Performance benchmarks meet <30 second test execution requirement

### Frontend Complete
- [ ] Vitest configuration optimized for TypeScript testing
- [ ] React Testing Library utilities implemented
- [ ] Frontend test data builders working
- [ ] Component test patterns documented
- [ ] Coverage reporting integrated with backend coverage

### Review Ready
- [ ] PR created with comprehensive testing examples
- [ ] Code review completed by development team
- [ ] Testing strategy review passed
- [ ] Documentation updated (README, testing guides)
- [ ] Test infrastructure usage examples created
- [ ] Integration guide for consuming services documented

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-20 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Implementation Approach
_To be documented during implementation_

### Debug Log References
_Debug log references to be added during development_

### Completion Notes
_Implementation notes and any deviations from plan_

### Files Changed
_List of all files created, modified, or deleted during implementation_

### Deployment Notes
_Special deployment considerations and rollback procedures_

## QA Results
_QA results to be filled after implementation review_