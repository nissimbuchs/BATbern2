# Story 1.15a.1: Events API Consolidation

## Status
Approved

## Story

**As a** frontend developer,
**I want** consolidated Events APIs with resource expansion and rich filtering,
**so that** I can load event data efficiently without making dozens of separate API calls.

## Domain Context

### Primary Domain
Event Management Domain - Event CRUD, workflow, publishing, registration

### Involved Services
- Event Management Service (primary)
- API Gateway (routing, middleware)
- Shared Kernel (query utilities from Story 1.16)
- ElastiCache Redis (caching expanded resources)
- EventBridge (domain events)

### Cross-Domain Dependencies
- **Depends on**: Story 1.15a (API Consolidation Foundation) for query parsers and middleware
- **Depends on**: Story 1.2 (API Gateway & Authentication) for auth
- **Integrates with**: Speaker Coordination Service (event speaker data)
- **Integrates with**: Company Management Service (venue, catering data)
- **Publishes Events**: EventPublishedEvent, EventWorkflowAdvancedEvent

## Requirements Context

### Related Functional Requirements
- **FR2**: 16-step event workflow automation
- **FR15**: Event publishing with validation rules
- **FR21**: Event registration management
- **NFR-Performance**: Reduce API calls from 10+ to 1 per page load

### Workflow Steps (if applicable)
This story impacts all 16 workflow steps by providing efficient API access to event data.

### Acceptance Criteria Source
API Consolidation Analysis Report (docs/api-consolidation-analysis.md), Section 3.1 - Events Domain

## Architecture Context

### Architecture Patterns
[Source: docs/architecture/apis/design-principles.md]
- **Resource Expansion**: `?include=venue,speakers,sessions,topics` pattern
- **Rich Filtering**: JSON filter syntax for event search
- **Pagination**: Standard page/limit parameters
- **Field Selection**: Reduce payload with `?fields=` parameter

[Source: docs/api-consolidation-analysis.md - Events Domain]
- **Before**: 130 fragmented endpoints
- **After**: 25 consolidated endpoints
- **Reduction**: 81%

### Infrastructure Components
- **Event Management Service**: Spring Boot microservice
- **PostgreSQL**: Event data storage
- **ElastiCache Redis**: Cache expanded event data (15min TTL)
- **EventBridge**: Publish EventPublishedEvent, EventWorkflowAdvancedEvent
- **CloudWatch**: API performance metrics

## Wireframe Context

### Wireframe References
- `story-1.16-event-management-dashboard.md` - Event listing and search
- `story-1.16-event-detail-edit.md` - Event detail with all sub-resources
- `story-1.16-workflow-visualization.md` - Event workflow state
- `story-2.3-event-list-organizer.md` - Organizer event management
- `story-2.4-current-event-landing.md` - Public event display
- `story-1.18-historical-archive.md` - Historical event search

### UI Components
These wireframes will migrate from making 10-30 API calls to 1-3 calls using:
- `?include=` for sub-resources
- `?filter=` for search
- `?fields=` for minimal payloads

## Acceptance Criteria

1. **List/Search Events**: `GET /api/v1/events` with filter, sort, pagination support
2. **Get Event Detail**: `GET /api/v1/events/{id}` with optional includes (venue, speakers, sessions, topics, workflow, registrations, catering, team, publishing, notifications, analytics)
3. **Create Event**: `POST /api/v1/events` with complete event data
4. **Update Event**: `PUT /api/v1/events/{id}` for full replacement
5. **Partial Update**: `PATCH /api/v1/events/{id}` for field updates
6. **Delete Event**: `DELETE /api/v1/events/{id}` with cascade deletion
7. **Publish Event**: `POST /api/v1/events/{id}/publish` with validation
8. **Workflow Advance**: `POST /api/v1/events/{id}/workflow/advance` to next state
9. **Get Sessions**: `GET /api/v1/events/{id}/sessions` with filtering
10. **Manage Sessions**: `POST/PUT/DELETE /api/v1/events/{id}/sessions/{sessionId}`
11. **Get Registrations**: `GET /api/v1/events/{id}/registrations` with filtering
12. **Manage Registrations**: `POST/PATCH /api/v1/events/{id}/registrations/{registrationId}`
13. **Event Analytics**: `GET /api/v1/events/{id}/analytics?metrics=attendance,registrations,engagement`
14. **Bulk Operations**: `PATCH /api/v1/events` for batch updates
15. **Caching**: Redis caching for expanded resources (15min TTL)
16. **Performance**: Event detail with all includes <500ms (P95)
17. **Migration**: All 6 affected wireframes updated to use new APIs
18. **Documentation**: OpenAPI spec for all 25 events endpoints

## Test Specifications (TDD)

### Test Scenarios by Acceptance Criteria

**AC1 Tests: List/Search Events**
- Test 1.1: should_listEvents_when_noFilterProvided
- Test 1.2: should_filterByStatus_when_filterProvided
- Test 1.3: should_filterByYear_when_dateFilterProvided
- Test 1.4: should_sortByDate_when_sortParamProvided
- Test 1.5: should_paginateResults_when_pageParamProvided

**AC2 Tests: Get Event Detail**
- Test 2.1: should_getEventBasic_when_noIncludesProvided
- Test 2.2: should_includeVenue_when_includeVenueRequested
- Test 2.3: should_includeSpeakers_when_includeSpeakersRequested
- Test 2.4: should_includeMultiple_when_multipleIncludesRequested
- Test 2.5: should_return404_when_eventNotFound

**AC3-6 Tests: Event CRUD**
- Test 3.1: should_createEvent_when_validDataProvided
- Test 3.2: should_return400_when_invalidDataProvided
- Test 4.1: should_replaceEvent_when_putRequested
- Test 5.1: should_patchFields_when_patchRequested
- Test 6.1: should_deleteEvent_when_deleteRequested
- Test 6.2: should_cascadeDelete_when_eventDeleted

**AC7-8 Tests: Event Actions**
- Test 7.1: should_publishEvent_when_validationPasses
- Test 7.2: should_return422_when_validationFails
- Test 8.1: should_advanceWorkflow_when_transitionValid
- Test 8.2: should_return422_when_transitionInvalid

**AC9-12 Tests: Sub-resources**
- Test 9.1: should_listSessions_when_requested
- Test 10.1: should_createSession_when_validData
- Test 11.1: should_listRegistrations_when_requested
- Test 12.1: should_updateRegistration_when_patchProvided

**AC13 Tests: Analytics**
- Test 13.1: should_returnAnalytics_when_metricsRequested
- Test 13.2: should_filterByTimeframe_when_timeframeProvided

**AC14 Tests: Bulk Operations**
- Test 14.1: should_batchUpdate_when_arrayProvided
- Test 14.2: should_partiallySucceed_when_someInvalid

**AC15-16 Tests: Performance**
- Test 15.1: should_cacheExpanded_when_includesUsed
- Test 15.2: should_returnCached_when_withinTTL
- Test 15.3: should_invalidateCache_when_eventUpdated
- Test 16.1: should_respondUnder500ms_when_fullIncludesRequested

**AC17-18 Tests: Migration & Documentation**
- Test 17.1: should_loadEventDashboard_when_usingNewAPIs
- Test 18.1: should_generateOpenAPISpec_when_requested

### Test File Locations

**Event Management Service Tests:**
- `services/event-management/src/test/java/ch/batbern/events/controller/EventControllerTest.java`
- `services/event-management/src/test/java/ch/batbern/events/service/EventServiceTest.java`
- `services/event-management/src/test/integration/EventIntegrationTest.java`
- `services/event-management/src/test/integration/EventCachingTest.java`
- `services/event-management/src/test/performance/EventPerformanceTest.java`

**E2E Tests:**
- `e2e/workflows/events/event-management-flow.spec.ts`

### Test Data & Mocks

**Test Data Builders:**
- EventTestDataBuilder with venue, speakers, sessions
- EventFilterTestDataBuilder for search scenarios

**Mock Services:**
- Mock Speaker Coordination Service
- Mock Company Management Service
- Mock Redis for caching tests

**Performance Test Data:**
- Large event with 50 speakers, 20 sessions
- Verify <500ms response time

## Tasks / Subtasks (TDD Workflow)

- [ ] Task 1: Write E2E Tests (RED Phase)
  - [ ] Write failing test for event dashboard page load
  - [ ] Write failing test for event detail page with all includes
  - [ ] Verify tests fail

- [ ] Task 2: Event List/Search API TDD (AC: 1)
  - [ ] Write failing tests for GET /api/v1/events
  - [ ] Write tests for filtering, sorting, pagination
  - [ ] Implement EventController.listEvents() (GREEN)
  - [ ] Implement EventSearchService (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 3: Event Detail API TDD (AC: 2)
  - [ ] Write failing tests for GET /api/v1/events/{id}
  - [ ] Write tests for all include options
  - [ ] Implement EventController.getEvent() (GREEN)
  - [ ] Implement resource expansion logic (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 4: Event CRUD APIs TDD (AC: 3-6)
  - [ ] Write failing tests for POST/PUT/PATCH/DELETE
  - [ ] Implement all CRUD operations (GREEN)
  - [ ] Implement cascade deletion (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 5: Event Actions APIs TDD (AC: 7-8)
  - [ ] Write failing tests for publish and workflow
  - [ ] Implement EventPublishingService (GREEN)
  - [ ] Implement EventWorkflowService (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 6: Sub-resources APIs TDD (AC: 9-12)
  - [ ] Write failing tests for sessions and registrations
  - [ ] Implement nested resource controllers (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 7: Analytics API TDD (AC: 13)
  - [ ] Write failing tests for analytics endpoint
  - [ ] Implement EventAnalyticsService (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 8: Bulk Operations TDD (AC: 14)
  - [ ] Write failing tests for batch updates
  - [ ] Implement bulk operation handler (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 9: Caching Implementation (AC: 15-16)
  - [ ] Write failing tests for Redis caching
  - [ ] Implement cache-aside pattern (GREEN)
  - [ ] Implement cache invalidation (GREEN)
  - [ ] Performance test with caching (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 10: Wireframe Migration (AC: 17)
  - [ ] Update story-1.16-event-management-dashboard.md
  - [ ] Update story-1.16-event-detail-edit.md
  - [ ] Update story-1.16-workflow-visualization.md
  - [ ] Update story-2.3-event-list-organizer.md
  - [ ] Update story-2.4-current-event-landing.md
  - [ ] Update story-1.18-historical-archive.md
  - [ ] Test all wireframes with new APIs

- [ ] Task 11: Documentation (AC: 18)
  - [ ] Generate OpenAPI spec for all events endpoints
  - [ ] Document migration guide
  - [ ] Add examples to API docs
  - [ ] Update wireframes with API references

## Dev Notes - Implementation Guide

### API Consolidation Details

**Before Consolidation**: 130 endpoints
**After Consolidation**: 25 endpoints
**Reduction**: 81%

### Consolidated Endpoints

```
# Core CRUD
GET    /api/v1/events?filter={}&sort={}&page={}&limit={}
GET    /api/v1/events/{id}?include=venue,speakers,sessions,topics,workflow,registrations,catering,team,publishing,notifications,analytics&fields={}
POST   /api/v1/events
PUT    /api/v1/events/{id}
PATCH  /api/v1/events/{id}
DELETE /api/v1/events/{id}

# Actions
POST   /api/v1/events/{id}/publish
POST   /api/v1/events/{id}/workflow/advance
POST   /api/v1/events/{id}/duplicate

# Sub-resources
GET    /api/v1/events/{id}/sessions?filter={}&page={}
POST   /api/v1/events/{id}/sessions
PUT    /api/v1/events/{id}/sessions/{sessionId}
DELETE /api/v1/events/{id}/sessions/{sessionId}

GET    /api/v1/events/{id}/registrations?filter={}&page={}
POST   /api/v1/events/{id}/registrations
PATCH  /api/v1/events/{id}/registrations/{registrationId}
DELETE /api/v1/events/{id}/registrations/{registrationId}

GET    /api/v1/events/{id}/attendees?filter={}&page={}
GET    /api/v1/events/{id}/workflow/history
GET    /api/v1/events/{id}/analytics?metrics={}&timeframe={}

# Bulk operations
PATCH  /api/v1/events
POST   /api/v1/events/bulk-import
POST   /api/v1/events/export
```

### Sample Include Expansion

**Request**:
```
GET /api/v1/events/evt-123?include=venue,speakers,sessions
```

**Response**:
```json
{
  "id": "evt-123",
  "title": "BATbern 2025",
  "date": "2025-05-15T09:00:00Z",
  "status": "published",
  "venue": {
    "id": "ven-001",
    "name": "Bern Convention Center",
    "capacity": 500,
    "address": "Mingerstrasse 6, 3014 Bern"
  },
  "speakers": [
    {
      "id": "spk-001",
      "name": "Dr. Anna Schmidt",
      "title": "AI and the Future of Work",
      "company": "SwissTech AG"
    }
  ],
  "sessions": [
    {
      "id": "ses-001",
      "title": "Keynote Session",
      "startTime": "2025-05-15T09:30:00Z",
      "duration": 60
    }
  ]
}
```

### Performance Requirements

- Event list (no includes): <100ms (P95)
- Event detail (basic): <150ms (P95)
- Event detail (all includes): <500ms (P95)
- Event search with filters: <200ms (P95)
- Cached response: <50ms (P95)

### Caching Strategy

**Cache Key Pattern**: `event:{id}:includes:{includeList}`

**TTL**: 15 minutes

**Invalidation**: On event update, deletion, or workflow change

**Implementation**: Spring Cache abstraction with Redis backend

### Migration Impact

**Wireframe**: story-1.16-event-detail-edit.md

**Before** (30 API calls):
```typescript
const event = await getEvent(id);
const venue = await getEventVenue(id);
const catering = await getEventCatering(id);
const speakers = await getEventSpeakers(id);
const sessions = await getEventSessions(id);
const topics = await getEventTopics(id);
const workflow = await getEventWorkflow(id);
const registrations = await getEventRegistrations(id);
// ... 22 more API calls
```

**After** (1 API call):
```typescript
const event = await getEvent(id, {
  include: 'venue,catering,speakers,sessions,topics,workflow,registrations'
});
```

**Performance Improvement**: 90% reduction in HTTP requests, 80% faster page load

## Definition of Done Checklist

### Development Complete
- [ ] All tests written BEFORE implementation (TDD followed)
- [ ] All 18 acceptance criteria implemented
- [ ] Unit tests passing (>90% coverage)
- [ ] Integration tests passing (>85% coverage)
- [ ] Performance tests meet requirements (<500ms P95)
- [ ] Code follows project conventions
- [ ] OpenAPI documentation generated

### Infrastructure Complete ⚠️ CRITICAL
- [ ] Event Management Service deployed with new endpoints
- [ ] Redis caching configured and operational
- [ ] API Gateway routes updated
- [ ] CloudWatch metrics tracking API performance
- [ ] EventBridge rules for domain events configured

### Migration Complete
- [ ] All 6 wireframes updated to use new APIs
- [ ] Frontend API client updated
- [ ] Old endpoints deprecated with warnings
- [ ] Migration guide documented
- [ ] Backward compatibility verified

### Review Ready
- [ ] PR created with detailed description
- [ ] Code review completed
- [ ] Performance review passed (<500ms requirement)
- [ ] Migration impact analysis completed
- [ ] Documentation updated

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-10-04 | 1.0 | Initial story for Events API consolidation (Phase 2) | Winston (Architect) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent during implementation_

### Implementation Approach
_To be documented by dev agent_

### Completion Notes
_To be filled with issues encountered_

### Files Changed
_To be populated with created/modified files_

## QA Results
_To be populated by QA Agent_
