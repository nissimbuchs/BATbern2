# Story 1.2.1: Fix Login Screen & Add i18n Foundation

## Status
Accepted

## Story

**As a** user of any role (Organizer, Speaker, Partner, Attendee),
**I want** a complete login screen with multi-language support from day 1,
**so that** I can authenticate in my preferred language (German or English) with all expected features including password visibility toggle and session persistence.

**Context:** This story corrects Story 1.2 (API Gateway & Authentication Service) which was implemented before wireframes existed. The current login implementation is missing critical features specified in the wireframe (story-1.2-login-screen.md).

## Domain Context

### Primary Domain
- **Shared/Infrastructure** (Cross-cutting concern: Authentication & i18n)
- **All Domain Boundaries** (i18n foundation affects all services)

### Involved Services
- **web-frontend** (React application)
- **API Gateway** (authentication flow already implemented, needs i18n header support)

### Cross-Domain Dependencies
- AWS Cognito (existing authentication service - no changes needed)
- All future frontend components (will use i18n foundation)

## Requirements Context

### Related Functional Requirements
- **FR1**: Role-based authentication with AWS Cognito
- **FR22**: All users created as ATTENDEE role initially
- **NFR4**: Multi-language support from MVP launch (German de-CH and English en-US)

### Related Wireframes
- **Primary**: `docs/wireframes/story-1.2-login-screen.md`
  - Language selector (ðŸŒ EN â–¼ | DE) in header
  - Email and password fields with validation
  - Password show/hide toggle (ðŸ‘ icon)
  - "Remember me" checkbox
  - Role-based dashboard redirect after authentication

## Architecture Context

### Architecture Patterns
- **Frontend Architecture** (`docs/architecture/05-frontend-architecture.md`):
  - i18next + react-i18next for internationalization
  - Material-UI components for UI elements
  - React Hook Form for form state management
  - Zustand for global auth state
  - React Query for API calls

### Infrastructure Components
- **i18n Framework**: react-i18next ^14.0.0, i18next-browser-languagedetector ^7.2.0
- **Translation Files**: `/public/locales/de/*.json` and `/public/locales/en/*.json`
- **Language Detection**: localStorage â†’ browser language â†’ default (de-CH)
- **Language Persistence**: localStorage (`batbern-language` key) + user profile after login

## Acceptance Criteria

### i18n Foundation (Critical - Must Complete First)
1. **i18n Framework Installation**: Install and configure react-i18next, i18next-browser-languagedetector with TypeScript type safety
2. **Translation File Structure**: Create namespace-based translation files (`common.json`, `auth.json`, `validation.json`) for both de and en
3. **Language Detection**: Auto-detect browser locale on first visit, default to German (de-CH) if no preference
4. **Language Persistence**: Store selected language in localStorage (`batbern-language` key) and sync with user profile after login
5. **TypeScript Type Safety**: Configure TypeScript types for translation keys with compile-time validation

### Login Screen UI Fixes
6. **Language Selector**: Add dropdown in header (ðŸŒ EN â–¼ | DE) that switches language immediately without page refresh
7. **Email Field**: Email input with proper validation (required, email format, max 255 chars)
8. **Password Field**: Password input with validation (required, min 8 chars, max 128 chars)
9. **Password Toggle**: Add show/hide password button (ðŸ‘ icon) that toggles password visibility
10. **Remember Me Checkbox**: Add "Remember me" checkbox that controls session persistence
11. **Form Labels & Text**: All UI text uses translation keys (no hard-coded strings)
12. **Error Messages**: All validation and authentication errors display in selected language

### Authentication Flow Integration
13. **Cognito Integration**: Maintain existing AWS Cognito authentication (no backend changes)
14. **Session Management**: "Remember me" checked â†’ secure localStorage; unchecked â†’ session storage
15. **Role-Based Redirect**: After login, redirect to role-specific dashboard (Organizer/Speaker/Partner/Attendee)
16. **Language Header**: Pass Accept-Language header to API Gateway for server-side localization

## Test Specifications (TDD)

### i18n Framework Tests
**Test Group 1: Translation Infrastructure**
- Test 1.1: should_loadTranslations_when_appInitializes
- Test 1.2: should_detectBrowserLanguage_when_noPreferenceStored
- Test 1.3: should_useStoredLanguage_when_preferenceExists
- Test 1.4: should_updateLocalStorage_when_languageChanged
- Test 1.5: should_providTypeCheck_when_invalidKeyUsed (TypeScript compile error)

### Language Switcher Tests
**Test Group 2: Language Switcher Component**
- Test 2.1: should_renderLanguageSelector_when_componentMounted
- Test 2.2: should_showGermanSelected_when_defaultLanguage
- Test 2.3: should_changeLanguage_when_dropdownChanged
- Test 2.4: should_persistLanguage_when_selectionMade
- Test 2.5: should_updateAllText_when_languageChanged

### Login Form Tests
**Test Group 3: Login Form with i18n**
- Test 3.1: should_displayGermanText_when_languageIsGerman
- Test 3.2: should_displayEnglishText_when_languageIsEnglish
- Test 3.3: should_validateEmail_when_invalidFormat
- Test 3.4: should_validatePassword_when_tooShort
- Test 3.5: should_togglePasswordVisibility_when_iconClicked
- Test 3.6: should_enableRememberMe_when_checkboxClicked
- Test 3.7: should_displayLocalizedErrors_when_validationFails

### Integration Tests
**Test Group 4: Authentication Flow**
- Test 4.1: should_authenticateUser_when_validCredentials
- Test 4.2: should_storeTokens_when_rememberMeChecked
- Test 4.3: should_useSessionStorage_when_rememberMeUnchecked
- Test 4.4: should_redirectToDashboard_when_loginSuccessful
- Test 4.5: should_displayLocalizedError_when_authFails
- Test 4.6: should_includeLanguageHeader_when_apiCalled

### Test File Locations
**Frontend Tests:**
- `web-frontend/src/i18n/config.test.ts` - i18n configuration tests
- `web-frontend/src/components/shared/LanguageSwitcher/LanguageSwitcher.test.tsx` - Language selector tests
- `web-frontend/src/components/auth/LoginForm/LoginForm.test.tsx` - Login form tests with i18n
- `web-frontend/src/hooks/useAuth/useAuth.test.ts` - Authentication hook tests

**E2E Tests:**
- `e2e/auth/login-i18n.spec.ts` - End-to-end login flow with language switching

## Tasks / Subtasks (TDD Workflow)

### Task 1: i18n Foundation Setup (RED Phase)
- [ ] Install i18next dependencies (i18next, react-i18next, i18next-browser-languagedetector)
- [ ] Create i18n configuration file (`src/i18n/config.ts`)
- [ ] Create translation file structure (`public/locales/de/*.json`, `public/locales/en/*.json`)
- [ ] Configure TypeScript types for translation keys
- [ ] Write failing tests for i18n initialization and language detection

### Task 2: Translation Files Creation (RED Phase)
- [ ] Create `common.json` with navigation and shared UI translations (de/en)
- [ ] Create `auth.json` with login screen translations (de/en)
- [ ] Create `validation.json` with form validation messages (de/en)
- [ ] Add translation examples from wireframe (Welcome Back, Sign in to continue, etc.)
- [ ] Run translation key parity validation script

### Task 3: Language Switcher Component (GREEN Phase)
- [ ] Create LanguageSwitcher component with Material-UI Select
- [ ] Implement language change handler with i18n.changeLanguage()
- [ ] Add localStorage persistence logic
- [ ] Update HTML lang attribute on language change
- [ ] Verify all component tests pass

### Task 4: Fix Login Form Component (GREEN Phase)
- [ ] Add useTranslation hook to LoginForm component
- [ ] Replace all hard-coded text with t('auth.login.key') calls
- [ ] Add password visibility toggle state and icon button
- [ ] Add "Remember me" checkbox with state management
- [ ] Implement proper form validation with localized error messages
- [ ] Verify all LoginForm tests pass

### Task 5: Authentication Integration (GREEN Phase)
- [ ] Update useAuth hook to handle "Remember me" logic
- [ ] Implement session storage vs localStorage based on checkbox
- [ ] Add Accept-Language header to API client
- [ ] Maintain role-based dashboard redirect logic
- [ ] Verify integration tests pass

### Task 6: E2E Testing & Validation (REFACTOR Phase)
- [ ] Run E2E tests for login flow in both languages
- [ ] Test language persistence across page reloads
- [ ] Verify password toggle functionality
- [ ] Test "Remember me" session persistence
- [ ] Run accessibility audit on login screen

### Task 7: Documentation
- [ ] Update README with i18n setup instructions
- [ ] Document translation key naming conventions
- [ ] Add language switcher usage guide
- [ ] Document how to add new translations
- [ ] Create developer guide for using i18n in components

## Dev Notes - Implementation Guide

### i18n Configuration

**Installation:**
```bash
npm install i18next react-i18next i18next-browser-languagedetector
npm install -D @types/i18next
```

**Configuration (`src/i18n/config.ts`):**
```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';

import commonDe from '../../public/locales/de/common.json';
import commonEn from '../../public/locales/en/common.json';
import authDe from '../../public/locales/de/auth.json';
import authEn from '../../public/locales/en/auth.json';
import validationDe from '../../public/locales/de/validation.json';
import validationEn from '../../public/locales/en/validation.json';

i18n
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    resources: {
      de: { common: commonDe, auth: authDe, validation: validationDe },
      en: { common: commonEn, auth: authEn, validation: validationEn },
    },
    fallbackLng: 'de',
    defaultNS: 'common',
    ns: ['common', 'auth', 'validation'],
    detection: {
      order: ['localStorage', 'navigator', 'htmlTag'],
      caches: ['localStorage'],
      lookupLocalStorage: 'batbern-language',
    },
    interpolation: {
      escapeValue: false, // React already escapes
    },
    react: {
      useSuspense: true,
    },
  });

export default i18n;
```

### Translation Files

**`public/locales/de/auth.json`:**
```json
{
  "login": {
    "title": "Willkommen zurÃ¼ck",
    "subtitle": "Melden Sie sich an, um fortzufahren",
    "emailLabel": "E-Mail-Adresse",
    "emailPlaceholder": "ihre.email@beispiel.ch",
    "passwordLabel": "Passwort",
    "passwordPlaceholder": "Ihr Passwort eingeben",
    "rememberMe": "Angemeldet bleiben",
    "forgotPassword": "Passwort vergessen?",
    "signInButton": "Anmelden",
    "createAccount": "Konto erstellen",
    "noAccount": "Noch kein Konto?",
    "showPassword": "Passwort anzeigen",
    "hidePassword": "Passwort verbergen"
  },
  "errors": {
    "invalidCredentials": "UngÃ¼ltige E-Mail oder Passwort. Bitte versuchen Sie es erneut.",
    "emailNotVerified": "E-Mail nicht verifiziert. Bitte Ã¼berprÃ¼fen Sie Ihren Posteingang.",
    "accountLocked": "Konto gesperrt. Versuchen Sie es in 15 Minuten erneut.",
    "networkError": "Verbindungsfehler. Bitte Ã¼berprÃ¼fen Sie Ihre Internetverbindung."
  }
}
```

**`public/locales/en/auth.json`:**
```json
{
  "login": {
    "title": "Welcome Back",
    "subtitle": "Sign in to continue",
    "emailLabel": "Email Address",
    "emailPlaceholder": "your.email@example.com",
    "passwordLabel": "Password",
    "passwordPlaceholder": "Enter your password",
    "rememberMe": "Remember me",
    "forgotPassword": "Forgot Password?",
    "signInButton": "Sign In",
    "createAccount": "Create Account",
    "noAccount": "Don't have an account?",
    "showPassword": "Show password",
    "hidePassword": "Hide password"
  },
  "errors": {
    "invalidCredentials": "Invalid email or password. Please try again.",
    "emailNotVerified": "Email not verified. Please check your inbox.",
    "accountLocked": "Account locked. Try again in 15 minutes.",
    "networkError": "Connection error. Please check your internet connection."
  }
}
```

**`public/locales/de/validation.json`:**
```json
{
  "email": {
    "required": "E-Mail ist erforderlich",
    "invalid": "Bitte geben Sie eine gÃ¼ltige E-Mail-Adresse ein",
    "tooLong": "E-Mail-Adresse ist zu lang (max. 255 Zeichen)"
  },
  "password": {
    "required": "Passwort ist erforderlich",
    "tooShort": "Passwort muss mindestens 8 Zeichen lang sein",
    "tooLong": "Passwort ist zu lang (max. 128 Zeichen)"
  }
}
```

### Language Switcher Component

**`src/components/shared/LanguageSwitcher/LanguageSwitcher.tsx`:**
```typescript
import React from 'react';
import { useTranslation } from 'react-i18next';
import { Select, MenuItem, Box } from '@mui/material';
import LanguageIcon from '@mui/icons-material/Language';

const LanguageSwitcher: React.FC = () => {
  const { i18n } = useTranslation();

  const handleLanguageChange = async (newLang: 'de' | 'en') => {
    await i18n.changeLanguage(newLang);
    document.documentElement.lang = newLang;
    localStorage.setItem('batbern-language', newLang);
  };

  return (
    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
      <LanguageIcon fontSize="small" />
      <Select
        value={i18n.language}
        onChange={(e) => handleLanguageChange(e.target.value as 'de' | 'en')}
        size="small"
        sx={{ minWidth: 100 }}
      >
        <MenuItem value="de">DE</MenuItem>
        <MenuItem value="en">EN</MenuItem>
      </Select>
    </Box>
  );
};

export default LanguageSwitcher;
```

### Updated Login Form Component

**`src/components/auth/LoginForm/LoginForm.tsx`:**
```typescript
import React, { useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useForm } from 'react-hook-form';
import {
  Box,
  TextField,
  Button,
  Checkbox,
  FormControlLabel,
  IconButton,
  InputAdornment,
  Typography,
  Link,
  Alert
} from '@mui/material';
import { Visibility, VisibilityOff } from '@mui/icons-material';
import { useAuth } from '@/hooks/useAuth';

interface LoginFormData {
  email: string;
  password: string;
  rememberMe: boolean;
}

const LoginForm: React.FC = () => {
  const { t } = useTranslation(['auth', 'validation']);
  const { login, isLoading, error } = useAuth();
  const [showPassword, setShowPassword] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors }
  } = useForm<LoginFormData>({
    defaultValues: {
      rememberMe: false
    }
  });

  const onSubmit = async (data: LoginFormData) => {
    await login(data.email, data.password, data.rememberMe);
  };

  return (
    <Box
      component="form"
      onSubmit={handleSubmit(onSubmit)}
      sx={{ maxWidth: 400, mx: 'auto', mt: 8 }}
    >
      <Typography variant="h4" align="center" gutterBottom>
        {t('auth:login.title')}
      </Typography>
      <Typography variant="body2" align="center" color="text.secondary" sx={{ mb: 3 }}>
        {t('auth:login.subtitle')}
      </Typography>

      {error && (
        <Alert severity="error" sx={{ mb: 2 }}>
          {t(`auth:errors.${error}`)}
        </Alert>
      )}

      <TextField
        {...register('email', {
          required: t('validation:email.required'),
          pattern: {
            value: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            message: t('validation:email.invalid')
          },
          maxLength: {
            value: 255,
            message: t('validation:email.tooLong')
          }
        })}
        label={t('auth:login.emailLabel')}
        placeholder={t('auth:login.emailPlaceholder')}
        type="email"
        fullWidth
        margin="normal"
        error={!!errors.email}
        helperText={errors.email?.message}
        autoComplete="username email"
      />

      <TextField
        {...register('password', {
          required: t('validation:password.required'),
          minLength: {
            value: 8,
            message: t('validation:password.tooShort')
          },
          maxLength: {
            value: 128,
            message: t('validation:password.tooLong')
          }
        })}
        label={t('auth:login.passwordLabel')}
        placeholder={t('auth:login.passwordPlaceholder')}
        type={showPassword ? 'text' : 'password'}
        fullWidth
        margin="normal"
        error={!!errors.password}
        helperText={errors.password?.message}
        autoComplete="current-password"
        InputProps={{
          endAdornment: (
            <InputAdornment position="end">
              <IconButton
                aria-label={showPassword ? t('auth:login.hidePassword') : t('auth:login.showPassword')}
                onClick={() => setShowPassword(!showPassword)}
                edge="end"
              >
                {showPassword ? <VisibilityOff /> : <Visibility />}
              </IconButton>
            </InputAdornment>
          )
        }}
      />

      <FormControlLabel
        control={<Checkbox {...register('rememberMe')} />}
        label={t('auth:login.rememberMe')}
        sx={{ mt: 1, mb: 2 }}
      />

      <Button
        type="submit"
        fullWidth
        variant="contained"
        size="large"
        disabled={isLoading}
        sx={{ mb: 2 }}
      >
        {t('auth:login.signInButton')}
      </Button>

      <Box sx={{ textAlign: 'center' }}>
        <Link href="/auth/forgot-password" underline="hover">
          {t('auth:login.forgotPassword')}
        </Link>
      </Box>

      <Box sx={{ textAlign: 'center', mt: 2 }}>
        <Typography variant="body2" color="text.secondary">
          {t('auth:login.noAccount')}{' '}
          <Link href="/auth/register" underline="hover">
            {t('auth:login.createAccount')}
          </Link>
        </Typography>
      </Box>
    </Box>
  );
};

export default LoginForm;
```

### Updated Authentication Hook

**`src/hooks/useAuth.ts` - Add "Remember me" logic:**
```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface AuthState {
  user: User | null;
  accessToken: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;

  login: (email: string, password: string, rememberMe: boolean) => Promise<void>;
  logout: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      accessToken: null,
      refreshToken: null,
      isAuthenticated: false,

      login: async (email: string, password: string, rememberMe: boolean) => {
        // Call Cognito authentication
        const { accessToken, refreshToken, user } = await authenticateWithCognito(email, password);

        // Store tokens based on "Remember me" setting
        if (rememberMe) {
          // Use localStorage (persisted)
          localStorage.setItem('batbern-tokens', JSON.stringify({ accessToken, refreshToken }));
        } else {
          // Use sessionStorage (expires on browser close)
          sessionStorage.setItem('batbern-tokens', JSON.stringify({ accessToken, refreshToken }));
        }

        set({
          user,
          accessToken,
          refreshToken,
          isAuthenticated: true
        });

        // Redirect to role-based dashboard
        const dashboard = getRoleDashboard(user.role);
        window.location.href = dashboard;
      },

      logout: () => {
        localStorage.removeItem('batbern-tokens');
        sessionStorage.removeItem('batbern-tokens');
        set({ user: null, accessToken: null, refreshToken: null, isAuthenticated: false });
      }
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        user: state.user,
        isAuthenticated: state.isAuthenticated
      })
    }
  )
);
```

### API Client Update - Language Header

**`src/services/apiClient.ts`:**
```typescript
import axios from 'axios';
import i18n from '@/i18n/config';

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL
});

// Add Accept-Language header to all requests
apiClient.interceptors.request.use((config) => {
  config.headers['Accept-Language'] = i18n.language;
  return config;
});

export default apiClient;
```

### Testing Patterns

**Translation Test Example:**
```typescript
// LoginForm.test.tsx
import { render, screen } from '@testing-library/react';
import { I18nextProvider } from 'react-i18next';
import i18n from '@/i18n/config';
import LoginForm from './LoginForm';

describe('LoginForm with i18n', () => {
  it('should_displayGermanText_when_languageIsGerman', async () => {
    await i18n.changeLanguage('de');

    render(
      <I18nextProvider i18n={i18n}>
        <LoginForm />
      </I18nextProvider>
    );

    expect(screen.getByText('Willkommen zurÃ¼ck')).toBeInTheDocument();
    expect(screen.getByLabelText('E-Mail-Adresse')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: 'Anmelden' })).toBeInTheDocument();
  });

  it('should_displayEnglishText_when_languageIsEnglish', async () => {
    await i18n.changeLanguage('en');

    render(
      <I18nextProvider i18n={i18n}>
        <LoginForm />
      </I18nextProvider>
    );

    expect(screen.getByText('Welcome Back')).toBeInTheDocument();
    expect(screen.getByLabelText('Email Address')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: 'Sign In' })).toBeInTheDocument();
  });
});
```

## Definition of Done Checklist

### i18n Foundation Complete
- [ ] i18next installed and configured with TypeScript type safety
- [ ] Translation files created for de and en (common, auth, validation namespaces)
- [ ] Language detection working (localStorage â†’ browser â†’ default de)
- [ ] Language persistence to localStorage functional
- [ ] TypeScript compile-time validation for translation keys working

### Login Screen Complete
- [ ] Language switcher visible in header and fully functional
- [ ] Email field with proper validation and localized error messages
- [ ] Password field with validation and localized error messages
- [ ] Password show/hide toggle button working correctly
- [ ] "Remember me" checkbox controlling session storage
- [ ] All UI text using translation keys (zero hard-coded strings)
- [ ] Localized error messages for all auth failure scenarios

### Integration Complete
- [ ] AWS Cognito authentication flow unchanged and working
- [ ] Accept-Language header sent with all API requests
- [ ] Role-based dashboard redirect working for all roles
- [ ] Session persistence working based on "Remember me"
- [ ] Language preference synced with user profile after login

### Testing Complete
- [ ] All unit tests passing (>90% coverage for new components)
- [ ] Integration tests verify auth flow with i18n
- [ ] E2E tests pass for login in both languages
- [ ] Translation key parity validation passes (de â†” en)
- [ ] Accessibility audit score >90 (WCAG 2.1 AA)

### Documentation Complete
- [ ] i18n setup guide added to docs/
- [ ] Translation key naming conventions documented
- [ ] Developer guide for using i18n in components
- [ ] How to add new translations documented
- [ ] Language switcher usage documented

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation for Story 1.2 corrective work | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be populated during implementation*

### Implementation Approach
*To be populated during implementation*

### Files Changed
*To be populated during implementation*

**Created:**
- [ ] `src/i18n/config.ts` - i18next configuration
- [ ] `public/locales/de/common.json` - German common translations
- [ ] `public/locales/en/common.json` - English common translations
- [ ] `public/locales/de/auth.json` - German auth translations
- [ ] `public/locales/en/auth.json` - English auth translations
- [ ] `public/locales/de/validation.json` - German validation messages
- [ ] `public/locales/en/validation.json` - English validation messages
- [ ] `src/components/shared/LanguageSwitcher/LanguageSwitcher.tsx` - Language switcher component
- [ ] `src/components/shared/LanguageSwitcher/LanguageSwitcher.test.tsx` - Language switcher tests

**Modified:**
- [ ] `src/components/auth/LoginForm/LoginForm.tsx` - Add i18n, password toggle, remember me
- [ ] `src/components/auth/LoginForm/LoginForm.test.tsx` - Add i18n tests
- [ ] `src/hooks/useAuth.ts` - Add "Remember me" logic
- [ ] `src/services/apiClient.ts` - Add Accept-Language header
- [ ] `package.json` - Add i18next dependencies
- [ ] `src/main.tsx` - Initialize i18n before React render
