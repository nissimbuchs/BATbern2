# Story 1.15a.6: Company & User Management API Consolidation

## Status
Draft

## Story

**As a** user,
**I want** consolidated Company and User Management APIs with search, verification, and profile management,
**so that** I can manage company affiliations, user profiles, and cross-cutting user data efficiently.

## Domain Context

### Primary Domain
Shared Infrastructure & Core Services - Company & User Management (Master Data)

### Involved Services
- **Company & User Management Service** (primary) - consolidated service
- API Gateway (routing, middleware)
- Shared Kernel (query utilities from Story 1.15a)
- ElastiCache Redis (company search caching, user session caching)
- S3 (logo storage, profile pictures)
- AWS Cognito (user authentication)
- AWS Business Registry (Swiss UID validation)

### Service Consolidation Note
This story consolidates **Company Management** and **User Management** into a single service because:
- Both are cross-cutting "master data" concerns used by all domain services
- Users belong to companies (tight coupling)
- Reduces inter-service communication overhead
- Simplifies deployment and operational complexity

### Cross-Domain Dependencies
- **Depends on**: Story 1.15a (API Consolidation Foundation)
- **Consolidates**: Story 1.15a.7 (User Management) - merged into this service
- **Used by**: All domain services (Event, Speaker, Partner, Attendee) for user and company data
- **Provides**: "Get-or-create user" endpoint for domain services to use in their workflows

## Requirements Context

### Related Functional Requirements
- **FR1**: Role-based authentication with company affiliations
- **FR4**: Partner companies with enhanced privileges
- **FR27**: User profile management
- **NFR-Data Quality**: Swiss company UID validation
- **NFR-Security**: User data protection and GDPR compliance

### Acceptance Criteria Source
- API Consolidation Analysis (docs/api-consolidation-analysis.md), Phase 3 - Companies & Users Domains
- Story 1.15a.7 (User Management) - consolidated into this story

## Architecture Context

### Architecture Patterns
[Source: docs/api-consolidation-analysis.md]
- **Before**: 42 company endpoints + 46 user endpoints = 88 total
- **After**: 22 consolidated endpoints
- **Reduction**: 75%
- **Service Consolidation**: Companies + Users merged into single service
- **Search Optimization**: Redis caching with autocomplete
- **Verification**: Swiss UID validation integration
- **Cross-Service Pattern**: Provides "get-or-create user" for domain services

### Why Consolidate Companies + Users?
Both are master data concerns with tight coupling:
- **User-Company Relationship**: Every user belongs to a company
- **Cross-Cutting Data**: All domain services need both user and company info
- **Atomic Operations**: Creating a speaker often requires creating/linking user + company
- **Reduced Complexity**: One service instead of two reduces inter-service calls
- **Operational Simplicity**: Single deployment, single database

## Wireframe Context

### Wireframe References
- `story-1.14-company-management-screen.md` - Company CRUD
- Company autocomplete in various registration forms

## Acceptance Criteria

### Company Management (10 ACs)

1. **List Companies**: `GET /api/v1/companies?filter={}&sort={}&page={}`
2. **Search/Autocomplete**: `GET /api/v1/companies/search?query={}&limit=20` with Redis caching
3. **Get Company**: `GET /api/v1/companies/{id}?include=employees,statistics,logo`
4. **Company CRUD**: POST/PUT/PATCH/DELETE `/api/v1/companies`
5. **Swiss UID Validation**: `GET /api/v1/companies/validate-uid?uid={}`
6. **Logo Upload**: POST `/api/v1/companies/{id}/logo` with presigned S3 URL
7. **Employee Relationships**: GET/POST/DELETE `/api/v1/companies/{id}/employees`
8. **Partner Promotion**: `POST /api/v1/companies/{id}/promote-partner`
9. **Verification Workflow**: `POST /api/v1/companies/{id}/verify`
10. **Company Statistics**: `GET /api/v1/companies/{id}/statistics`

### User Management (12 ACs)

11. **Get Current User**: `GET /api/v1/users/me?include=company,preferences,settings`
12. **Update Current User**: PUT/PATCH `/api/v1/users/me`
13. **List Users**: `GET /api/v1/users?filter={}&role={}&company={}&page={}` (admin/organizer)
14. **Search Users**: `GET /api/v1/users/search?query={}&role={}` with autocomplete
15. **Get User**: `GET /api/v1/users/{id}?include=company,roles`
16. **User Preferences**: GET/PUT `/api/v1/users/me/preferences`
17. **User Settings**: GET/PUT `/api/v1/users/me/settings`
18. **Role Management**: GET/PUT `/api/v1/users/{id}/roles` (admin/organizer only)
19. **Activity History**: `GET /api/v1/users/{id}/activity?timeframe={}`
20. **Profile Picture Upload**: POST `/api/v1/users/me/picture` with presigned S3 URL
21. **GDPR Delete User**: DELETE `/api/v1/users/{id}` with cascade deletion
22. **Get-or-Create User**: POST `/api/v1/users/get-or-create` (for domain services)

## Consolidated Endpoints (22 Total)

```
# Company Management
GET    /api/v1/companies?filter={}&sort={}&page={}
GET    /api/v1/companies/search?query={}&limit={}
GET    /api/v1/companies/{id}?include=employees,statistics,logo
POST   /api/v1/companies
PUT    /api/v1/companies/{id}
PATCH  /api/v1/companies/{id}
DELETE /api/v1/companies/{id}

GET    /api/v1/companies/validate-uid?uid={}
POST   /api/v1/companies/{id}/logo
GET    /api/v1/companies/{id}/employees
POST   /api/v1/companies/{id}/employees
DELETE /api/v1/companies/{id}/employees/{userId}

POST   /api/v1/companies/{id}/promote-partner
POST   /api/v1/companies/{id}/verify
GET    /api/v1/companies/{id}/statistics

# User Management (consolidated from Story 1.15a.7)
GET    /api/v1/users/me?include=company,preferences,settings
PUT    /api/v1/users/me
PATCH  /api/v1/users/me

GET    /api/v1/users?filter={}&role={}&company={}&page={}
GET    /api/v1/users/search?query={}&role={}
GET    /api/v1/users/{id}?include=company,roles

GET    /api/v1/users/me/preferences
PUT    /api/v1/users/me/preferences
GET    /api/v1/users/me/settings
PUT    /api/v1/users/me/settings

GET    /api/v1/users/{id}/roles
PUT    /api/v1/users/{id}/roles

GET    /api/v1/users/{id}/activity?timeframe={}
POST   /api/v1/users/me/picture
DELETE /api/v1/users/{id}

# Domain Service Integration
POST   /api/v1/users/get-or-create
```

## Domain Service Integration Pattern

### Get-or-Create User Endpoint

Domain services (Speaker, Partner, Attendee) use this endpoint when they need to ensure a user exists before creating domain-specific profiles.

**Endpoint**: `POST /api/v1/users/get-or-create`

**Request**:
```json
{
  "email": "jane@example.com",
  "firstName": "Jane",
  "lastName": "Doe",
  "companyId": "comp-123",
  "createIfMissing": true,
  "cognitoSync": true
}
```

**Response**:
```json
{
  "userId": "user-456",
  "created": true,
  "cognitoUserId": "cognito-user-789",
  "user": {
    "id": "user-456",
    "email": "jane@example.com",
    "firstName": "Jane",
    "lastName": "Doe",
    "companyId": "comp-123",
    "roles": ["USER"]
  }
}
```

### Example: Speaker Service Creates Speaker with User

**Organizer Request to Speaker Service**:
```http
POST /api/v1/speakers
{
  "email": "jane@example.com",
  "firstName": "Jane",
  "lastName": "Doe",
  "companyId": "comp-123",
  "expertise": ["cloud architecture", "microservices"],
  "bio": "Expert in distributed systems"
}
```

**Speaker Service Workflow (Synchronous)**:
```
1. Speaker Service → Company & User Service
   POST /api/v1/users/get-or-create
   {email, firstName, lastName, companyId}

2. Company & User Service responds with userId

3. Speaker Service creates speaker profile
   INSERT INTO speakers (user_id, expertise, bio, ...)

4. Speaker Service responds to organizer
   Returns complete speaker object
```

**Benefits of Synchronous Pattern**:
- ✅ Simple to implement and understand
- ✅ Immediate consistency (user exists before domain profile)
- ✅ Clear error handling (if user creation fails, domain creation aborts)
- ✅ No eventual consistency complexity
- ✅ Easier to debug and trace

**Trade-offs**:
- Network hop adds ~100-200ms latency
- Tight coupling between services (acceptable for master data)

### Service Boundary Rules

**Company & User Service owns:**
- User profile (name, email, bio, picture)
- User-company relationship
- User roles (SPEAKER, PARTNER, ORGANIZER, ATTENDEE)
- User preferences and settings
- AWS Cognito synchronization

**Domain Services own:**
- Domain-specific user data
- Speaker Service: expertise, availability, speaking history, slot preferences
- Partner Service: partnership level, voting history, meeting preferences
- Attendee Service: registration history, saved content, recommendations

**Company & User Service MUST NOT know:**
- Speaker expertise or availability (belongs to Speaker Service)
- Partner voting or meeting data (belongs to Partner Service)
- Attendee content preferences (belongs to Attendee Service)

## Performance Requirements

### Company Operations
- Company search/autocomplete: <100ms (P95) with cache
- Company detail: <200ms (P95)
- UID validation: <500ms (P95)

### User Operations
- User search/autocomplete: <100ms (P95) with cache
- Current user (GET /users/me): <100ms (P95) with caching
- User detail: <150ms (P95)
- Get-or-create user: <200ms (P95)
- Role assignment: <150ms (P95)

## Definition of Done

- [ ] All 22 ACs implemented (10 company + 12 user)
- [ ] 88 → 22 endpoints consolidation verified (75% reduction)
- [ ] Company & User consolidated into single service
- [ ] Swiss UID validation working
- [ ] Redis search caching for companies and users
- [ ] Logo and profile picture upload with S3 presigned URLs
- [ ] AWS Cognito integration for user authentication
- [ ] Get-or-create user endpoint for domain services
- [ ] Role-based authorization enforced
- [ ] GDPR-compliant user deletion with cascade
- [ ] User-company relationship management
- [ ] Tests >90% coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 2.0 | Consolidated User Management (Story 1.15a.7) into this service; renamed to Company & User Management Service; added 12 user endpoints | Winston (Architect) |
| 2024-10-04 | 1.0 | Initial draft for companies API consolidation (Phase 3) | Winston (Architect) |
