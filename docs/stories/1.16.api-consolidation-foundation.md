# Story 1.16: API Consolidation Foundation

## Status
Approved

## Story

**As a** backend developer,
**I want** standardized API infrastructure with query parameter utilities and middleware,
**so that** we can implement consolidated RESTful APIs with consistent patterns across all domains.

## Domain Context

### Primary Domain
Shared/Infrastructure - Cross-cutting API standards and utilities

### Involved Services
- API Gateway (middleware, routing, versioning)
- Shared Kernel (query parsers, validation utilities, response formatters)
- All microservices (will consume shared middleware and utilities)

### Cross-Domain Dependencies
- **Enables**: All future API consolidation stories (Events, Partners, Speakers, etc.)
- **Integrates with**: Story 1.2 (API Gateway & Authentication) for routing and auth
- **Integrates with**: Story 1.9 (Error Handling Essentials) for standardized error responses

## Requirements Context

### Related Functional Requirements
- **NFR-API Design**: RESTful API patterns with consistent query parameters
- **NFR-Performance**: Efficient filtering, sorting, and pagination
- **NFR-Developer Experience**: Reusable utilities for all services

### Workflow Steps (if applicable)
N/A - Infrastructure story supporting all workflows

### Acceptance Criteria Source
Derived from API Consolidation Analysis Report (docs/api-consolidation-analysis.md), Phase 1: Foundation (Weeks 1-2)

## Architecture Context

### Architecture Patterns
[Source: docs/architecture/apis/design-principles.md]
- **RESTful Design**: Resource-oriented URLs, standard HTTP methods
- **Query Parameters**: Filter (JSON syntax), sort, pagination, field selection, resource expansion
- **Middleware Pattern**: Reusable request/response processing
- **API Versioning**: URL-based versioning (/api/v1/...)
- **Error Handling**: Standardized error response format

[Source: docs/architecture/06-backend-architecture.md]
- **Service Layer Pattern**: Separation of API layer from business logic
- **Repository Pattern**: Data access abstraction
- **DTO Pattern**: Request/response data transfer objects

### Infrastructure Components
[Source: docs/architecture/02-infrastructure-deployment.md]

**API Gateway**:
- Request validation middleware
- Response formatting middleware
- Error handling middleware
- API versioning support

**Shared Kernel**:
- Query parameter parsers (filter, sort, pagination, fields, include)
- Validation utilities
- Response formatters
- Standard DTOs (ErrorResponse, PaginatedResponse)

**Technology Stack**:
- Spring Boot 3.2+ (backend services)
- Spring Web MVC (REST controllers)
- Jakarta Validation (request validation)
- Jackson (JSON serialization)
- Redis (caching for query results)

## Wireframe Context

### Wireframe References
N/A - Infrastructure story with no direct UI components

### UI Components
N/A - This story provides backend infrastructure that all wireframes will consume through standardized APIs

## Acceptance Criteria

1. **API Versioning Infrastructure**: URL-based versioning implemented (`/api/v1/...`)
2. **Filter Parser Utility**: JSON filter syntax parser supporting comparison operators ($eq, $ne, $gt, $gte, $lt, $lte), logical operators ($and, $or, $not), string operators ($contains, $startsWith), and array operators ($in, $nin)
3. **Sort Parser Utility**: Sort string parser supporting ascending/descending (+/-) and multiple fields
4. **Pagination Utilities**: Page/limit parameter parsing with configurable defaults and maximum limits
5. **Field Selection Parser**: Fields parameter parser for sparse fieldsets
6. **Include/Expand Parser**: Include parameter parser for resource expansion
7. **Request Validation Middleware**: Jakarta Bean Validation integration returning standardized 400 errors
8. **Error Handling Middleware**: Consistent error response format with correlationId, timestamp, path, status, error code, message, details
9. **Response Formatting Middleware**: Standard response wrapper for collections (data + pagination metadata)
10. **Pagination Helper**: Utility to generate pagination metadata (page, limit, total, totalPages, hasNext, hasPrev)
11. **OpenAPI Documentation**: OpenAPI 3.1 spec generation with query parameter documentation
12. **Integration Tests**: Test coverage for all middleware and utilities (>90%)

## Test Specifications (TDD)

### Test Scenarios by Acceptance Criteria

**AC1 Tests: API Versioning**
- Test 1.1: should_routeToV1Controller_when_v1PathRequested
- Test 1.2: should_return404_when_unsupportedVersionRequested
- Test 1.3: should_includeVersionHeader_when_responseReturned

**AC2 Tests: Filter Parser**
- Test 2.1: should_parseBasicEquality_when_simpleFilterProvided
- Test 2.2: should_parseComparisonOperators_when_gtLtProvided
- Test 2.3: should_parseLogicalOperators_when_andOrProvided
- Test 2.4: should_parseStringOperators_when_containsProvided
- Test 2.5: should_parseArrayOperators_when_inProvided
- Test 2.6: should_throwValidationError_when_invalidFilterSyntax

**AC3 Tests: Sort Parser**
- Test 3.1: should_parseAscending_when_fieldNameProvided
- Test 3.2: should_parseDescending_when_minusPrefixProvided
- Test 3.3: should_parseMultipleFields_when_commaSeparatedProvided
- Test 3.4: should_throwValidationError_when_invalidSortFormat

**AC4 Tests: Pagination**
- Test 4.1: should_parsePageAndLimit_when_queryParamsProvided
- Test 4.2: should_useDefaults_when_paramsOmitted
- Test 4.3: should_enforceMaxLimit_when_excessiveLimitRequested
- Test 4.4: should_throwValidationError_when_negativePageProvided

**AC5 Tests: Field Selection**
- Test 5.1: should_parseFieldList_when_commaSeparatedProvided
- Test 5.2: should_returnAllFields_when_fieldsParamOmitted
- Test 5.3: should_throwValidationError_when_unknownFieldRequested

**AC6 Tests: Include/Expand**
- Test 6.1: should_parseIncludeList_when_commaSeparatedProvided
- Test 6.2: should_returnEmptyList_when_includeParamOmitted
- Test 6.3: should_throwValidationError_when_unknownRelationRequested

**AC7-9 Tests: Middleware**
- Test 7.1: should_validateRequest_when_invalidDtoProvided
- Test 7.2: should_return400_when_validationFails
- Test 8.1: should_formatError_when_exceptionThrown
- Test 8.2: should_includeCorrelationId_when_errorOccurs
- Test 9.1: should_wrapCollection_when_listReturned
- Test 9.2: should_includePaginationMetadata_when_paginatedResponse

**AC10 Tests: Pagination Helper**
- Test 10.1: should_generateMetadata_when_paginationDataProvided
- Test 10.2: should_calculateHasNext_when_morePagesExist
- Test 10.3: should_calculateTotalPages_when_totalProvided

**AC11 Tests: OpenAPI Documentation**
- Test 11.1: should_generateSpec_when_controllersAnnotated
- Test 11.2: should_documentQueryParams_when_endpointDefined
- Test 11.3: should_includeSchemas_when_dtosPresent

### Test File Locations

**Shared Kernel Tests:**
- `shared-kernel/src/test/java/ch/batbern/shared/api/FilterParserTest.java`
- `shared-kernel/src/test/java/ch/batbern/shared/api/SortParserTest.java`
- `shared-kernel/src/test/java/ch/batbern/shared/api/PaginationUtilsTest.java`
- `shared-kernel/src/test/java/ch/batbern/shared/api/FieldSelectorTest.java`
- `shared-kernel/src/test/java/ch/batbern/shared/api/IncludeParserTest.java`

**API Gateway Tests:**
- `api-gateway/src/test/java/ch/batbern/gateway/middleware/ValidationMiddlewareTest.java`
- `api-gateway/src/test/java/ch/batbern/gateway/middleware/ErrorHandlingMiddlewareTest.java`
- `api-gateway/src/test/java/ch/batbern/gateway/middleware/ResponseFormattingMiddlewareTest.java`

**Integration Tests:**
- `api-gateway/src/test/integration/ApiConsolidationIntegrationTest.java`

### Test Data & Mocks

**Test Scenarios:**
- Valid/invalid filter JSON
- Valid/invalid sort strings
- Boundary pagination values (negative, zero, max exceeded)
- Valid/invalid field names
- Valid/invalid include relationships

**Mock Services:**
- Mock repository returning test data
- Mock pagination data sets
- Sample DTOs with validation constraints

## Tasks / Subtasks (TDD Workflow)

- [ ] Task 1: Write E2E Tests for Consolidated API (RED Phase)
  - [ ] Write failing E2E test for GET with all query parameters
  - [ ] Write failing test for filter + sort + pagination combination
  - [ ] Verify tests fail with meaningful error messages

- [ ] Task 2: Filter Parser TDD Implementation (AC: 2)
  - [ ] Write failing tests for FilterParser class
  - [ ] Write tests for all operator types ($eq, $gt, $and, $or, $contains, $in)
  - [ ] Write tests for nested field access
  - [ ] Write tests for error cases (invalid JSON, unknown operators)
  - [ ] Implement FilterParser class (GREEN)
  - [ ] Refactor for maintainability (REFACTOR)

- [ ] Task 3: Sort Parser TDD Implementation (AC: 3)
  - [ ] Write failing tests for SortParser class
  - [ ] Write tests for ascending/descending notation
  - [ ] Write tests for multiple fields
  - [ ] Implement SortParser class (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 4: Pagination Utilities TDD Implementation (AC: 4, 10)
  - [ ] Write failing tests for PaginationUtils
  - [ ] Write tests for default values
  - [ ] Write tests for max limit enforcement
  - [ ] Write tests for pagination metadata generation
  - [ ] Implement PaginationUtils (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 5: Field Selection & Include Parsers TDD (AC: 5, 6)
  - [ ] Write failing tests for FieldSelector
  - [ ] Write failing tests for IncludeParser
  - [ ] Implement both utilities (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 6: Request Validation Middleware TDD (AC: 7)
  - [ ] Write failing tests for ValidationMiddleware
  - [ ] Write tests for @Valid annotation integration
  - [ ] Write tests for constraint violation error formatting
  - [ ] Implement middleware (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 7: Error Handling Middleware TDD (AC: 8)
  - [ ] Write failing tests for ErrorHandlingMiddleware
  - [ ] Write tests for various exception types
  - [ ] Write tests for correlationId generation
  - [ ] Write tests for standardized error response format
  - [ ] Implement middleware (GREEN)
  - [ ] Integrate with Story 1.9 error handling
  - [ ] Refactor (REFACTOR)

- [ ] Task 8: Response Formatting Middleware TDD (AC: 9)
  - [ ] Write failing tests for ResponseFormattingMiddleware
  - [ ] Write tests for collection wrapping
  - [ ] Write tests for pagination metadata inclusion
  - [ ] Implement middleware (GREEN)
  - [ ] Refactor (REFACTOR)

- [ ] Task 9: API Versioning Infrastructure (AC: 1)
  - [ ] Configure Spring MVC for versioned routes (/api/v1, /api/v2)
  - [ ] Add version header to responses
  - [ ] Test version routing
  - [ ] Document versioning strategy

- [ ] Task 10: OpenAPI Documentation (AC: 11)
  - [ ] Add springdoc-openapi dependency
  - [ ] Configure OpenAPI annotations
  - [ ] Generate API specification
  - [ ] Document query parameters
  - [ ] Test Swagger UI

- [ ] Task 11: Integration Testing (AC: 12)
  - [ ] Create sample controller with all query parameters
  - [ ] Test complete request/response flow
  - [ ] Test error scenarios
  - [ ] Verify OpenAPI spec generation
  - [ ] Achieve >90% test coverage

- [ ] Task 12: Documentation
  - [ ] Document all utilities in shared-kernel README
  - [ ] Create migration guide for services
  - [ ] Add code examples to API design principles
  - [ ] Document middleware configuration

## Dev Notes - Implementation Guide

### Service Setup

**Shared Kernel Structure:**
```
shared-kernel/
├── src/main/java/ch/batbern/shared/
│   ├── api/
│   │   ├── FilterParser.java           # JSON filter syntax parser
│   │   ├── SortParser.java             # Sort string parser
│   │   ├── PaginationUtils.java        # Pagination helpers
│   │   ├── FieldSelector.java          # Field selection utility
│   │   ├── IncludeParser.java          # Include/expand parser
│   │   └── QueryParams.java            # DTO for all query params
│   ├── dto/
│   │   ├── PaginatedResponse.java      # Standard paginated response
│   │   └── PaginationMetadata.java     # Pagination metadata
│   └── middleware/
│       ├── ValidationMiddleware.java    # Request validation
│       ├── ErrorHandlingMiddleware.java # Error responses
│       └── ResponseFormattingMiddleware.java # Response wrapping
```

**API Gateway Structure:**
```
api-gateway/
├── src/main/java/ch/batbern/gateway/
│   ├── config/
│   │   ├── ApiVersioningConfig.java    # Version routing config
│   │   └── OpenApiConfig.java          # Swagger/OpenAPI config
│   └── controller/
│       └── v1/                          # Version 1 controllers
```

### Technical Design Notes

**1. Filter Parser (FilterParser.java)**

Parses MongoDB-style JSON filter syntax into database queries.

**Input**:
```json
{
  "$and": [
    {"status": "published"},
    {"votes": {"$gte": 10}}
  ]
}
```

**Output**: Database query criteria (JPA Specification or native SQL WHERE clause)

**Supported Operators**:
- Comparison: `$eq`, `$ne`, `$gt`, `$gte`, `$lt`, `$lte`
- Logical: `$and`, `$or`, `$not`
- String: `$contains`, `$startsWith`, `$endsWith`
- Array: `$in`, `$nin`, `$size`
- Null: `$isNull`

**Error Handling**:
- Invalid JSON → 400 Bad Request
- Unknown operator → 400 Bad Request
- Type mismatch → 400 Bad Request

**2. Sort Parser (SortParser.java)**

Parses sort string into database ORDER BY clause.

**Input**: `-votes,+createdAt`

**Output**: `ORDER BY votes DESC, createdAt ASC`

**Syntax**:
- `+field` or `field` → Ascending
- `-field` → Descending
- Multiple fields separated by comma

**3. Pagination Utilities (PaginationUtils.java)**

**Default Values**:
- `page`: 1 (first page, 1-indexed)
- `limit`: 20
- `maxLimit`: 100

**Metadata Generation**:
```java
public static PaginationMetadata generateMetadata(
    int page,
    int limit,
    long total
) {
    int totalPages = (int) Math.ceil((double) total / limit);
    boolean hasNext = page < totalPages;
    boolean hasPrev = page > 1;

    return PaginationMetadata.builder()
        .page(page)
        .limit(limit)
        .total(total)
        .totalPages(totalPages)
        .hasNext(hasNext)
        .hasPrev(hasPrev)
        .build();
}
```

**4. Field Selector (FieldSelector.java)**

**Input**: `id,title,date,venue.name`

**Output**: List of field names with nested field support

**Use**: Reduce JSON payload size by returning only requested fields

**5. Include Parser (IncludeParser.java)**

**Input**: `speakers,venue,sessions`

**Output**: Set of relationship names to eagerly load

**Use**: Implement `?include=` for resource expansion (reduce API calls)

**6. Validation Middleware**

Integrates Jakarta Bean Validation with standardized error responses:

```java
@RestControllerAdvice
public class ValidationMiddleware {

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidation(
        MethodArgumentNotValidException ex,
        HttpServletRequest request
    ) {
        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error -> {
            errors.put(error.getField(), error.getDefaultMessage());
        });

        ErrorResponse response = ErrorResponse.builder()
            .timestamp(Instant.now())
            .path(request.getRequestURI())
            .status(400)
            .error("VALIDATION_ERROR")
            .message("Request validation failed")
            .correlationId(MDC.get("correlationId"))
            .details(Map.of("validationErrors", errors))
            .build();

        return ResponseEntity.badRequest().body(response);
    }
}
```

**7. Error Handling Middleware**

Extends Story 1.9 error handling with API-specific error codes:

```java
@RestControllerAdvice
public class ErrorHandlingMiddleware extends GlobalExceptionHandler {

    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleNotFound(
        ResourceNotFoundException ex
    ) {
        return buildErrorResponse(
            404,
            "RESOURCE_NOT_FOUND",
            ex.getMessage()
        );
    }

    @ExceptionHandler(DuplicateResourceException.class)
    public ResponseEntity<ErrorResponse> handleDuplicate(
        DuplicateResourceException ex
    ) {
        return buildErrorResponse(
            409,
            "DUPLICATE_RESOURCE",
            ex.getMessage()
        );
    }
}
```

**8. Response Formatting Middleware**

Wraps collection responses with pagination metadata:

```java
@RestControllerAdvice
public class ResponseFormattingMiddleware implements ResponseBodyAdvice<Object> {

    @Override
    public Object beforeBodyWrite(
        Object body,
        MethodParameter returnType,
        MediaType selectedContentType,
        Class selectedConverterType,
        ServerHttpRequest request,
        ServerHttpResponse response
    ) {
        // If response is a List and request has pagination params
        if (body instanceof List && hasPaginationParams(request)) {
            List<?> data = (List<?>) body;
            PaginationMetadata meta = extractPaginationMetadata(request);

            return PaginatedResponse.builder()
                .data(data)
                .pagination(meta)
                .build();
        }

        return body;
    }
}
```

### API Contracts

**Query Parameters Standard**:

All GET endpoints support:
- `filter` (string): JSON filter object
- `sort` (string): Sort specification
- `page` (integer): Page number (default: 1)
- `limit` (integer): Items per page (default: 20, max: 100)
- `fields` (string): Comma-separated field list
- `include` (string): Comma-separated relation list

**Standard Responses**:

**Single Resource**:
```json
{
  "id": "uuid-123",
  "title": "Example",
  "status": "published",
  "createdAt": "2024-10-04T10:00:00Z",
  "updatedAt": "2024-10-04T10:00:00Z"
}
```

**Collection (Paginated)**:
```json
{
  "data": [
    {"id": "uuid-123", "title": "Item 1"},
    {"id": "uuid-456", "title": "Item 2"}
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45,
    "totalPages": 3,
    "hasNext": true,
    "hasPrev": false
  }
}
```

**Error Response**:
```json
{
  "timestamp": "2024-10-04T10:00:00Z",
  "path": "/api/v1/events",
  "status": 400,
  "error": "VALIDATION_ERROR",
  "message": "Request validation failed",
  "correlationId": "abc-123-def",
  "details": {
    "validationErrors": {
      "title": "Title is required",
      "date": "Date must be in the future"
    }
  }
}
```

### Testing Requirements

**Unit Test Coverage**: >90% for all utilities and middleware

**Integration Test Scenarios**:
- Complete request/response flow with all query parameters
- Error scenarios (invalid filter, exceeded limit, etc.)
- Pagination metadata correctness
- Field selection accuracy
- Include/expand functionality

**Performance Requirements**:
- Filter parsing: <10ms (P95)
- Sort parsing: <5ms (P95)
- Pagination metadata generation: <1ms (P95)
- Total middleware overhead: <20ms (P95)

## Definition of Done Checklist

### Development Complete
- [ ] All tests written BEFORE implementation (TDD followed)
- [ ] All acceptance criteria have corresponding tests
- [ ] All acceptance criteria implemented
- [ ] Unit tests written and passing (>90% coverage)
- [ ] Integration tests cover new functionality (>85% coverage)
- [ ] Code follows project conventions
- [ ] All utilities properly documented with JavaDoc
- [ ] API documentation updated

### Infrastructure Complete ⚠️ CRITICAL
- [ ] Shared kernel utilities deployed and accessible to all services
- [ ] API Gateway middleware configured and operational
- [ ] API versioning infrastructure tested
- [ ] OpenAPI specification generated and accessible
- [ ] Swagger UI accessible at /api/docs

### Operational Complete
- [ ] Filter parser handles all operator types correctly
- [ ] Sort parser supports multi-field sorting
- [ ] Pagination enforces max limits
- [ ] Field selection reduces payload size
- [ ] Include parser enables resource expansion
- [ ] Validation middleware returns standardized errors
- [ ] Error handling middleware consistent with Story 1.9
- [ ] Response formatting adds pagination metadata
- [ ] Integration tests verify all functionality

### Review Ready
- [ ] PR created with detailed description
- [ ] Code review completed by team
- [ ] Infrastructure review completed
- [ ] Documentation updated (README, API design principles)
- [ ] Migration guide created for service teams
- [ ] Example controller demonstrating all features

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-10-04 | 1.0 | Initial story creation for API Consolidation Phase 1 | Winston (Architect) |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent during implementation_

### Implementation Approach
_To be documented by dev agent with actual approach taken_

### Debug Log References
_To be populated with debug log references during development_

### Completion Notes
_To be filled with issues encountered and resolutions_

### Files Changed
_To be populated with list of created, modified, and deleted files_

### Deployment Notes
_Special deployment considerations for API consolidation infrastructure_

## QA Results
_To be populated by QA Agent after implementation review_
