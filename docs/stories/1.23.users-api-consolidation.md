# Story 1.23: Users API Consolidation

## Status
Draft

## Story

**As a** system administrator,
**I want** consolidated User APIs with role and preference management,
**so that** I can efficiently manage user accounts and settings.

## Domain Context

### Primary Domain
Shared Infrastructure & Core Services - User Management

### Involved Services
- API Gateway (user management endpoints)
- AWS Cognito (user pool management)
- Shared Kernel (query utilities from Story 1.16)
- ElastiCache Redis (user session caching)

### Cross-Domain Dependencies
- **Depends on**: Story 1.16 (API Consolidation Foundation)
- **Depends on**: Story 1.2 (API Gateway & Authentication) for Cognito integration
- **Integrates with**: All services for user context

## Requirements Context

### Related Functional Requirements
- **FR1**: Role-based authentication
- **FR27**: User profile management
- **NFR-Security**: User data protection and GDPR compliance

### Acceptance Criteria Source
API Consolidation Analysis (docs/api-consolidation-analysis.md), Phase 3 - Users Domain

## Architecture Context

### Architecture Patterns
[Source: docs/api-consolidation-analysis.md]
- **Before**: 46 endpoints
- **After**: 12 endpoints
- **Reduction**: 74%
- **Profile Expansion**: `?include=preferences,settings,activity`
- **Bulk User Operations**: Batch role assignment

## Wireframe Context

### Wireframe References
- `story-1.2-account-creation.md` - User registration
- Admin user management screens

## Acceptance Criteria

1. **List Users**: `GET /api/v1/users?filter={}&sort={}&page={}` (admin only)
2. **Search Users**: `GET /api/v1/users/search?query={}&role={}` (admin only)
3. **Get User**: `GET /api/v1/users/{id}?include=profile,preferences,settings,activity,companies`
4. **Get Current User**: `GET /api/v1/users/me`
5. **Update User**: PUT/PATCH `/api/v1/users/{id}`
6. **Update Current User**: PUT/PATCH `/api/v1/users/me`
7. **Delete User**: `DELETE /api/v1/users/{id}` with GDPR cascade
8. **User Preferences**: GET/PUT `/api/v1/users/{id}/preferences`
9. **User Settings**: GET/PUT `/api/v1/users/{id}/settings`
10. **Role Management**: GET/PUT `/api/v1/users/{id}/roles` (admin only)
11. **Activity History**: `GET /api/v1/users/{id}/activity?timeframe={}`
12. **Bulk Operations**: PATCH `/api/v1/users` for batch role updates

## Consolidated Endpoints (12 Total)

```
# User CRUD
GET    /api/v1/users?filter={}&sort={}&page={}
GET    /api/v1/users/search?query={}&role={}
GET    /api/v1/users/{id}?include=profile,preferences,settings,activity,companies
GET    /api/v1/users/me
PUT    /api/v1/users/{id}
PATCH  /api/v1/users/{id}
PUT    /api/v1/users/me
PATCH  /api/v1/users/me
DELETE /api/v1/users/{id}

# User Management
GET    /api/v1/users/{id}/preferences
PUT    /api/v1/users/{id}/preferences
GET    /api/v1/users/{id}/settings
PUT    /api/v1/users/{id}/settings

GET    /api/v1/users/{id}/roles
PUT    /api/v1/users/{id}/roles

GET    /api/v1/users/{id}/activity?timeframe={}

# Bulk Operations
PATCH  /api/v1/users
```

## Performance Requirements

- User search: <200ms (P95)
- User detail: <150ms (P95)
- Current user: <100ms (P95) with caching

## Definition of Done

- [ ] All 12 ACs implemented
- [ ] 46 â†’ 12 endpoints consolidation verified
- [ ] Role-based access control enforced
- [ ] GDPR-compliant user deletion
- [ ] Tests >90% coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-10-04 | 1.0 | Users API consolidation (Phase 3) | Winston (Architect) |
