# Story 1.14: Company Management Service Foundation

## Status
Draft

## Story
**As a** partner or attendee,
**I want** my company affiliation to be properly managed and verified,
**so that** I can access company-specific features and analytics while maintaining data integrity.

## Domain Context

### Primary Domain
Shared Infrastructure & Core Services - Company Management bounded context supporting all domains

### Involved Services
- Company Management Service (new service to be created)
- API Gateway (routing and authentication)
- Shared Kernel (common types and domain events)
- AWS S3 (company logo storage)
- ElastiCache Redis (company search caching)
- **API Consolidation Foundation**: Story 1.15a (FilterParser, SortParser, PaginationUtils, FieldSelector, IncludeParser)
- **API Specifications**: Story 1.15a.6 (Companies API Consolidation), Story 1.15a.2 (Partners API Consolidation)

### Cross-Domain Dependencies
- **Enables**: All future domain services requiring company data (Event Management, Speaker Coordination, Partner Analytics, Attendee Experience)
- **Integrates with**: Story 1.2 (API Gateway) for routing and authentication
- **Integrates with**: Story 1.1 (Shared Kernel) for domain events and common types
- **Publishes Events**: CompanyCreatedEvent, PartnerStatusChangedEvent to EventBridge

## Requirements Context

### Related Functional Requirements
- **FR1**: Role-based authentication with company affiliations for partners and speakers
- **FR4**: Partner users access company-specific analytics (requires company data foundation)
- **NFR-Data Quality**: Swiss company UID validation for data integrity
- **CR1**: Migrate all existing event data including company relationships

### Workflow Steps (if applicable)
N/A - Foundation service supporting all workflows

### Acceptance Criteria Source
Epic 1, Story 1.14, Lines 861-903 (Company Management Service Foundation)

## Architecture Context

### Architecture Patterns
[Source: architecture/06-backend-architecture.md#service-architecture-pattern]
- **Domain-Driven Design**: Company as aggregate root with proper bounded context
- **Repository Pattern**: JPA repositories with custom query methods
- **Service Layer**: Business logic separation from controllers
- **DTO Pattern**: Clear separation between domain models and API contracts

[Source: architecture/03-data-architecture.md#company-data-model]
- **Company Entity**: UUID identifier, name, partner status, logo metadata
- **Swiss UID Validation**: Integration with Swiss business register for company validation

[Source: architecture/04-api-design.md#rest-api-specification]
- **RESTful API Design**: Standard CRUD operations with OpenAPI 3.1 documentation
- **Search Functionality**: Company autocomplete with Redis caching for performance
- **File Upload**: Presigned S3 URLs for direct logo uploads (no proxy through backend)

### Infrastructure Components
[Source: architecture/02-infrastructure-deployment.md]

**Application Infrastructure:**
- **ECS Fargate Service**: Containerized Company Management Service deployment
- **Application Load Balancer**: Health checks and traffic distribution
- **Auto-scaling**: Environment-specific scaling policies (min 2, max 10 instances)

**Database:**
- **RDS PostgreSQL**: Company management database with proper indexes
- **Flyway Migrations**: Schema versioning for companies table
- **Connection Pooling**: PgBouncer or RDS Proxy for connection management

**Caching:**
- **ElastiCache Redis**: Company search results caching with 15-minute TTL
- **Cache Invalidation**: Event-driven cache clearing on company updates

**Storage:**
- **S3 Bucket**: `batbern-{environment}-company-logos` with CloudFront integration
- **Presigned URLs**: Secure 15-minute upload URLs generated by backend

**Event Bus:**
- **EventBridge**: Domain events for company lifecycle (CompanyCreatedEvent, PartnerStatusChangedEvent)
- **Event Schema Registry**: Versioned event schemas in shared-kernel

## Wireframe Context

### Wireframe References
N/A - Backend service with no direct UI components in this story

### UI Components
Company selection and display will be implemented in future stories:
- Company autocomplete search (Speaker/Partner registration)
- Company profile display (Partner analytics dashboard)
- Company logo display (Event speaker listings)

## Acceptance Criteria

### Core Company Management (ACs 1-12)

1. **Company Entity**: Create Company aggregate with Swiss business validation (UID register integration)
2. **Company Profiles**: Support company metadata (logo, description, contact information)
3. **Data Validation**: Validate Swiss company UIDs and maintain data quality
4. **REST API**: Implement OpenAPI-documented endpoints for company CRUD operations
5. **Search Functionality**: Enable company search with autocomplete using Redis caching
6. **Company Verification**: Automated verification workflows for new company registrations
7. **Domain Events**: Publish CompanyCreatedEvent, CompanyUpdatedEvent, CompanyDeletedEvent to EventBridge
8. **File Storage**: Secure logo upload to S3 with CDN integration
9. **Search Cache**: Implement Redis-based company search with automatic cache invalidation
10. **Authentication Integration**: Provide company context for authentication (no user relationship management)

### API Consolidation - Additional Endpoints (ACs 11-13) - From Story 1.15a.6

11. **Advanced Search Endpoint**: `GET /api/v1/companies/search?query={}&limit={}` with Redis caching (<100ms P95)
12. **Swiss UID Validation Endpoint**: `GET /api/v1/companies/validate-uid?uid={}` with business registry integration
13. **Verification Workflow**: `POST /api/v1/companies/{id}/verify` with approval logic

### Advanced Query Patterns (ACs 14-15) - From Story 1.15a

14. **Advanced Query Patterns**: Support `?filter={}`, `?sort={}`, `?page={}`, `?limit={}`, `?fields={}` using Story 1.15a utilities (FilterParser, SortParser, PaginationUtils, FieldSelector)
15. **Resource Expansion**: Support `?include=statistics,logo` to reduce API calls from 3+ to 1 (<200ms P95 with all includes)

## Test Specifications (TDD)

### Test Scenarios by Acceptance Criteria

**AC1-3 Tests: Company Domain Model and Validation**
- Test 1.1: should_createCompany_when_validDataProvided
- Test 1.2: should_validateSwissUID_when_companyCreated
- Test 1.3: should_throwValidationException_when_invalidUIDProvided
- Test 2.1: should_storeCompanyMetadata_when_profileProvided
- Test 2.2: should_validateWebsiteURL_when_provided
- Test 2.3: should_handleOptionalFields_when_notProvided
- Test 3.1: should_validateRequiredFields_when_companyCreated
- Test 3.2: should_enforceNameUniqueness_when_duplicateDetected

**AC4-5 Tests: REST API and Search**
- Test 4.1: should_createCompany_when_validRequestReceived
- Test 4.2: should_getCompanyById_when_companyExists
- Test 4.3: should_updateCompany_when_validUpdateRequest
- Test 4.4: should_deleteCompany_when_requested
- Test 4.5: should_return404_when_companyNotFound
- Test 4.6: should_returnOpenAPISpec_when_accessed
- Test 5.1: should_searchCompanies_when_queryProvided
- Test 5.2: should_returnAutocompleteResults_when_partialNameProvided
- Test 5.3: should_cacheSearchResults_when_queryExecuted
- Test 5.4: should_returnCachedResults_when_availableInRedis

**AC6 Tests: Company Verification**
- Test 6.1: should_initiateVerification_when_newCompanyCreated
- Test 6.2: should_validateBusinessRegistry_when_verificationStarted
- Test 6.3: should_markVerified_when_validationPasses
- Test 6.4: should_flagForManualReview_when_validationFails

**AC7 Tests: Domain Events**
- Test 7.1: should_publishCompanyCreatedEvent_when_companyCreated
- Test 7.2: should_publishCompanyUpdatedEvent_when_companyUpdated
- Test 7.3: should_includeCompanyId_when_eventPublished
- Test 7.4: should_sendToEventBridge_when_eventCreated

**AC8-9 Tests: File Storage and Caching**
- Test 8.1: should_generatePresignedURL_when_logoUploadRequested
- Test 8.2: should_validateFileType_when_imageUploaded
- Test 8.3: should_storeS3Key_when_uploadCompleted
- Test 8.4: should_serveThroughCloudFront_when_logoRequested
- Test 9.1: should_cacheSearchResults_when_queryExecuted
- Test 9.2: should_invalidateCache_when_companyUpdated
- Test 9.3: should_setTTL_when_cacheEntryCreated
- Test 9.4: should_returnFreshData_when_cacheExpired

**AC10 Tests: Authentication Integration**
- Test 10.1: should_provideCompanyContext_when_authenticated
- Test 10.2: should_returnCompanyDetails_when_requested
- Test 10.3: should_supportCompanyContextQuery_when_needed

**AC11-12 Tests: Advanced Search and UID Validation**
- Test 11.1: should_returnSearchResults_when_queryProvided
- Test 11.2: should_cacheSearchResults_when_searchExecuted
- Test 11.3: should_returnCachedResults_when_availableInRedis
- Test 11.4: should_limitResults_when_limitParameterProvided
- Test 12.1: should_validateUID_when_validSwissUIDProvided
- Test 12.2: should_returnInvalid_when_invalidUIDFormat
- Test 12.3: should_integrateBusinessRegistry_when_validationRequested
- Test 12.4: should_cacheValidationResults_when_uidValidated

**AC13 Tests: Verification Workflow**
- Test 13.1: should_initiateVerification_when_requested
- Test 13.2: should_executeApprovalLogic_when_verificationStarted
- Test 13.3: should_updateVerificationStatus_when_approved

**AC14 Tests: Advanced Query Patterns**
- Test 14.1: should_filterResults_when_filterParameterProvided
- Test 14.2: should_sortResults_when_sortParameterProvided
- Test 14.3: should_paginateResults_when_pageParameterProvided
- Test 14.4: should_selectFields_when_fieldsParameterProvided
- Test 14.5: should_combineQueryParameters_when_multipleParametersProvided

**AC15 Tests: Resource Expansion**
- Test 15.1: should_includeStatistics_when_includeParameterContainsStatistics
- Test 15.2: should_includeLogo_when_includeParameterContainsLogo
- Test 15.3: should_includeMultipleResources_when_multipleIncludesProvided
- Test 15.4: should_meetPerformanceTarget_when_allResourcesIncluded

### Test File Locations

**Company Management Service Tests:**
- `services/company-management/src/test/java/ch/batbern/company/domain/CompanyTest.java`
- `services/company-management/src/test/java/ch/batbern/company/service/CompanyServiceTest.java`
- `services/company-management/src/test/java/ch/batbern/company/service/SwissUIDValidationServiceTest.java`
- `services/company-management/src/test/java/ch/batbern/company/service/CompanySearchServiceTest.java`
- `services/company-management/src/test/integration/CompanyControllerIntegrationTest.java`
- `services/company-management/src/test/integration/CompanySearchIntegrationTest.java`
- `services/company-management/src/test/integration/AdvancedQueryIntegrationTest.java`
- `services/company-management/src/test/integration/repository/CompanyRepositoryTest.java`

**Infrastructure Tests:**
- `infrastructure/test/company-management-stack.test.ts`

**E2E Tests:**
- `e2e/workflows/company-management/company-creation.spec.ts`
- `e2e/workflows/company-management/company-search.spec.ts`

### Test Data & Mocks

**Test Data Builders:**
- CompanyTestDataBuilder for creating test companies with valid/invalid data

**Mock Services:**
- Mock Swiss UID validation service with valid/invalid responses
- Mock AWS S3 client for presigned URL generation
- Mock Redis client for cache operations
- Mock EventBridge client for domain event publishing
- Mock AWS Cognito for user authentication context

**Test Containers:**
- PostgreSQL 15 container for integration tests
- Redis 7.2 container for cache integration tests
- LocalStack for S3 and EventBridge mocking

## Implementation Guidance

### Logo Upload Implementation (AC10)

**Architecture Reference:** [PRD Section 4.2 - Content Management & Storage Architecture](../prd-enhanced.md#42-content-management--storage-architecture), [Infrastructure Doc S3 Section](../architecture/02-infrastructure-deployment.md#aws-s3-content-storage-infrastructure)

**Implementation Pattern:**

Use the ContentStorageService from the content management architecture (see architecture docs) with the following workflow:

1. **Generate Presigned Upload URL:**
   ```java
   // CompanyLogoService.java
   @Service
   public class CompanyLogoService {
       private final ContentStorageService contentStorageService;

       public PresignedUploadUrl generateLogoUploadUrl(String userId, String filename, long fileSizeBytes) {
           // Validate file size (max 5 MB for logos per PRD Section 4.2)
           if (fileSizeBytes > 5 * 1024 * 1024) {
               throw new FileSizeExceededException("Logo file size exceeds 5MB limit");
           }

           // Validate file extension (PNG, JPG, SVG only)
           validateLogoFileType(filename);

           // Generate presigned URL for S3 upload (15-minute expiration)
           return contentStorageService.generatePresignedUploadUrl(
               userId,
               ContentType.LOGO,
               filename,
               fileSizeBytes,
               getMimeType(filename)
           );
       }
   }
   ```

2. **Frontend Direct Upload:**
   - Frontend receives presigned URL from backend
   - Frontend uploads directly to S3 using presigned URL (no proxy through backend)
   - Frontend calls confirm endpoint with file ID and checksum

3. **Confirm Upload and Store Reference:**
   ```java
   public void confirmLogoUpload(UUID companyId, String fileId, String checksum) {
       // Verify upload and get CDN URL
       ContentMetadata metadata = contentStorageService.confirmUpload(fileId, checksum);

       // Update company with logo reference
       Company company = companyRepository.findById(companyId)
           .orElseThrow(() -> new CompanyNotFoundException(companyId));

       company.setLogoUrl(metadata.getCloudFrontUrl());
       company.setLogoS3Key(metadata.getS3Key());
       company.setLogoFileId(metadata.getFileId());

       companyRepository.save(company);
   }
   ```

**File Constraints (from PRD Section 4.2):**
- **Max Size:** 5 MB
- **Allowed Formats:** PNG, JPG, SVG
- **Dimensions:** 500x500 to 2000x2000 pixels
- **Storage Bucket:** `batbern-{environment}-logos`
- **CloudFront CDN:** `https://cdn.batbern.ch/logos/...`

**S3 Key Pattern (from Infrastructure Docs):**
```
/logos/{year}/{company-id}/{filename-with-uuid}.{ext}
Example: /logos/2024/company-789/logo-f3e8d1a4.png
```

**Test Considerations:**
- Mock ContentStorageService for unit tests
- Use LocalStack S3 for integration tests
- Verify presigned URL expiration (15 minutes)
- Test file size validation (reject > 5MB)
- Test file type validation (reject non-image files)
- Verify CloudFront URL format in company response

## Tasks / Subtasks (TDD Workflow)

- [ ] Task 1: Write E2E Tests for Company Management (RED Phase)
  - [ ] Write failing E2E test for company creation workflow
  - [ ] Write failing E2E test for company search functionality
  - [ ] Verify tests fail with meaningful error messages

- [ ] Task 2: Domain Model TDD Implementation (AC: 1, 2, 3, 4)
  - [ ] Write failing tests for Company aggregate
  - [ ] Write failing tests for Swiss UID validation
  - [ ] Write failing tests for company metadata validation
  - [ ] Implement Company aggregate with validation (GREEN)
  - [ ] Integrate Swiss UID validation service (GREEN)
  - [ ] Refactor domain model for maintainability (REFACTOR)

- [ ] Task 3: Repository Layer TDD Implementation (AC: 1, 2)
  - [ ] Write failing tests for CompanyRepository
  - [ ] Write failing tests for custom query methods
  - [ ] Implement JPA repositories with Spring Data (GREEN)
  - [ ] Add custom query methods for search (GREEN)
  - [ ] Create database indexes for performance (GREEN)
  - [ ] Refactor repository implementations (REFACTOR)

- [ ] Task 4: Service Layer TDD Implementation (AC: 4, 7, 8)
  - [ ] Write failing tests for CompanyService CRUD operations
  - [ ] Write failing tests for partner management logic
  - [ ] Write failing tests for verification workflows
  - [ ] Implement CompanyService with business logic (GREEN)
  - [ ] Implement PartnerService with enhanced privileges (GREEN)
  - [ ] Implement CompanyVerificationService (GREEN)
  - [ ] Refactor service layer (REFACTOR)

- [ ] Task 5: REST API TDD Implementation (AC: 5)
  - [ ] Write failing tests for CompanyController endpoints
  - [ ] Write failing tests for request/response validation
  - [ ] Write failing tests for error scenarios
  - [ ] Implement REST controllers with Spring Web (GREEN)
  - [ ] Add OpenAPI annotations for documentation (GREEN)
  - [ ] Implement request validation with @Valid (GREEN)
  - [ ] Refactor controllers (REFACTOR)

- [ ] Task 6: Search & Caching TDD Implementation (AC: 6, 11)
  - [ ] Write failing tests for search functionality
  - [ ] Write failing tests for Redis caching
  - [ ] Write failing tests for cache invalidation
  - [ ] Implement CompanySearchService with autocomplete (GREEN)
  - [ ] Integrate Redis for search result caching (GREEN)
  - [ ] Implement cache invalidation on updates (GREEN)
  - [ ] Refactor search and caching logic (REFACTOR)

- [ ] Task 7: File Storage TDD Implementation (AC: 10)
  - [ ] Write failing tests for presigned URL generation
  - [ ] Write failing tests for S3 integration
  - [ ] Write failing tests for file validation
  - [ ] Implement CompanyLogoService with S3 integration (GREEN)
  - [ ] Generate presigned URLs for secure uploads (GREEN)
  - [ ] Validate file types and sizes (GREEN)
  - [ ] Refactor file storage logic (REFACTOR)

- [ ] Task 8: Domain Events TDD Implementation (AC: 9)
  - [ ] Write failing tests for event publishing
  - [ ] Write failing tests for EventBridge integration
  - [ ] Implement CompanyEventPublisher (GREEN)
  - [ ] Integrate with EventBridge (GREEN)
  - [ ] Refactor event publishing (REFACTOR)

- [ ] Task 9: Authentication Integration TDD (AC: 12)
  - [ ] Write failing tests for user-company validation
  - [ ] Write failing tests for access control
  - [ ] Implement CompanySecurityService (GREEN)
  - [ ] Integrate with API Gateway authentication (GREEN)
  - [ ] Refactor authentication logic (REFACTOR)

- [ ] Task 10: Infrastructure Setup (All ACs)
  - [ ] Create CDK stack for Company Management Service
  - [ ] Configure ECS Fargate service with auto-scaling
  - [ ] Set up RDS PostgreSQL database with Flyway
  - [ ] Configure ElastiCache Redis cluster
  - [ ] Create S3 bucket for company logos with CloudFront
  - [ ] Configure EventBridge rules and targets
  - [ ] Set up API Gateway routes for company endpoints
  - [ ] Configure CloudWatch alarms and dashboards

- [ ] Task 11: Database Migrations (AC: 1, 2)
  - [ ] Create Flyway migration for companies table
  - [ ] Create database indexes for performance
  - [ ] Test migrations in all environments

- [ ] Task 12: Docker Compose Integration
  - [ ] Create Dockerfile.dev for hot reload development
  - [ ] Add company-management service to docker-compose.yml
  - [ ] Configure environment variables in .env.example
  - [ ] Test local development environment

- [ ] Task 13: Documentation and Integration Testing
  - [ ] Generate OpenAPI specification
  - [ ] Write comprehensive integration tests
  - [ ] Create developer onboarding documentation
  - [ ] Test service in all environments

- [ ] Task 14: Advanced Query Patterns Implementation (AC: 21, 22)
  - [ ] Write failing tests for FilterParser integration
  - [ ] Write failing tests for SortParser integration
  - [ ] Write failing tests for PaginationUtils integration
  - [ ] Write failing tests for FieldSelector integration
  - [ ] Write failing tests for IncludeParser (resource expansion)
  - [ ] Implement query parameter middleware in CompanyController (GREEN)
  - [ ] Implement resource expansion in CompanyService (GREEN)
  - [ ] Optimize performance for expanded queries with caching (GREEN)
  - [ ] Refactor query handling code (REFACTOR)

- [ ] Task 15: Additional Company Endpoints Implementation (AC: 11-13)
  - [ ] Write failing tests for advanced search endpoint (/companies/search)
  - [ ] Write failing tests for UID validation endpoint (/companies/validate-uid)
  - [ ] Write failing tests for verification workflow endpoint
  - [ ] Implement CompanySearchController with Redis caching (GREEN)
  - [ ] Implement CompanyVerificationController (GREEN)
  - [ ] Add OpenAPI documentation for all endpoints (GREEN)
  - [ ] Refactor and optimize new endpoints (REFACTOR)

## Dev Notes - Implementation Guide

### Service Setup

**Company Management Service Structure:**
```
services/company-management/
├── src/main/java/ch/batbern/company/
│   ├── controller/
│   │   ├── CompanyController.java                # REST API endpoints
│   │   └── CompanyLogoController.java           # Logo upload endpoints
│   ├── service/
│   │   ├── CompanyService.java                   # Core business logic
│   │   ├── CompanySearchService.java            # Search and autocomplete
│   │   ├── CompanyVerificationService.java      # Verification workflows
│   │   ├── CompanyLogoService.java              # S3 logo management
│   │   ├── SwissUIDValidationService.java       # Swiss UID validation
│   │   └── CompanyEventPublisher.java           # Domain event publishing
│   ├── repository/
│   │   └── CompanyRepository.java                # JPA repository
│   ├── domain/
│   │   ├── Company.java                          # Company aggregate root
│   │   ├── CompanyLogo.java                     # Logo value object
│   │   └── Address.java                         # Address value object
│   ├── dto/
│   │   ├── CreateCompanyRequest.java            # Creation DTO
│   │   ├── UpdateCompanyRequest.java            # Update DTO
│   │   ├── CompanyResponse.java                 # Response DTO
│   │   └── CompanySearchResponse.java           # Search result DTO
│   ├── exception/
│   │   ├── CompanyNotFoundException.java         # Not found exception
│   │   ├── InvalidUIDException.java             # UID validation exception
│   │   └── CompanyValidationException.java      # Validation exception
│   └── config/
│       ├── RedisConfig.java                      # Redis configuration
│       ├── S3Config.java                        # S3 configuration
│       └── EventBridgeConfig.java               # EventBridge configuration
├── src/main/resources/
│   ├── application.yml                          # Service configuration
│   └── db/migration/
│       └── V1__create_companies_table.sql       # Companies table
└── src/test/java/ch/batbern/company/
    ├── unit/                                    # Unit tests
    ├── integration/                             # Integration tests
    └── TestcontainersConfiguration.java         # Testcontainers setup
```

### Technical Design Notes

**1. Company Aggregate (domain/Company.java)**

```java
package ch.batbern.company.domain;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.GenericGenerator;

import java.time.Instant;
import java.util.UUID;

@Entity
@Table(name = "companies", indexes = {
    @Index(name = "idx_company_name", columnList = "name"),
    @Index(name = "idx_company_uid", columnList = "swiss_uid")
})
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class Company {

    @Id
    @GeneratedValue(generator = "UUID")
    @GenericGenerator(name = "UUID", strategy = "org.hibernate.id.UUIDGenerator")
    @Column(name = "id", updatable = false, nullable = false)
    private UUID id;

    @Column(name = "name", nullable = false, unique = true, length = 255)
    private String name;

    @Column(name = "display_name", length = 255)
    private String displayName;

    @Column(name = "is_partner", nullable = false)
    private boolean isPartner = false;

    @Column(name = "swiss_uid", length = 20)
    private String swissUID;

    @Embedded
    private CompanyLogo logo;

    @Column(name = "website", length = 500)
    private String website;

    @Column(name = "industry", length = 100)
    private String industry;

    @Embedded
    private Address headquarters;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "is_verified", nullable = false)
    private boolean isVerified = false;

    @Column(name = "created_at", nullable = false, updatable = false)
    private Instant createdAt;

    @Column(name = "updated_at", nullable = false)
    private Instant updatedAt;

    @Column(name = "created_by", nullable = false, length = 255)
    private String createdBy;

    @PrePersist
    protected void onCreate() {
        createdAt = Instant.now();
        updatedAt = Instant.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = Instant.now();
    }

    // Business methods
    public void promoteToPartner() {
        this.isPartner = true;
        this.updatedAt = Instant.now();
    }

    public void demoteFromPartner() {
        this.isPartner = false;
        this.updatedAt = Instant.now();
    }

    public void markAsVerified() {
        this.isVerified = true;
        this.updatedAt = Instant.now();
    }
}
```

**2. Company Service (service/CompanyService.java)**

```java
package ch.batbern.company.service;

import ch.batbern.company.domain.Company;
import ch.batbern.company.dto.*;
import ch.batbern.company.exception.*;
import ch.batbern.company.repository.CompanyRepository;
import ch.batbern.shared.util.SecurityContextHelper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
@Transactional
@RequiredArgsConstructor
@Slf4j
public class CompanyService {

    private final CompanyRepository companyRepository;
    private final SwissUIDValidationService uidValidationService;
    private final CompanyEventPublisher eventPublisher;
    private final CompanySearchService searchService;
    private final SecurityContextHelper securityContext;

    public CompanyResponse createCompany(CreateCompanyRequest request) {
        log.info("Creating company: {}", request.getName());

        // Validate Swiss UID if provided
        if (request.getSwissUID() != null) {
            if (!uidValidationService.isValidUID(request.getSwissUID())) {
                throw new InvalidUIDException(request.getSwissUID());
            }
        }

        // Check for duplicate company name
        if (companyRepository.existsByName(request.getName())) {
            throw new CompanyValidationException("Company with name '" + request.getName() + "' already exists");
        }

        Company company = Company.builder()
                .name(request.getName())
                .displayName(request.getDisplayName() != null ? request.getDisplayName() : request.getName())
                .swissUID(request.getSwissUID())
                .website(request.getWebsite())
                .industry(request.getIndustry())
                .description(request.getDescription())
                .isPartner(false)
                .isVerified(false)
                .createdBy(securityContext.getCurrentUser().getUserId())
                .build();

        Company savedCompany = companyRepository.save(company);

        // Invalidate search cache
        searchService.invalidateCache();

        // Publish domain event
        eventPublisher.publishCompanyCreatedEvent(savedCompany);

        log.info("Company created successfully: {}", savedCompany.getId());
        return mapToResponse(savedCompany);
    }

    @Transactional(readOnly = true)
    public CompanyResponse getCompanyById(UUID id) {
        Company company = companyRepository.findById(id)
                .orElseThrow(() -> new CompanyNotFoundException(id.toString()));
        return mapToResponse(company);
    }

    @Transactional(readOnly = true)
    public List<CompanyResponse> getAllCompanies() {
        return companyRepository.findAll().stream()
                .map(this::mapToResponse)
                .collect(Collectors.toList());
    }

    public CompanyResponse updateCompany(UUID id, UpdateCompanyRequest request) {
        log.info("Updating company: {}", id);

        Company company = companyRepository.findById(id)
                .orElseThrow(() -> new CompanyNotFoundException(id.toString()));

        // Update fields
        if (request.getName() != null) {
            company.setName(request.getName());
        }
        if (request.getDisplayName() != null) {
            company.setDisplayName(request.getDisplayName());
        }
        if (request.getWebsite() != null) {
            company.setWebsite(request.getWebsite());
        }
        if (request.getIndustry() != null) {
            company.setIndustry(request.getIndustry());
        }
        if (request.getDescription() != null) {
            company.setDescription(request.getDescription());
        }

        Company updatedCompany = companyRepository.save(company);

        // Invalidate search cache
        searchService.invalidateCache();

        log.info("Company updated successfully: {}", id);
        return mapToResponse(updatedCompany);
    }

    public void deleteCompany(UUID id) {
        log.info("Deleting company: {}", id);

        Company company = companyRepository.findById(id)
                .orElseThrow(() -> new CompanyNotFoundException(id.toString()));

        companyRepository.delete(company);

        // Invalidate search cache
        searchService.invalidateCache();

        log.info("Company deleted successfully: {}", id);
    }

    private CompanyResponse mapToResponse(Company company) {
        return CompanyResponse.builder()
                .id(company.getId())
                .name(company.getName())
                .displayName(company.getDisplayName())
                .isPartner(company.isPartner())
                .swissUID(company.getSwissUID())
                .website(company.getWebsite())
                .industry(company.getIndustry())
                .description(company.getDescription())
                .isVerified(company.isVerified())
                .createdAt(company.getCreatedAt())
                .updatedAt(company.getUpdatedAt())
                .build();
    }
}
```

**3. Company Search Service with Redis Caching (service/CompanySearchService.java)**

```java
package ch.batbern.company.service;

import ch.batbern.company.dto.CompanySearchResponse;
import ch.batbern.company.repository.CompanyRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Duration;
import java.util.List;
import java.util.stream.Collectors;

@Service
@Transactional(readOnly = true)
@RequiredArgsConstructor
@Slf4j
public class CompanySearchService {

    private final CompanyRepository companyRepository;
    private final RedisTemplate<String, Object> redisTemplate;

    private static final String CACHE_KEY_PREFIX = "company:search:";
    private static final Duration CACHE_TTL = Duration.ofMinutes(15);

    public List<CompanySearchResponse> searchCompanies(String query) {
        log.debug("Searching companies with query: {}", query);

        String cacheKey = CACHE_KEY_PREFIX + query.toLowerCase();

        // Try to get from cache
        @SuppressWarnings("unchecked")
        List<CompanySearchResponse> cachedResults =
            (List<CompanySearchResponse>) redisTemplate.opsForValue().get(cacheKey);

        if (cachedResults != null) {
            log.debug("Returning cached results for query: {}", query);
            return cachedResults;
        }

        // Query database
        List<CompanySearchResponse> results = companyRepository
                .findByNameContainingIgnoreCase(query)
                .stream()
                .map(company -> CompanySearchResponse.builder()
                        .id(company.getId())
                        .name(company.getName())
                        .displayName(company.getDisplayName())
                        .isPartner(company.isPartner())
                        .industry(company.getIndustry())
                        .build())
                .limit(20) // Limit autocomplete results
                .collect(Collectors.toList());

        // Cache results
        redisTemplate.opsForValue().set(cacheKey, results, CACHE_TTL);

        log.debug("Cached {} results for query: {}", results.size(), query);
        return results;
    }

    public void invalidateCache() {
        log.info("Invalidating company search cache");
        redisTemplate.keys(CACHE_KEY_PREFIX + "*").forEach(redisTemplate::delete);
    }
}
```

**4. Company REST Controller (controller/CompanyController.java)**

```java
package ch.batbern.company.controller;

import ch.batbern.company.dto.*;
import ch.batbern.company.service.CompanyService;
import ch.batbern.company.service.CompanySearchService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.UUID;

@RestController
@RequestMapping("/api/v1/companies")
@RequiredArgsConstructor
@Slf4j
@Tag(name = "Company Management", description = "Company management operations")
@SecurityRequirement(name = "bearerAuth")
public class CompanyController {

    private final CompanyService companyService;
    private final CompanySearchService searchService;

    @PostMapping
    @PreAuthorize("hasAnyRole('ORGANIZER', 'SPEAKER', 'PARTNER')")
    @Operation(summary = "Create a new company")
    public ResponseEntity<CompanyResponse> createCompany(
            @Valid @RequestBody CreateCompanyRequest request) {
        CompanyResponse response = companyService.createCompany(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }

    @GetMapping("/{id}")
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "Get company by ID")
    public ResponseEntity<CompanyResponse> getCompany(@PathVariable UUID id) {
        CompanyResponse response = companyService.getCompanyById(id);
        return ResponseEntity.ok(response);
    }

    @GetMapping
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "List all companies")
    public ResponseEntity<List<CompanyResponse>> getAllCompanies() {
        List<CompanyResponse> companies = companyService.getAllCompanies();
        return ResponseEntity.ok(companies);
    }

    @GetMapping("/search")
    @PreAuthorize("isAuthenticated()")
    @Operation(summary = "Search companies with autocomplete")
    public ResponseEntity<List<CompanySearchResponse>> searchCompanies(
            @RequestParam String query) {
        List<CompanySearchResponse> results = searchService.searchCompanies(query);
        return ResponseEntity.ok(results);
    }

    @PutMapping("/{id}")
    @PreAuthorize("hasRole('ORGANIZER')")
    @Operation(summary = "Update company")
    public ResponseEntity<CompanyResponse> updateCompany(
            @PathVariable UUID id,
            @Valid @RequestBody UpdateCompanyRequest request) {
        CompanyResponse response = companyService.updateCompany(id, request);
        return ResponseEntity.ok(response);
    }

    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ORGANIZER')")
    @Operation(summary = "Delete company")
    public ResponseEntity<Void> deleteCompany(@PathVariable UUID id) {
        companyService.deleteCompany(id);
        return ResponseEntity.noContent().build();
    }
}
```

**5. Database Migrations**

`V1__create_companies_table.sql`:
```sql
CREATE TABLE companies (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    display_name VARCHAR(255),
    is_partner BOOLEAN NOT NULL DEFAULT FALSE,
    swiss_uid VARCHAR(20),
    website VARCHAR(500),
    industry VARCHAR(100),
    description TEXT,
    is_verified BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL,
    created_by VARCHAR(255) NOT NULL
);

CREATE INDEX idx_company_name ON companies(name);
CREATE INDEX idx_company_uid ON companies(swiss_uid);
CREATE INDEX idx_company_partner ON companies(is_partner);
```

### API Contracts

**OpenAPI Specification Excerpt:**

```yaml
paths:
  /api/v1/companies:
    post:
      tags: [Company Management]
      summary: Create a new company
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCompanyRequest'
      responses:
        '201':
          description: Company created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompanyResponse'
        '400':
          description: Validation error
        '409':
          description: Company already exists

components:
  schemas:
    CreateCompanyRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 255
        displayName:
          type: string
          maxLength: 255
        swissUID:
          type: string
          pattern: '^CHE-\d{3}\.\d{3}\.\d{3}$'
        website:
          type: string
          format: uri
        industry:
          type: string
          maxLength: 100
        description:
          type: string
          maxLength: 2000

    CompanyResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        displayName:
          type: string
        isPartner:
          type: boolean
        swissUID:
          type: string
        website:
          type: string
        industry:
          type: string
        description:
          type: string
        isVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
```

### Testing Requirements

**Unit Test Coverage: >90%**
- Domain model validation logic
- Service layer business rules
- Exception handling scenarios

**Integration Test Coverage: >85%**
- REST API endpoints
- Database operations
- Redis caching behavior
- EventBridge event publishing

**E2E Test Coverage:**
- Complete company creation workflow
- Company search with caching verification

**Performance Requirements:**
- Company creation: <200ms (P95)
- Company search: <100ms with cache, <500ms without cache (P95)
- Database queries: <50ms (P95)

## Definition of Done Checklist

### Development Complete
- [ ] All tests written BEFORE implementation (TDD followed)
- [ ] All acceptance criteria have corresponding tests
- [ ] All acceptance criteria implemented
- [ ] Unit tests written and passing (>90% coverage)
- [ ] Integration tests cover new functionality (>85% coverage)
- [ ] E2E tests pass for company management workflows
- [ ] Code follows project conventions
- [ ] Domain model properly implemented with DDD patterns
- [ ] API documentation generated with OpenAPI
- [ ] Database migrations created and tested

### Infrastructure Complete ⚠️ CRITICAL
- [ ] CDK stack for Company Management Service deployed
- [ ] ECS Fargate service configured with auto-scaling
- [ ] RDS PostgreSQL database provisioned
- [ ] ElastiCache Redis cluster operational
- [ ] S3 bucket created for company logos with CloudFront
- [ ] EventBridge rules configured for domain events
- [ ] API Gateway routes deployed and tested
- [ ] CloudWatch alarms and dashboards configured
- [ ] IAM permissions validated (principle of least privilege)

### Operational Complete
- [ ] Company CRUD operations working end-to-end
- [ ] Company search with autocomplete functional
- [ ] Redis caching improves search performance by >50%
- [ ] Swiss UID validation integrated and tested
- [ ] Domain events published to EventBridge
- [ ] S3 logo upload with presigned URLs working
- [ ] Partner status management functional
- [ ] Integration tests verify all workflows

### Review Ready
- [ ] PR created with detailed description
- [ ] Code review completed by team
- [ ] Infrastructure review completed
- [ ] Security review passed
- [ ] Documentation updated (README, API docs)
- [ ] CLAUDE.md updated if needed
- [ ] Deployment instructions documented

### Docker Compose Integration
- [ ] Dockerfile.dev created for hot reload
- [ ] Service added to docker-compose.yml
- [ ] Environment variables documented in .env.example
- [ ] Local development environment tested

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 2.0 | Added 10 new ACs (13-22) for API consolidation from Stories 1.15a.6/1.15a.2, added advanced query patterns, resource expansion, and 8 additional endpoints. Added Tasks 14-15. User management extracted to Story 1.14-2. | Claude (Dev Agent) |
| 2025-10-02 | 1.0 | Initial story creation for Company Management Service Foundation | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent during implementation_

### Implementation Approach
_To be documented by dev agent with actual approach taken_

### Debug Log References
_To be populated with debug log references during development_

### Completion Notes
_To be filled with issues encountered and resolutions_

### Files Changed
_To be populated with list of created, modified, and deleted files_

### Deployment Notes
_Special deployment considerations for Company Management Service setup_

## QA Results
_To be populated by QA Agent after implementation review_
